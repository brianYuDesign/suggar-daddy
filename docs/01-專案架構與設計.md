# Sugar Daddy 專案架構與設計

結合 Tinder（配對交友）與 OnlyFans（訂閱 Sugar Baby）的平台後端。**目標規模：** 10 萬同時在線用戶。

---

## 技術棧

| 類別 | 技術 |
|------|------|
| 架構 | Nx Monorepo + 微服務 |
| 框架 | NestJS (TypeScript) |
| 主資料庫 | PostgreSQL (讀寫分離 + Sharding) |
| 快取 | Redis Cluster |
| 訊息佇列 | Kafka |
| 檔案儲存 | Cloudinary / AWS S3 |
| 金流 | Stripe Connect |
| 容器 | Docker + Kubernetes |

---

## 微服務架構

```
API Gateway
     │
├─ Auth Service    ├─ User Service    ├─ Matching Service
├─ Subscription    ├─ Content Service ├─ Payment Service
├─ Media Service   ├─ Messaging       └─ Notification
     │
     ├──► Redis (讀取/快取)    └──► Kafka (寫入/事件)
                                    │
                                    └──► DB Writer ──► PostgreSQL
```

### 資料流原則（重要）

- **用戶 API 不直連 DB**：讀取來自 Redis，寫入經 Kafka 發送事件
- **DB Writer** 消費 Kafka 後寫入 PostgreSQL
- 詳見 [04-運維與效能.md](./04-運維與效能.md)

---

## 服務職責摘要

| 服務 | 主要職責 |
|------|----------|
| Auth | JWT 認證、註冊登入、Refresh Token |
| User | 用戶資料、個人頁面 |
| Matching | 滑動、推薦卡片、配對 |
| Subscription | 訂閱方案、訂閱管理 |
| Content | 貼文、讚、留言、PPV |
| Payment | 交易、打賞、貼文購買 |
| Media | 檔案上傳（Cloudinary） |
| Messaging | 對話與訊息 |
| Notification | 推播通知 |

---

## Phase 完成度

### Phase 1 配對系統 ✅
- Nx Monorepo、Common libs、User/Auth/Matching/Notification/Messaging
- 資料流已對齊：Redis 讀、Kafka 寫、DB Writer 消費
- 待補：OAuth、WebSocket、真實推播 FCM/APNs、卡片推薦接地理位置

### Phase 2 訂閱系統 ✅
- Subscription、Content、Payment、Media 四服務已實作

### Phase 3 優化 ✅
- 讀寫分離、Sharding 基礎、效能調優文件
- 待補：監控告警

---

## 業務邏輯檢核摘要

各服務 JWT 與所有權驗證、冪等處理（PPV 購買、Stripe Webhook）、訂閱支付完成延長週期等均已實作 ✅。詳見 [02-開發指南.md](./02-開發指南.md)。
