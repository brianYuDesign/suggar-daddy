# 風險管理計劃

**最後更新**：2026-02-14  
**負責人**：Tech Lead  
**Sprint**：2026-02 W3

---

## 📋 目錄

1. [風險管理流程](#風險管理流程)
2. [高風險項目](#高風險項目)
3. [中風險項目](#中風險項目)
4. [低風險項目](#低風險項目)
5. [風險監控](#風險監控)
6. [應急預案](#應急預案)
7. [風險歷史記錄](#風險歷史記錄)

---

## 風險管理流程

### 風險識別

每日站會時，所有 agents 需報告：
1. 當前遇到的問題
2. 預見的潛在風險
3. 需要的支援

### 風險評估矩陣

| 機率 \ 影響 | 低 | 中 | 高 |
|-------------|----|----|-----|
| **高** | 🟡 中風險 | 🔴 高風險 | 🔴 高風險 |
| **中** | 🟢 低風險 | 🟡 中風險 | 🔴 高風險 |
| **低** | 🟢 低風險 | 🟢 低風險 | 🟡 中風險 |

### 風險處理策略

1. **迴避 (Avoid)**：改變計劃以消除風險
2. **減輕 (Mitigate)**：降低風險發生機率或影響
3. **轉移 (Transfer)**：將風險轉移給第三方
4. **接受 (Accept)**：接受風險並準備應對

---

## 高風險項目

### R-001: PostgreSQL HA 遷移失敗 🔴

**識別日期**：2026-02-14  
**負責人**：DevOps Engineer #2  
**風險類型**：技術風險

#### 風險描述

PostgreSQL 從單機模式遷移到主從複製架構時，可能因為：
- 數據同步失敗
- 配置錯誤
- 應用層連接問題
- 複製延遲過高

導致整個系統不可用。

#### 影響評估

- **影響範圍**：全系統（所有微服務依賴資料庫）
- **影響程度**：🔴 致命（Complete Outage）
- **發生機率**：🟡 中等（30%）
- **風險等級**：🔴 **高風險**

#### 緩解措施

**執行前**：
1. ✅ 完整數據備份（pg_dump + basebackup）
2. ✅ 在測試環境完整驗證遷移流程
3. ✅ 準備詳細的遷移腳本和檢查清單
4. ✅ 選擇低流量時段（週五 22:00 - 週六 06:00）
5. ✅ 提前 24 小時通知團隊和用戶

**執行中**：
1. 逐步遷移，每個步驟驗證後再進行下一步
2. 實時監控以下指標：
   - 複製延遲（target: < 1 秒）
   - 錯誤率
   - API 響應時間
   - 連接數
3. 設置自動告警（延遲 > 5 秒、錯誤率 > 1%）

**執行後**：
1. 驗證數據一致性（抽樣檢查關鍵資料表）
2. 執行完整的健康檢查
3. 保留舊 Master 容器 24 小時（方便快速回滾）

#### 應急計劃

**如果遷移失敗**：

```bash
# Step 1: 立即停止新架構（< 2 分鐘）
docker-compose stop postgres-master postgres-replica

# Step 2: 啟動原有的單機 PostgreSQL（< 1 分鐘）
docker-compose up -d postgres-old

# Step 3: 恢復最新備份（如果數據損壞）
docker exec postgres-old psql -U postgres -d suggar_daddy < backup.sql

# Step 4: 重啟所有微服務，重新連接資料庫（< 2 分鐘）
docker-compose restart auth-service user-service # ... 其他服務

# Step 5: 驗證系統恢復（< 1 分鐘）
curl http://localhost:3000/health
```

**預計回滾時間**：< 5 分鐘

#### 聯絡資訊

- **主要負責人**：DevOps Engineer #2
- **備援負責人**：Tech Lead
- **升級路徑**：Tech Lead → CTO

---

### R-002: Redis Sentinel 切換導致快取失效 🔴

**識別日期**：2026-02-14  
**負責人**：DevOps Engineer #3  
**風險類型**：技術風險

#### 風險描述

Redis Sentinel 故障轉移時，可能導致：
- 快取全部失效（Cache Miss Storm）
- 資料庫負載激增
- API 響應時間大幅增加
- 部分請求超時或失敗

#### 影響評估

- **影響範圍**：全系統（所有服務依賴 Redis）
- **影響程度**：🟡 嚴重（Performance Degradation）
- **發生機率**：🔴 高（60%）
- **風險等級**：🔴 **高風險**

#### 緩解措施

**架構層面**：
1. ✅ 配置 Redis 持久化（AOF + RDB）
2. ✅ 使用 Sentinel 自動故障轉移（< 30 秒）
3. ✅ 應用層實現 ioredis Sentinel 客戶端（自動重連）

**數據層面**：
1. 快取預熱腳本準備
   - 熱門用戶資料
   - 熱門貼文
   - 活躍對話
2. 增加資料庫連線池大小（50 → 100）
3. 啟用資料庫查詢緩存

**監控層面**：
1. 實時監控以下指標：
   - Redis 連接數
   - Cache Hit Rate
   - 資料庫 QPS
   - API P95/P99 延遲
2. 設置告警閾值：
   - Cache Hit Rate < 80%
   - DB QPS > 1000
   - API P95 > 500ms

#### 應急計劃

**如果發生 Cache Miss Storm**：

```bash
# Step 1: 立即啟用 Rate Limiting（< 30 秒）
# 在 API Gateway 降低請求限制
curl -X POST http://localhost:3000/_admin/rate-limit \
  -d '{"global": 50, "perUser": 5}'

# Step 2: 執行快取預熱腳本（2-5 分鐘）
npm run cache:warmup

# Step 3: 監控資料庫負載
docker exec postgres top -n 1

# Step 4: 如果資料庫過載，啟用緊急降級
# - 關閉非關鍵功能（推薦用戶、統計數據）
# - 簡化查詢（移除複雜 JOIN）

# Step 5: 逐步恢復正常流量限制
curl -X POST http://localhost:3000/_admin/rate-limit \
  -d '{"global": 100, "perUser": 10}'
```

**預計恢復時間**：5-10 分鐘

---

### R-003: DevOps 資源過載 🟡

**識別日期**：2026-02-14  
**負責人**：Tech Lead  
**風險類型**：資源風險

#### 風險描述

DevOps team 需要同時處理 4 個 P0 任務：
- P0-004：監控系統（40h）
- P0-002：PostgreSQL HA（40h）
- P0-003：Redis Sentinel（24h）
- P0-001：Jaeger 追蹤（40h）

總計 144 工時，但只有 1 週時間（約 40 工時/人 × 4 人 = 160 工時可用）。

#### 影響評估

- **影響範圍**：本 Sprint 所有 P0 任務
- **影響程度**：🟡 中等（部分任務延期）
- **發生機率**：🔴 高（80%）
- **風險等級**：🟡 **中風險**

#### 緩解措施

**優先級調整**：
1. **必須完成**（關鍵路徑）：
   - P0-004：監控系統（優先級 #1）
   - P0-002：PostgreSQL HA（優先級 #2）
   - P0-003：Redis Sentinel（優先級 #3）

2. **可延後**：
   - P0-001：Jaeger 追蹤（延至 Week 4）
   - 理由：Jaeger 依賴監控系統，可在監控上線後再做

**並行策略**：
- P0-004 和 P0-002 可以並行（不同 DevOps）
- P0-003 在 P0-002 完成後執行（避免同時變更兩個關鍵組件）

**外部支援**：
- 如需要，請求 Backend Developer 協助應用層整合
- Solution Architect 提供架構諮詢

#### 應急計劃

**如果本週無法完成所有任務**：

1. **優先保證 P0-004 完成**（監控系統是其他任務的基礎）
2. **P0-002 和 P0-003 可分兩週執行**：
   - Week 3：P0-002（PostgreSQL）
   - Week 4：P0-003（Redis）+ P0-001（Jaeger）
3. **調整下週計劃**，延後 P1 任務

---

## 中風險項目

### R-004: 測試環境不穩定 🟡

**識別日期**：2026-02-14  
**負責人**：QA Engineer  
**風險類型**：環境風險

#### 風險描述

E2E 測試環境可能因為以下原因不穩定：
- 測試數據污染（前一次測試未清理）
- 服務啟動順序問題
- 網路延遲導致超時
- 並發測試互相干擾

當前 E2E 測試通過率 91%（21 個失敗），部分可能是測試環境問題。

#### 影響評估

- **影響範圍**：E2E 測試、前端測試
- **影響程度**：🟡 中等（影響測試可信度）
- **發生機率**：🟡 中等（50%）
- **風險等級**：🟡 **中風險**

#### 緩解措施

1. **測試隔離**：
   - 每個測試使用獨立的測試數據
   - 測試後自動清理（afterEach）
   - 使用唯一 ID（UUID）避免衝突

2. **環境穩定性**：
   - 測試前確保所有服務健康（health check）
   - 增加合理的等待時間（避免 flaky tests）
   - 使用 Docker Compose 保證服務啟動順序

3. **監控**：
   - 記錄每次測試執行時間
   - 識別經常失敗的測試（flaky tests）
   - 分析失敗原因（環境 vs 代碼 bug）

---

### R-005: 前端測試撰寫時間超出預期 🟡

**識別日期**：2026-02-14  
**負責人**：Frontend Developer  
**風險類型**：時間風險

#### 風險描述

前端測試覆蓋率提升是一個長期任務（8 週，80 工時）。

本週目標：
- Web：30% → 50%（+20%）
- Admin：40% → 55%（+15%）

但實際撰寫測試的時間可能超出預期，尤其是：
- 複雜元件（如配對卡片）
- 整合測試（API mock）
- 非同步邏輯測試

#### 影響評估

- **影響範圍**：前端測試覆蓋率目標
- **影響程度**：🟢 低（不影響核心功能）
- **發生機率**：🔴 高（70%）
- **風險等級**：🟡 **中風險**

#### 緩解措施

1. **接受長期計劃**：
   - 測試覆蓋率提升本就是 8 週計劃
   - 本週只是第一週，達到 40-45% 也可接受

2. **優先級排序**：
   - 優先測試關鍵流程（登入、註冊、配對）
   - 其次測試共用元件
   - 最後測試邊緣案例

3. **工具和模板**：
   - 創建測試模板（減少重複工作）
   - 使用 Test Utils 簡化測試撰寫
   - 複用 Mock Data Fixtures

---

## 低風險項目

### R-006: Jaeger 追蹤增加性能開銷 🟢

**識別日期**：2026-02-14  
**負責人**：DevOps Engineer #4  
**風險類型**：性能風險

#### 風險描述

OpenTelemetry 追蹤會增加約 5% 的性能開銷（延遲和 CPU 使用率）。

#### 影響評估

- **影響範圍**：所有微服務
- **影響程度**：🟢 低（5% 開銷可接受）
- **發生機率**：🔴 高（100%，必然發生）
- **風險等級**：🟢 **低風險**

#### 緩解措施

1. **配置優化**：
   - 使用取樣策略（只追蹤 10% 請求）
   - 關閉不必要的 instrumentation
   - 使用批次發送（減少網路開銷）

2. **監控**：
   - 監控追蹤前後的性能指標
   - 如果影響 > 10%，調整取樣率

3. **分階段部署**：
   - 先在非關鍵服務測試
   - 確認性能影響可接受後再推廣

---

## 風險監控

### 每日檢查清單

Tech Lead 每日檢查以下項目：

- [ ] **R-001 (PostgreSQL)**：遷移計劃是否按時推進？
- [ ] **R-002 (Redis)**：Sentinel 配置是否完成測試？
- [ ] **R-003 (資源)**：DevOps 是否過載？是否需要調整計劃？
- [ ] **R-004 (測試環境)**：E2E 通過率是否改善？
- [ ] **R-005 (前端測試)**：測試撰寫進度是否符合預期？
- [ ] **R-006 (Jaeger)**：性能影響是否在可接受範圍？

### 每週風險報告

每週五 Sprint Review 時，Tech Lead 需報告：

1. **已解決的風險**
2. **新識別的風險**
3. **風險等級變化**（升級或降級）
4. **應急預案執行記錄**

---

## 應急預案

### 緊急聯絡流程

```
問題發生
    ↓
立即在 Slack #tech-debt-payoff 通知 @tech-lead
    ↓
Tech Lead 評估嚴重程度
    ↓
    ├─ 🟢 低影響：記錄問題，正常流程處理
    ├─ 🟡 中影響：召集相關 agents 緊急會議（15 分鐘內）
    └─ 🔴 高影響：立即執行應急預案 + 升級給 CTO
```

### 緊急降級開關

如果系統整體不穩定，可啟用緊急降級：

```bash
# 關閉非關鍵功能
curl -X POST http://localhost:3000/_admin/feature-flags \
  -d '{
    "recommendations": false,
    "notifications": false,
    "analytics": false
  }'

# 簡化查詢（移除複雜計算）
curl -X POST http://localhost:3000/_admin/query-mode \
  -d '{"mode": "simple"}'

# 啟用緊急 Rate Limiting
curl -X POST http://localhost:3000/_admin/rate-limit \
  -d '{"global": 20, "perUser": 2}'
```

---

## 風險歷史記錄

### 2026-02-14（Week 3 Day 1）

**新識別風險**：
- R-001：PostgreSQL HA 遷移失敗（🔴 高風險）
- R-002：Redis Sentinel 切換快取失效（🔴 高風險）
- R-003：DevOps 資源過載（🟡 中風險）
- R-004：測試環境不穩定（🟡 中風險）
- R-005：前端測試時間超出預期（🟡 中風險）
- R-006：Jaeger 性能開銷（🟢 低風險）

**已實施措施**：
- R-001：準備完整的遷移腳本和回滾計劃
- R-002：準備快取預熱腳本
- R-003：調整優先級，P0-001 延至下週

---

## 附錄

### A. 風險評分公式

```
風險分數 = 發生機率 × 影響程度

發生機率：
- 高：3
- 中：2
- 低：1

影響程度：
- 高：3
- 中：2
- 低：1

風險等級：
- 高風險：6-9 分
- 中風險：3-4 分
- 低風險：1-2 分
```

### B. 參考文檔

- [Sprint 計劃 W3](./SPRINT_2026_FEB_W3.md)
- [運維指南](./OPERATIONS-GUIDE.md)
- [技術債務追蹤](./TECHNICAL-DEBT.md)
- [執行總結](./EXECUTION-SUMMARY-2026-02.md)

---

**文檔結束**

*風險管理是專案成功的關鍵。讓我們主動識別和應對風險！* 🛡️
