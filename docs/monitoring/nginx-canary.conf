user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # Prometheus metrics 日誌格式
    log_format prometheus_metrics '$remote_addr - $remote_user [$time_local] '
                                 '"$request" $status $body_bytes_sent '
                                 '"$http_referer" "$http_user_agent" '
                                 'rt=$request_time uct="$upstream_connect_time" '
                                 'uht="$upstream_header_time" urt="$upstream_response_time" '
                                 'deployment=$deployment';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 20M;

    # Gzip 壓縮
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml application/atom+xml image/svg+xml;

    # upstream 定義：Stable 版本
    upstream stable_backend {
        least_conn;
        
        server stable-service-1:3000 max_fails=3 fail_timeout=30s;
        server stable-service-2:3000 max_fails=3 fail_timeout=30s;
        server stable-service-3:3000 max_fails=3 fail_timeout=30s;
        
        keepalive 32;
    }

    # upstream 定義：Canary 版本
    upstream canary_backend {
        least_conn;
        
        server canary-service-1:3000 max_fails=3 fail_timeout=30s;
        server canary-service-2:3000 max_fails=3 fail_timeout=30s;
        
        keepalive 32;
    }

    # 監控上游服務健康狀態
    upstream monitoring {
        server prometheus:9090;
        server grafana:3000;
        keepalive 32;
    }

    # ============================================
    # 灰度部署主服務配置
    # ============================================
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;

        # 健康檢查端點
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Prometheus metrics endpoint
        location /nginx_metrics {
            access_log off;
            stub_status on;
        }

        # 用於驗證流量分配的測試端點
        location /canary-test {
            access_log /var/log/nginx/canary-test.log prometheus_metrics;
            
            if ($canary_traffic = "true") {
                set $deployment "canary";
            }
            if ($canary_traffic = "false") {
                set $deployment "stable";
            }

            proxy_pass http://$backend_service;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Deployment $deployment;
        }

        # 主 API 路由 - 灰度部署流量分配
        location ~ ^/api/v1/(.*) {
            access_log /var/log/nginx/api-access.log prometheus_metrics;

            # 流量分配邏輯
            set $backend_service "stable_backend";
            set $deployment "stable";
            set $canary_traffic "false";

            # ============================================
            # 流量分配策略
            # ============================================

            # 策略 1: Header-based routing (測試用戶優先走 Canary)
            if ($http_x_canary_user = "true") {
                set $backend_service "canary_backend";
                set $deployment "canary";
                set $canary_traffic "true";
            }

            # 策略 2: Cookie-based routing (Cookie 中指定 canary=true)
            if ($cookie_canary = "true") {
                set $backend_service "canary_backend";
                set $deployment "canary";
                set $canary_traffic "true";
            }

            # 策略 3: 基於客戶端 IP 白名單
            # Canary QA 團隊的 IP 白名單
            set $canary_by_ip "false";
            if ($remote_addr ~ "^(192.168.1.100|192.168.1.101|10.0.0.50|10.0.0.51)$") {
                set $canary_by_ip "true";
            }
            if ($canary_by_ip = "true") {
                set $backend_service "canary_backend";
                set $deployment "canary";
                set $canary_traffic "true";
            }

            # 策略 4: 百分比流量分配 (金絲雀百分比由環境變數控制)
            # CANARY_TRAFFIC_PERCENT (default: 5)
            # 使用時間戳和客戶端 IP 的雜湊值確定客戶端是否進入 Canary
            set $canary_by_hash "false";
            
            # 簡單的雜湊演算法：基於客戶端 IP 的最後一位
            if ($remote_addr ~ "([0-9]+)$") {
                set $client_ip_last_digit $1;
            }
            
            # 5% 流量分配演算法 (0-4 走 Canary, 95-99 走 Canary)
            # 對應約 5% 的客戶端
            if ($client_ip_last_digit ~ "^[04]$") {
                set $canary_by_hash "true";
            }

            if ($canary_by_hash = "true") {
                set $backend_service "canary_backend";
                set $deployment "canary";
                set $canary_traffic "true";
            }

            # ============================================
            # 代理請求到後端
            # ============================================

            proxy_pass http://$backend_service;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # 標準 HTTP 頭
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $server_name;
            
            # 灰度部署相關頭
            proxy_set_header X-Deployment $deployment;
            proxy_set_header X-Canary-Traffic $canary_traffic;
            
            # 傳遞原始請求頭（如果有）
            proxy_set_header X-Canary-User $http_x_canary_user;

            # 超時設定
            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
            
            # 緩衝設定
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;

            # 錯誤處理
            proxy_next_upstream error timeout http_500 http_502 http_503;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 5s;
        }

        # 推薦服務專用路由
        location ~ ^/recommendations/(.*) {
            access_log /var/log/nginx/recommendations-access.log prometheus_metrics;

            set $backend_service "stable_backend";
            set $deployment "stable";

            # 金絲雀測試用戶可指定走 Canary
            if ($http_x_canary_user = "true") {
                set $backend_service "canary_backend";
                set $deployment "canary";
            }

            proxy_pass http://$backend_service;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Deployment $deployment;

            proxy_connect_timeout 5s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
        }

        # 靜態資源 - 直接服務（不涉及灰度）
        location ~ ^/(images|static|assets)/ {
            access_log off;
            expires 1d;
            add_header Cache-Control "public, immutable";
            alias /usr/share/nginx/html;
        }

        # 監控儀表板代理
        location /monitoring/ {
            proxy_pass http://monitoring;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 404 處理
        error_page 404 /404.html;
        location = /40x.html {
            internal;
        }

        # 500 錯誤頁面
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            internal;
        }
    }

    # ============================================
    # 監控和自動故障檢測配置
    # ============================================

    # 上游健康檢查 (需要 nginx_http_upstream_module)
    match backend_health {
        status 200 201 204;
        body ~ "ok";
    }

    # Stable 服務健康檢查
    server {
        listen 127.0.0.1:8080;
        location /health/stable {
            access_log off;
            proxy_pass http://stable_backend/health;
        }
    }

    # Canary 服務健康檢查
    server {
        listen 127.0.0.1:8081;
        location /health/canary {
            access_log off;
            proxy_pass http://canary_backend/health;
        }
    }

    # 動態配置重新加載（通過信號）
    # 支援在執行時修改金絲雀百分比：
    # kill -HUP $(cat /var/run/nginx.pid)

}
