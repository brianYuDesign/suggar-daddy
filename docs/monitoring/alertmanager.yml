global:
  resolve_timeout: 5m
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

# è¨­ç½®å‘Šè­¦æ¨¡æ¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# è·¯ç”±é…ç½®
route:
  receiver: 'default'
  group_by: ['alertname', 'cluster', 'service', 'instance']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 24h

  # å­è·¯ç”±
  routes:
    # Critical alerts
    - match:
        severity: critical
      receiver: 'critical'
      group_wait: 1s
      repeat_interval: 1h

    # Warning alerts
    - match:
        severity: warning
      receiver: 'default'
      group_wait: 10s
      repeat_interval: 4h

    # API alerts
    - match:
        service: api
      receiver: 'api-team'
      group_wait: 5s

    # Database alerts
    - match:
        service: postgres
      receiver: 'db-team'
      group_wait: 5s

    # Redis alerts
    - match:
        service: redis
      receiver: 'cache-team'
      group_wait: 5s

    # Infrastructure alerts
    - match:
        service: infrastructure
      receiver: 'infra-team'
      group_wait: 1s

# å‘Šè­¦æ¥æ”¶è€…
receivers:
  # é»˜èªæ¥æ”¶è€…
  - name: 'default'
    slack_configs:
      - channel: '#alerts'
        title: 'Alert: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

  # Critical å‘Šè­¦ (ç·Šæ€¥)
  - name: 'critical'
    slack_configs:
      - channel: '#critical-alerts'
        title: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        description: '{{ .GroupLabels.alertname }}'

  # API Team
  - name: 'api-team'
    slack_configs:
      - channel: '#api-alerts'
        title: 'API Alert: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

  # Database Team
  - name: 'db-team'
    slack_configs:
      - channel: '#db-alerts'
        title: 'Database Alert: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

  # Cache Team
  - name: 'cache-team'
    slack_configs:
      - channel: '#cache-alerts'
        title: 'Redis Alert: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

  # Infrastructure Team
  - name: 'infra-team'
    slack_configs:
      - channel: '#infra-alerts'
        title: 'Infrastructure Alert: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

# æŠ‘åˆ¶è¦å‰‡
inhibit_rules:
  # å¦‚æœ critical å‘Šè­¦å·²è§¸ç™¼ï¼Œå‰‡æŠ‘åˆ¶ç›¸é—œçš„ warning å‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'dev', 'instance']

  # å¦‚æœæœå‹™å·²å®•æ©Ÿï¼Œå‰‡æŠ‘åˆ¶è©²æœå‹™çš„æ€§èƒ½å‘Šè­¦
  - source_match:
      alertname: 'ApplicationDown'
    target_match_re:
      alertname: 'High.*|Low.*'
    equal: ['instance', 'job']
