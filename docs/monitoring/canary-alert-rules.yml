groups:
  # 灰度部署特定告警
  - name: canary-deployment-alerts
    interval: 15s
    rules:
      # Canary 錯誤率過高 (>5%)
      - alert: CanaryHighErrorRate
        expr: |
          (rate(http_requests_total{deployment="canary",status=~"5.."}[2m]) / 
           rate(http_requests_total{deployment="canary"}[2m])) > 0.05
        for: 2m
        labels:
          severity: critical
          component: canary-deployment
          auto_rollback: "true"
        annotations:
          summary: "Canary deployment error rate > 5%"
          description: "Canary error rate: {{ $value | humanizePercentage }} on {{ $labels.service }}"
          action: "Triggering automatic rollback"

      # Canary 延遲過高 (>500ms at p95)
      - alert: CanaryHighLatency
        expr: |
          histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{deployment="canary"}[2m])) > 0.5
        for: 2m
        labels:
          severity: critical
          component: canary-deployment
          auto_rollback: "true"
        annotations:
          summary: "Canary deployment P95 latency > 500ms"
          description: "Canary P95 latency: {{ $value }}s on {{ $labels.service }}"
          action: "Triggering automatic rollback"

      # Canary CPU 使用率過高 (>80%)
      - alert: CanaryHighCPU
        expr: |
          rate(process_cpu_seconds_total{deployment="canary"}[2m]) * 100 > 80
        for: 2m
        labels:
          severity: warning
          component: canary-deployment
        annotations:
          summary: "Canary deployment CPU usage > 80%"
          description: "Canary CPU: {{ $value }}% on {{ $labels.instance }}"

      # Canary 記憶體使用率過高 (>85%)
      - alert: CanaryHighMemory
        expr: |
          (process_resident_memory_bytes{deployment="canary"} / 1073741824) * 100 > 85
        for: 2m
        labels:
          severity: warning
          component: canary-deployment
        annotations:
          summary: "Canary deployment memory usage > 85%"
          description: "Canary memory: {{ $value }}% on {{ $labels.instance }}"

      # Canary 實例健康檢查失敗
      - alert: CanaryUnhealthyInstances
        expr: |
          count(up{deployment="canary"} == 0) > 0
        for: 1m
        labels:
          severity: critical
          component: canary-deployment
          auto_rollback: "true"
        annotations:
          summary: "Canary deployment instances are down"
          description: "{{ $value }} canary instance(s) are unhealthy on {{ $labels.service }}"
          action: "Triggering automatic rollback"

      # Stable vs Canary 錯誤率對比 (Canary > Stable + 2%)
      - alert: CanaryErrorRateHigherThanStable
        expr: |
          (rate(http_requests_total{deployment="canary",status=~"5.."}[2m]) / 
           rate(http_requests_total{deployment="canary"}[2m])) > 
          ((rate(http_requests_total{deployment="stable",status=~"5.."}[2m]) / 
           rate(http_requests_total{deployment="stable"}[2m])) + 0.02)
        for: 3m
        labels:
          severity: critical
          component: canary-deployment
          auto_rollback: "true"
        annotations:
          summary: "Canary error rate significantly higher than stable"
          description: "Canary error rate exceeds stable by {{ $value | humanizePercentage }}"
          action: "Triggering automatic rollback"

      # Stable vs Canary 延遲對比 (Canary P95 > Stable P95 + 200ms)
      - alert: CanaryLatencyHigherThanStable
        expr: |
          histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{deployment="canary"}[2m])) > 
          (histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{deployment="stable"}[2m])) + 0.2)
        for: 3m
        labels:
          severity: warning
          component: canary-deployment
        annotations:
          summary: "Canary latency significantly higher than stable"
          description: "Canary P95 latency exceeds stable by {{ $value }}s"

      # Canary 流量分配異常 (預期 5% 但實際 > 10%)
      - alert: CanaryTrafficAllocationAbnormal
        expr: |
          (rate(http_requests_total{deployment="canary"}[2m]) / 
           (rate(http_requests_total{deployment="canary"}[2m]) + rate(http_requests_total{deployment="stable"}[2m]))) > 0.1
        for: 2m
        labels:
          severity: warning
          component: canary-deployment
        annotations:
          summary: "Canary traffic allocation higher than expected"
          description: "Canary receiving {{ $value | humanizePercentage }} of traffic (expected ~5%)"

      # Canary 部署進度異常
      - alert: CanaryDeploymentStuck
        expr: |
          (increase(http_requests_total{deployment="canary"}[5m]) == 0) and 
          (up{deployment="canary"} == 1)
        for: 5m
        labels:
          severity: warning
          component: canary-deployment
        annotations:
          summary: "Canary deployment is not receiving traffic"
          description: "Canary instances are healthy but no requests are being received"

  # 流量分配監控
  - name: canary-traffic-monitoring
    interval: 15s
    rules:
      # 記錄 Canary vs Stable 流量比例
      - record: canary:traffic_ratio
        expr: |
          rate(http_requests_total{deployment="canary"}[1m]) / 
          (rate(http_requests_total{deployment="canary"}[1m]) + rate(http_requests_total{deployment="stable"}[1m]))

      # 記錄 Canary vs Stable 錯誤率
      - record: canary:error_rate_canary
        expr: |
          rate(http_requests_total{deployment="canary",status=~"5.."}[1m]) / 
          rate(http_requests_total{deployment="canary"}[1m])

      - record: canary:error_rate_stable
        expr: |
          rate(http_requests_total{deployment="stable",status=~"5.."}[1m]) / 
          rate(http_requests_total{deployment="stable"}[1m])

      # 記錄 Canary vs Stable 延遲 P95
      - record: canary:latency_p95_canary
        expr: |
          histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{deployment="canary"}[1m]))

      - record: canary:latency_p95_stable
        expr: |
          histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{deployment="stable"}[1m]))

      # 記錄 Canary vs Stable 延遲 P99
      - record: canary:latency_p99_canary
        expr: |
          histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{deployment="canary"}[1m]))

      - record: canary:latency_p99_stable
        expr: |
          histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{deployment="stable"}[1m]))

      # 記錄 Canary vs Stable CPU 使用率
      - record: canary:cpu_usage_canary
        expr: |
          rate(process_cpu_seconds_total{deployment="canary"}[1m]) * 100

      - record: canary:cpu_usage_stable
        expr: |
          rate(process_cpu_seconds_total{deployment="stable"}[1m]) * 100

      # 記錄 Canary vs Stable 記憶體使用率
      - record: canary:memory_usage_canary
        expr: |
          (process_resident_memory_bytes{deployment="canary"} / 1073741824) * 100

      - record: canary:memory_usage_stable
        expr: |
          (process_resident_memory_bytes{deployment="stable"} / 1073741824) * 100

  # 自動回滾觸發規則
  - name: canary-auto-rollback
    interval: 15s
    rules:
      # 回滾觸發條件 1: 錯誤率 > 5%
      - alert: AutoRollbackErrorRateThreshold
        expr: |
          (rate(http_requests_total{deployment="canary",status=~"5.."}[2m]) / 
           rate(http_requests_total{deployment="canary"}[2m])) > 0.05
        for: 2m
        labels:
          severity: critical
          rollback_trigger: "error_rate"
          threshold: "5%"
        annotations:
          summary: "Auto-rollback trigger: Error rate threshold exceeded"
          description: "Canary error rate: {{ $value | humanizePercentage }}"

      # 回滾觸發條件 2: 延遲 > 500ms (P95)
      - alert: AutoRollbackLatencyThreshold
        expr: |
          histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{deployment="canary"}[2m])) > 0.5
        for: 2m
        labels:
          severity: critical
          rollback_trigger: "latency"
          threshold: "500ms"
        annotations:
          summary: "Auto-rollback trigger: Latency threshold exceeded"
          description: "Canary P95 latency: {{ $value }}s"

      # 回滾觸發條件 3: 健康檢查失敗
      - alert: AutoRollbackHealthCheckFailure
        expr: |
          up{deployment="canary"} == 0
        for: 1m
        labels:
          severity: critical
          rollback_trigger: "health_check"
          threshold: "1m"
        annotations:
          summary: "Auto-rollback trigger: Health check failure"
          description: "{{ $value }} canary instance(s) are unhealthy"

      # 回滾觸發條件 4: CPU 過高 (>90% 持續 3m)
      - alert: AutoRollbackCPUThreshold
        expr: |
          (rate(process_cpu_seconds_total{deployment="canary"}[1m]) * 100) > 90
        for: 3m
        labels:
          severity: warning
          rollback_trigger: "cpu_usage"
          threshold: "90%"
        annotations:
          summary: "Auto-rollback trigger: CPU usage threshold exceeded"
          description: "Canary CPU: {{ $value }}%"

  # 灰度部署進度監控
  - name: canary-deployment-progress
    interval: 15s
    rules:
      # Phase 1: 5% 金絲雀
      - alert: CanaryPhase1Started
        expr: |
          (rate(http_requests_total{deployment="canary"}[1m]) / 
           (rate(http_requests_total{deployment="canary"}[1m]) + rate(http_requests_total{deployment="stable"}[1m]))) >= 0.03
        for: 1m
        labels:
          severity: info
          deployment_phase: "phase1"
          expected_traffic: "5%"
        annotations:
          summary: "Canary Phase 1 started (5% traffic)"
          description: "Canary traffic: {{ $value | humanizePercentage }}"

      # Phase 2: 25% 金絲雀
      - alert: CanaryPhase2Started
        expr: |
          (rate(http_requests_total{deployment="canary"}[1m]) / 
           (rate(http_requests_total{deployment="canary"}[1m]) + rate(http_requests_total{deployment="stable"}[1m]))) >= 0.20
        for: 1m
        labels:
          severity: info
          deployment_phase: "phase2"
          expected_traffic: "25%"
        annotations:
          summary: "Canary Phase 2 started (25% traffic)"
          description: "Canary traffic: {{ $value | humanizePercentage }}"

      # Phase 3: 50% 金絲雀
      - alert: CanaryPhase3Started
        expr: |
          (rate(http_requests_total{deployment="canary"}[1m]) / 
           (rate(http_requests_total{deployment="canary"}[1m]) + rate(http_requests_total{deployment="stable"}[1m]))) >= 0.45
        for: 1m
        labels:
          severity: info
          deployment_phase: "phase3"
          expected_traffic: "50%"
        annotations:
          summary: "Canary Phase 3 started (50% traffic)"
          description: "Canary traffic: {{ $value | humanizePercentage }}"

      # Phase 4: 100% 全量
      - alert: CanaryPhase4Completed
        expr: |
          (rate(http_requests_total{deployment="canary"}[1m]) / 
           (rate(http_requests_total{deployment="canary"}[1m]) + rate(http_requests_total{deployment="stable"}[1m]))) >= 0.95
        for: 1m
        labels:
          severity: info
          deployment_phase: "phase4"
          expected_traffic: "100%"
        annotations:
          summary: "Canary deployment completed (100% traffic)"
          description: "Canary traffic: {{ $value | humanizePercentage }}"
