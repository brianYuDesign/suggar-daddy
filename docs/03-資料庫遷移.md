# 資料庫遷移指南

各微服務擁有獨立資料庫與遷移設定，本文件說明如何執行遷移。

---

## 前置需求

- PostgreSQL 已安裝並執行
- 環境變數已設定（可複製 `.env.example` 為 `.env`）

---

## 服務與資料庫對應

| 服務 | 資料庫名稱 | 主要實體 |
|------|------------|----------|
| subscription-service | suggar_daddy_subscription | SubscriptionTier, Subscription |
| content-service | suggar_daddy_content | Post, PostLike, PostComment |
| payment-service | suggar_daddy_payment | Transaction, PostPurchase, Tip |
| media-service | suggar_daddy_media | MediaFile |

---

## 執行步驟

### 1. 建立資料庫

```bash
psql -U postgres
CREATE DATABASE suggar_daddy_subscription;
CREATE DATABASE suggar_daddy_content;
CREATE DATABASE suggar_daddy_payment;
CREATE DATABASE suggar_daddy_media;
\q
```

### 2. 執行遷移

```bash
# 各服務分別執行
cd apps/subscription-service
npx typeorm-ts-node-commonjs migration:run -d ormconfig.ts
```

對 content-service、payment-service、media-service 重複上述步驟。

---

## 常用指令

| 指令 | 說明 |
|------|------|
| `migration:run` | 執行所有待執行遷移 |
| `migration:generate src/migrations/名稱` | 產生新遷移檔 |
| `migration:create src/migrations/名稱` | 建立空白遷移檔 |
| `migration:revert` | 回滾上一個遷移 |
| `migration:show` | 顯示遷移狀態 |

---

## 環境變數

```env
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=your_password
DB_DATABASE=<各服務資料庫名稱>
```

---

## 生產環境注意

- **務必** 將 `synchronize` 設為 `false`
- 上線前在 staging 環境測試遷移
- 執行前備份資料庫
- 盡量保持遷移冪等
