# 專案功能分析

本文件描述目前後端功能現狀與完成度，供開發與對接參考。

---

## 一、專案定位

- **類型**：約會 + 訂閱/內容平台（Tinder × OnlyFans 風格）
- **架構**：Nx Monorepo、NestJS 微服務
- **技術棧**：PostgreSQL、Redis、Kafka、Stripe

---

## 二、微服務與功能概覽

| 服務 | 職責 | 儲存/通訊 | 完成度 |
|------|------|-----------|--------|
| **api-gateway** | 統一入口、依路徑代理至各服務 | 轉發 HTTP + Authorization | ✅ |
| **auth-service** | 註冊、登入、Refresh、登出 | Redis + Kafka user.created | ✅ |
| **user-service** | 個人/公開資料、用戶卡片、推薦用 GET /cards | Redis + Kafka | ✅ |
| **matching-service** | 滑卡、雙向喜歡配對、unmatch、推薦卡片（呼叫 user-service） | Redis + Kafka matching.matched | ✅ |
| **content-service** | 貼文 CRUD、讚/留言、PPV、訂閱牆可見性（subscribers/tier_specific） | Redis + Kafka | ✅ |
| **subscription-service** | 訂閱方案、訂閱建立/查詢/延長/取消、GET /subscriptions/check | Redis + Kafka + Stripe | ✅ |
| **payment-service** | 打賞、PPV、Stripe Webhook、交易查詢 | DB + Redis 冪等 + Kafka | ✅ |
| **messaging-service** | 發送訊息、對話列表、訊息歷史 | **Redis** + Kafka message.created | ✅ |
| **notification-service** | 發送/列表/已讀通知 | **Redis** + Kafka notification.created | ✅ |
| **media-service** | 媒體上傳、建立/刪除紀錄 | Redis + Kafka | ✅ |
| **db-writer-service** | 消費 Kafka 寫入 PostgreSQL 並回寫 Redis | TypeORM + Redis | ✅ |

---

## 三、已實作重點

### 1. API Gateway

- 單一入口（預設 port 3000），依 URL 前綴轉發至各微服務。
- 路徑對照：`/api/v1/auth` → auth、`/api/v1/users` → user、`/api/v1/matching` → matching、`/api/posts` → content、`/api/subscriptions` → subscription、`/api/tips`、`/api/stripe` 等 → payment、`/api/upload`、`/api/media` → media。
- 可透過環境變數覆寫各服務 URL（如 `USER_SERVICE_URL`、`SUBSCRIPTION_SERVICE_URL`）。

### 2. 授權與身分

- JWT（access + refresh）、Content 創作者權限、Subscription tier 創作者/ADMIN、Payment 強制當前用戶、Messaging isParticipant、Notification 僅本人、Media 所有權檢查，均已對齊業務需求（詳見 [BUSINESS_LOGIC_GAPS.md](./BUSINESS_LOGIC_GAPS.md)）。

### 3. Matching 推薦

- `getCards` 改為呼叫 user-service **GET /api/v1/users/cards**（exclude 自己 + 已 swipe），回傳真實用戶卡片，不再使用 mock。

### 4. Messaging / Notification 持久化

- **Messaging**：對話與訊息存 Redis（conversation:*、msg:*、user:*:conversations）；發送訊息時發送 Kafka `message.created`。
- **Notification**：通知存 Redis（notification:*、user:*:notifications）；發送時發送 Kafka `notification.created`。重啟後資料保留。

### 5. 訂閱牆可見性

- **subscribers**：僅對該創作者有有效訂閱的 viewer 可看完整內容。
- **tier_specific**：僅對該創作者且訂閱該 requiredTierId 的 viewer 可看。
- subscription-service 提供 **GET /api/subscriptions/check?subscriberId=&creatorId=&tierId=**；content-service 的 findOneWithAccess、findByCreatorWithAccess 依此過濾。

### 6. 支付與訂閱

- Stripe 訂閱建立/取消、payment.completed 延長週期；PPV / 打賞 PaymentIntent + Webhook；PPV 與 Webhook 冪等（Redis）。

---

## 四、環境變數要點

- **api-gateway**：各服務 URL（如 `AUTH_SERVICE_URL`、`USER_SERVICE_URL`、`SUBSCRIPTION_SERVICE_URL` 等），預設為 localhost 對應 port。
- **matching-service**：`USER_SERVICE_URL`（預設 http://localhost:3001）。
- **content-service**：`SUBSCRIPTION_SERVICE_URL`（預設 http://localhost:3009）。
- **subscription-service**：預設 port 3009，避免與 messaging（3005）衝突。

---

## 五、後續可補項目

- 死信佇列 / 告警（Kafka 消費失敗）。
- Redis 與 DB 不一致時的重試或校準策略。
- OAuth、WebSocket、真實推播等進階功能。

---

*與 [BUSINESS_LOGIC_GAPS.md](./BUSINESS_LOGIC_GAPS.md) 對照可取得細項檢視與建議。*
