# Phase A: æ¥µé«˜é¢¨éšªæ¥­å‹™é‚è¼¯ä¿®å¾© - å¿«é€ŸæŒ‡å—

## ðŸŽ¯ ä¿®å¾©å…§å®¹

æœ¬æ¬¡ä¿®å¾©è§£æ±ºäº† 3 å€‹æ¥µé«˜é¢¨éšªçš„æ¥­å‹™é‚è¼¯å•é¡Œï¼š

1. **ææ¬¾é‡‘é¡é©—è­‰æ¼æ´ž** - å¯èƒ½å°Žè‡´éžæ³•ææ¬¾
2. **å¹‚ç­‰æ€§è™•ç†ç¼ºå¤±** - å¯èƒ½å°Žè‡´é‡è¤‡æ‰£æ¬¾
3. **Admin æŽˆæ¬Šç¹žéŽ** - æœªæŽˆæ¬Šç”¨æˆ¶å¯èƒ½è¨ªå•å¾Œå°

## ðŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢žæ–‡ä»¶
```
apps/admin/middleware.ts                              # Admin è·¯ç”±ä¿è­·
apps/admin/lib/permissions.ts                         # æ¬Šé™ç®¡ç†ç³»çµ±
apps/web/app/(main)/wallet/withdraw/page.test.tsx    # ææ¬¾æ¸¬è©¦
apps/web/app/(main)/subscription/page.test.tsx        # è¨‚é–±æ¸¬è©¦
apps/admin/middleware.test.ts                         # Middleware æ¸¬è©¦
```

### ä¿®æ”¹æ–‡ä»¶
```
apps/web/app/(main)/wallet/withdraw/page.tsx          # ææ¬¾é é¢ä¿®å¾©
apps/web/app/(main)/subscription/page.tsx             # è¨‚é–±é é¢ä¿®å¾©
apps/admin/lib/auth.ts                                # Token é©—è­‰å¢žå¼·
```

## ðŸ§ª é‹è¡Œæ¸¬è©¦

### å…¨éƒ¨æ¸¬è©¦
```bash
npm test
```

### ææ¬¾åŠŸèƒ½æ¸¬è©¦
```bash
npm test -- --testPathPattern="withdraw/page.test"
```

### è¨‚é–±åŠŸèƒ½æ¸¬è©¦
```bash
npm test -- --testPathPattern="subscription/page.test"
```

### Admin Middleware æ¸¬è©¦
```bash
npm test -- --testPathPattern="middleware.test"
```

### é‹è¡Œæ‰€æœ‰æ–°å¢žæ¸¬è©¦
```bash
npm test -- --testPathPattern="(withdraw|subscription|middleware).test"
```

## ðŸ” é©—è­‰ä¿®å¾©

### 1. ææ¬¾åŠŸèƒ½é©—è­‰

**æ¸¬è©¦å ´æ™¯ 1: é‡‘é¡ç¯„åœé©—è­‰**
```
1. è¨ªå• /wallet/withdraw
2. è¼¸å…¥é‡‘é¡ $10ï¼ˆä½Žæ–¼æœ€ä½Ž $20ï¼‰
3. é»žæ“Šã€Œç¢ºèªææ¬¾ã€
4. âœ… æ‡‰é¡¯ç¤ºéŒ¯èª¤ï¼šã€Œæœ€ä½Žææ¬¾é‡‘é¡ç‚º $20ã€
```

**æ¸¬è©¦å ´æ™¯ 2: é¤˜é¡æª¢æŸ¥**
```
1. å‡è¨­é¤˜é¡ $1000ï¼Œå¾…è™•ç†ææ¬¾ $500
2. å˜—è©¦ææ¬¾ $600
3. âœ… æ‡‰é¡¯ç¤ºéŒ¯èª¤ï¼šã€Œå¯ç”¨é¤˜é¡ä¸è¶³ï¼ˆå¯ç”¨ï¼š$500ï¼‰ã€
```

**æ¸¬è©¦å ´æ™¯ 3: å¹‚ç­‰æ€§ä¿è­·**
```
1. å¡«å¯«ææ¬¾è¡¨å–®
2. é€£çºŒå¿«é€Ÿé»žæ“Šã€Œç¢ºèªé€å‡ºã€æŒ‰éˆ•
3. âœ… æ‡‰åªæäº¤ä¸€æ¬¡ï¼ŒæŒ‰éˆ•é¡¯ç¤º loading ä¸¦ç¦ç”¨
```

### 2. è¨‚é–±åŠŸèƒ½é©—è­‰

**æ¸¬è©¦å ´æ™¯ 1: ç¢ºèªå°è©±æ¡†**
```
1. è¨ªå• /subscription
2. é»žæ“Šã€Œç«‹å³è¨‚é–±ã€
3. âœ… æ‡‰é¡¯ç¤ºç¢ºèªå°è©±æ¡†ï¼ŒåŒ…å«æ–¹æ¡ˆè©³æƒ…
```

**æ¸¬è©¦å ´æ™¯ 2: é˜²æŠ–ä¿è­·**
```
1. å¿«é€Ÿé€£çºŒé»žæ“Šã€Œç«‹å³è¨‚é–±ã€æŒ‰éˆ•
2. âœ… åªé¡¯ç¤ºä¸€æ¬¡ç¢ºèªå°è©±æ¡†
3. ç¢ºèªå¾Œï¼Œåœ¨ 2 ç§’å…§å†æ¬¡é»žæ“Š
4. âœ… æ‡‰è¢«å¿½ç•¥
```

**æ¸¬è©¦å ´æ™¯ 3: å–æ¶ˆç¢ºèª**
```
1. é»žæ“Šã€Œå–æ¶ˆè¨‚é–±ã€
2. âœ… æ‡‰é¡¯ç¤ºè­¦å‘Šå°è©±æ¡†
3. âœ… èªªæ˜Žå–æ¶ˆå¾Œæžœå’Œåˆ°æœŸæ—¥
```

### 3. Admin æ¬Šé™é©—è­‰

**æ¸¬è©¦å ´æ™¯ 1: æœªç™»å…¥è¨ªå•**
```
1. æ¸…é™¤ admin_token cookie
2. è¨ªå• /admin/dashboard
3. âœ… æ‡‰è‡ªå‹•é‡å®šå‘åˆ° /admin/login
```

**æ¸¬è©¦å ´æ™¯ 2: éžç®¡ç†å“¡è¨ªå•**
```
1. ä½¿ç”¨æ™®é€šç”¨æˆ¶ token è¨ªå•
2. âœ… æ‡‰è¿”å›ž 403 Forbidden
3. âœ… æŽ§åˆ¶å°æ‡‰è¨˜éŒ„æœªæŽˆæ¬Šå˜—è©¦
```

**æ¸¬è©¦å ´æ™¯ 3: Token éŽæœŸ**
```
1. ä½¿ç”¨éŽæœŸ token
2. è¨ªå•ä»»ä½• admin é é¢
3. âœ… æ‡‰é‡å®šå‘åˆ°ç™»å…¥é ä¸¦æ¸…é™¤ cookie
```

## ðŸ“Š æ¸¬è©¦è¦†è“‹çŽ‡

```
ç¸½è¨ˆ: 30 å€‹æ¸¬è©¦æ¡ˆä¾‹

ææ¬¾é é¢:        10 å€‹ âœ…
è¨‚é–±é é¢:         9 å€‹ âœ…
Admin Middleware: 11 å€‹ âœ…
```

## ðŸ” å®‰å…¨æ”¹é€²æ‘˜è¦

### ææ¬¾å®‰å…¨
- âœ… é‡‘é¡ç¯„åœï¼š$20 - $50,000
- âœ… å°æ•¸é™åˆ¶ï¼šæœ€å¤š 2 ä½
- âœ… é¤˜é¡æª¢æŸ¥ï¼šå«å¾…è™•ç†ææ¬¾
- âœ… å¹‚ç­‰æ€§ï¼šUUID è«‹æ±‚ ID
- âœ… æ ¼å¼é©—è­‰ï¼šéŠ€è¡Œå¸³è™Ÿ/PayPal

### æ“ä½œå®‰å…¨
- âœ… é˜²æŠ–æ©Ÿåˆ¶ï¼š2 ç§’é˜²é‡è¤‡
- âœ… ç¢ºèªå°è©±æ¡†ï¼šé˜²èª¤æ“ä½œ
- âœ… æŒ‰éˆ•ç‹€æ…‹ï¼šæäº¤ä¸­ç¦ç”¨
- âœ… éŒ¯èª¤è™•ç†ï¼šå‹å¥½æç¤º + é‡è©¦

### è¨ªå•å®‰å…¨
- âœ… Middlewareï¼šè·¯ç”±ç´šä¿è­·
- âœ… JWT é©—è­‰ï¼šæ ¼å¼ + éŽæœŸ
- âœ… è§’è‰²æŽ§åˆ¶ï¼šåƒ… ADMIN
- âœ… å®‰å…¨æ—¥èªŒï¼šå®Œæ•´è¨˜éŒ„

## ðŸ“ ä»£ç¢¼ç¤ºä¾‹

### ææ¬¾é©—è­‰ç¤ºä¾‹

```typescript
// å‹•æ…‹é©—è­‰è¦å‰‡
const createWithdrawSchema = (availableBalance: number) => z.object({
  amount: z.number()
    .min(20, 'æœ€ä½Žææ¬¾é‡‘é¡ç‚º $20')
    .max(50000, 'å–®æ¬¡ææ¬¾ä¸èƒ½è¶…éŽ $50,000')
    .refine(val => val <= availableBalance, 'å¯ç”¨é¤˜é¡ä¸è¶³'),
  // ...
});

// å¹‚ç­‰æ€§ä¿è­·
const idempotencyKey = uuidv4();
await paymentsApi.requestWithdrawal(
  amount,
  method,
  details,
  idempotencyKey
);
```

### Admin Middleware ç¤ºä¾‹

```typescript
export async function middleware(request: NextRequest) {
  const token = request.cookies.get('admin_token')?.value;
  
  if (!token) {
    return NextResponse.redirect(new URL('/login', request.url));
  }
  
  const payload = verifyToken(token);
  
  if (payload.role !== 'ADMIN') {
    return new NextResponse(
      JSON.stringify({ error: 'Forbidden' }),
      { status: 403 }
    );
  }
  
  return NextResponse.next();
}
```

## ðŸš€ éƒ¨ç½²æª¢æŸ¥æ¸…å–®

### éƒ¨ç½²å‰
- [ ] æ‰€æœ‰æ¸¬è©¦é€šéŽ
- [ ] Code Review å®Œæˆ
- [ ] Backend API å·²æ›´æ–°ï¼ˆå¹‚ç­‰æ€§æ”¯æŒï¼‰
- [ ] ç’°å¢ƒè®Šæ•¸é…ç½®æ­£ç¢º

### éƒ¨ç½²å¾Œ
- [ ] é©—è­‰ææ¬¾åŠŸèƒ½
- [ ] é©—è­‰è¨‚é–±åŠŸèƒ½
- [ ] é©—è­‰ Admin æ¬Šé™
- [ ] æª¢æŸ¥éŒ¯èª¤æ—¥èªŒ
- [ ] ç›£æŽ§ç•°å¸¸è¡Œç‚º

## ðŸ“š ç›¸é—œæ–‡æª”

- [å®Œæ•´ä¿®å¾©å ±å‘Š](./PHASE_A_COMPLETION_REPORT.md)
- [æ¥­å‹™é‚è¼¯é©—è­‰æ–‡æª”](./business-logic-validation.md)
- [æ¸¬è©¦è¦†è“‹çŽ‡å ±å‘Š](./test-coverage-report.md)

## ðŸ†˜ å•é¡ŒæŽ’æŸ¥

### æ¸¬è©¦å¤±æ•—

å¦‚æžœæ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ï¼š

1. ä¾è³´æ˜¯å¦å®‰è£ï¼š`npm install`
2. Mock é…ç½®æ˜¯å¦æ­£ç¢º
3. setupTests.ts æ˜¯å¦å­˜åœ¨
4. Jest é…ç½®æ˜¯å¦æ­£ç¢º

### é‹è¡Œæ™‚éŒ¯èª¤

å¦‚æžœé‹è¡Œæ™‚å‡ºç¾éŒ¯èª¤ï¼š

1. æª¢æŸ¥ API ç«¯é»žæ˜¯å¦æ­£ç¢º
2. ç¢ºèªå¾Œç«¯æ”¯æŒå¹‚ç­‰æ€§åƒæ•¸
3. æª¢æŸ¥ token æ ¼å¼å’Œæœ‰æ•ˆæœŸ
4. æŸ¥çœ‹ console éŒ¯èª¤è¨Šæ¯

## ðŸ“ž è¯çµ¡

å¦‚æœ‰å•é¡Œï¼Œè«‹è¯çµ¡ Frontend Developer Team

---

**ç‰ˆæœ¬**: 1.0  
**æœ€å¾Œæ›´æ–°**: 2024-01-XX
