# Sugar Daddy 專案架構與設計

結合 Tinder（配對交友）與 OnlyFans（訂閱 Sugar Baby）的平台後端。**目標規模：** 10 萬同時在線用戶。

---

## 技術棧

| 類別 | 技術 |
|------|------|
| 架構 | Nx Monorepo + 微服務 |
| 框架 | NestJS (TypeScript) |
| 主資料庫 | PostgreSQL (讀寫分離 + Sharding) |
| 快取 | Redis Cluster |
| 訊息佇列 | Kafka |
| 檔案儲存 | Cloudinary / AWS S3 |
| 金流 | Stripe Connect |
| 容器 | Docker + Kubernetes |
| 前端 | Next.js 14 (App Router) + Tailwind CSS |

---

## 微服務架構

```
Client → API Gateway (:3000)
              │
  ┌───────────┼───────────────────────────────┐
  ▼           ▼           ▼                   ▼
Auth       User       Matching          Admin Service
(:3002)   (:3001)    (:3003)              (:3011)
  ▼           ▼           ▼
Subscription  Content   Payment   Media   Messaging  Notification
(:3009)      (:3006)  (:3007)  (:3008)  (:3005)    (:3004)
              │
              ▼
         Redis (讀取/快取)
         Kafka (寫入/事件)
              │
              └──► DB Writer (:3010) ──► PostgreSQL
```

### 資料流原則（重要）

- **用戶 API 不直連 DB**：讀取來自 Redis，寫入經 Kafka 發送事件
- **DB Writer** 是唯一消費 Kafka 並寫入 PostgreSQL 的服務
- 詳見 [04-運維與效能.md](./04-運維與效能.md)

---

## 服務一覽

### Backend Services

| 服務 | Port | Route prefix | 主要職責 |
|------|------|--------------|----------|
| api-gateway | 3000 | Proxies `/api/*` | 統一入口、路由代理 |
| user-service | 3001 | `/api/users` | 用戶資料、個人頁面、推薦卡片 |
| auth-service | 3002 | `/api/auth` | JWT 認證、註冊登入、Refresh Token |
| matching-service | 3003 | `/api/matching` | 滑動、推薦卡片、配對 |
| notification-service | 3004 | `/api/notifications` | 推播通知（Kafka-driven） |
| messaging-service | 3005 | `/api/messaging` | 對話與訊息（Kafka-driven） |
| content-service | 3006 | `/api/posts` | 貼文、讚、留言、PPV |
| payment-service | 3007 | `/api/tips`, `/api/stripe` | 交易、打賞、貼文購買 |
| media-service | 3008 | `/api/upload`, `/api/media` | 檔案上傳（Cloudinary） |
| subscription-service | 3009 | `/api/subscription-tiers`, `/api/subscriptions` | 訂閱方案、訂閱管理 |
| db-writer-service | 3010 | — | Kafka consumer，寫入 PostgreSQL |
| admin-service | 3011 | `/api/admin` | 管理後台 API（ADMIN only） |

### Frontend Apps

| App | Port | Stack |
|-----|------|-------|
| web | 4200 | Next.js 14 (App Router) + Tailwind |
| admin | 4300 | Next.js 14 (App Router) + Tailwind + shadcn/ui |

### Shared Libraries (libs/)

| Library | Purpose |
|---------|---------|
| **common** | Config, auth guards/decorators, Stripe services, Kafka helpers, sharding |
| **auth** | AuthModule, JWT strategy, re-exports from common |
| **database** | TypeORM setup, all entities |
| **kafka** | KafkaModule, KafkaProducerService, KafkaConsumerService |
| **redis** | RedisModule, RedisService |
| **dto** | Shared DTO interfaces + PaginatedResponse |
| **ui** | Shared React components |
| **api-client** | Typed HTTP client (axios-based) |

---

## Phase 完成度

### Phase 1 配對系統 ✅
- Nx Monorepo、Common libs、User/Auth/Matching/Notification/Messaging
- 資料流已對齊：Redis 讀、Kafka 寫、DB Writer 消費
- 待補：OAuth、WebSocket、真實推播 FCM/APNs

### Phase 2 訂閱系統 ✅
- Subscription、Content、Payment、Media 四服務已實作
- PPV、訂閱牆可見性、Stripe Webhook 冪等

### Phase 3 優化 ✅
- 讀寫分離、Sharding 基礎、效能調優
- API 分頁（PaginatedResponse）已加入所有列表端點

### Phase 4 管理後台 ✅
- admin-service（後端）+ admin（前端）
- 用戶管理、內容審核、系統監控、數據分析

---

## 業務邏輯檢核摘要

各服務 JWT 與所有權驗證、冪等處理（PPV 購買、Stripe Webhook）、訂閱支付完成延長週期等均已實作 ✅。詳見 [BUSINESS_LOGIC_GAPS.md](./BUSINESS_LOGIC_GAPS.md)。
