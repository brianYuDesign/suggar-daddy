# 專案功能分析

本文件描述目前後端功能現狀與完成度，供開發與對接參考。

---

## 一、專案定位

- **類型**：約會 + 訂閱/內容平台（Tinder × OnlyFans 風格）
- **架構**：Nx Monorepo、NestJS 微服務
- **技術棧**：PostgreSQL、Redis、Kafka、Stripe、Next.js 14

---

## 二、微服務與功能概覽

| 服務 | Port | 職責 | 儲存/通訊 | 完成度 |
|------|------|------|-----------|--------|
| **api-gateway** | 3000 | 統一入口、依路徑代理至各服務 | 轉發 HTTP + Authorization | ✅ |
| **auth-service** | 3002 | 註冊、登入、Refresh、登出 | Redis + Kafka user.created | ✅ |
| **user-service** | 3001 | 個人/公開資料、用戶卡片、推薦用 GET /cards | Redis + Kafka | ✅ |
| **matching-service** | 3003 | 滑卡、雙向喜歡配對、unmatch | Redis + Kafka matching.matched | ✅ |
| **notification-service** | 3004 | 發送/列表/已讀通知 | Redis + Kafka notification.created | ✅ |
| **messaging-service** | 3005 | 發送訊息、對話列表、訊息歷史 | Redis + Kafka message.created | ✅ |
| **content-service** | 3006 | 貼文 CRUD、讚/留言、PPV、訂閱牆可見性 | Redis + Kafka | ✅ |
| **subscription-service** | 3009 | 訂閱方案、訂閱建立/查詢/延長/取消 | Redis + Kafka + Stripe | ✅ |
| **payment-service** | 3007 | 打賞、PPV、Stripe Webhook、交易查詢 | Redis 冪等 + Kafka | ✅ |
| **media-service** | 3008 | 媒體上傳、建立/刪除紀錄 | Redis + Kafka | ✅ |
| **db-writer-service** | 3010 | 消費 Kafka 寫入 PostgreSQL 並回寫 Redis | TypeORM + Redis | ✅ |
| **admin-service** | 3011 | 管理後台 API（ADMIN only） | 呼叫各服務 | ✅ |

### Frontend

| App | Port | 說明 |
|-----|------|------|
| **web** | 4200 | 使用者前端（Next.js 14 + Tailwind） |
| **admin** | 4300 | 管理後台（Next.js 14 + Tailwind + shadcn/ui） |

---

## 三、已實作重點

### 1. API Gateway

- 單一入口（:3000），依 URL 前綴轉發至各微服務。
- 路徑對照：`/api/auth` → auth、`/api/users` → user、`/api/matching` → matching、`/api/posts` → content、`/api/subscriptions` → subscription、`/api/tips`、`/api/stripe` → payment、`/api/upload`、`/api/media` → media、`/api/admin` → admin-service。
- 可透過環境變數覆寫各服務 URL。

### 2. 授權與身分

- JWT（access + refresh）、Content 創作者權限、Subscription tier 創作者/ADMIN、Payment 強制當前用戶、Messaging isParticipant、Notification 僅本人、Media 所有權檢查，均已對齊業務需求。
- Admin Service 全 API 限定 ADMIN 角色。
- 詳見 [BUSINESS_LOGIC_GAPS.md](./BUSINESS_LOGIC_GAPS.md)。

### 3. Matching 推薦

- `getCards` 呼叫 user-service **GET /api/users/cards**（exclude 自己 + 已 swipe），回傳真實用戶卡片。

### 4. Messaging / Notification 持久化

- **Messaging**：對話與訊息存 Redis；發送時發送 Kafka `message.created`。
- **Notification**：通知存 Redis；發送時發送 Kafka `notification.created`。

### 5. 訂閱牆可見性

- **subscribers**：僅對該創作者有有效訂閱的 viewer 可看完整內容。
- **tier_specific**：僅訂閱該 requiredTierId 的 viewer 可看。
- subscription-service 提供 **GET /api/subscriptions/check**；content-service 依此過濾。

### 6. 支付與訂閱

- Stripe 訂閱建立/取消、payment.completed 延長週期。
- PPV / 打賞 PaymentIntent + Webhook；PPV 與 Webhook 冪等（Redis）。

### 7. API 分頁

- 所有列表端點支援 `page` / `limit` 查詢參數，回傳統一的 `PaginatedResponse<T>` 格式（data、total、page、limit）。
- 定義於 `libs/dto/src/pagination.dto.ts`。

### 8. 管理後台

- **admin-service**（:3011）：用戶管理（停用/啟用）、內容審核（檢舉處理）、系統監控、數據分析。
- **admin 前端**（:4300）：Dashboard、用戶管理、內容審核、支付、分析、系統頁面。使用 shadcn/ui 元件庫。

---

## 四、環境變數要點

- **api-gateway**：各服務 URL（如 `AUTH_SERVICE_URL`、`SUBSCRIPTION_SERVICE_URL` 等），預設為 localhost 對應 port。
- **matching-service**：`USER_SERVICE_URL`（預設 http://localhost:3001）。
- **content-service**：`SUBSCRIPTION_SERVICE_URL`（預設 http://localhost:3009）。
- **subscription-service**：port 3009。

---

## 五、後續可補項目

- 死信佇列 / 告警（Kafka 消費失敗）
- Redis 與 DB 不一致時的重試或校準策略
- OAuth、WebSocket、真實推播 FCM/APNs
- Stripe Connect（創作者分潤）

---

*與 [BUSINESS_LOGIC_GAPS.md](./BUSINESS_LOGIC_GAPS.md) 對照可取得細項檢視。*
