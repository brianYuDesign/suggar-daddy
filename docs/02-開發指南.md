# 開發指南

整合 API 文件、JWT 認證、檔案上傳與 Kafka 事件的開發說明。

---

## 1. API 文件（Swagger）

各微服務於 `/api/docs` 提供 Swagger UI：

| 服務 | Swagger 位址 | 埠號 |
|------|--------------|------|
| Subscription | http://localhost:3005/api/docs | 3005 |
| Content | http://localhost:3006/api/docs | 3006 |
| Payment | http://localhost:3007/api/docs | 3007 |
| Media | http://localhost:3008/api/docs | 3008 |

### 使用 Swagger 認證

1. 點擊 **Authorize**
2. 輸入 `Bearer <JWT token>`
3. 點擊 Authorize 後即可測試受保護端點

---

## 2. JWT 認證與授權

### 使用者角色

```typescript
enum UserRole {
  ADMIN = 'admin',
  CREATOR = 'creator',
  SUBSCRIBER = 'subscriber',
}
```

### 常用 Decorator

| Decorator | 說明 |
|-----------|------|
| `@Public()` | 免認證 |
| `@Roles(UserRole.CREATOR)` | 限定角色 |
| `@CurrentUser()` | 注入當前用戶 |
| `@CurrentUser('userId')` | 僅取 userId |

### 範例

```typescript
@Public()
@Get('health')
async health() { return { status: 'ok' }; }

@Get('profile')
async profile(@CurrentUser() user: CurrentUserData) {
  return { userId: user.userId, email: user.email, role: user.role };
}

@Post('posts')
@Roles(UserRole.CREATOR)
async createPost(@CurrentUser('userId') userId: string) {
  return this.postsService.create(userId, dto);
}
```

### 環境變數

```env
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d
```

---

## 3. 檔案上傳（Cloudinary）

### 環境變數

```env
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
```

### API 端點

| 端點 | 說明 |
|------|------|
| `POST /upload/single` | 單檔上傳 |
| `POST /upload/multiple` | 多檔上傳（最多 10 檔） |
| `DELETE /upload/:id` | 刪除媒體 |

### 範例

```typescript
// multipart/form-data
file: <binary>
userId: "user-123"
folder: "posts" (選填)
```

---

## 4. Kafka 事件整合

### 常用 Topic

| 分類 | Topic |
|------|-------|
| 訂閱 | `subscription.created`, `subscription.cancelled` |
| 支付 | `payment.completed`, `payment.failed` |
| 內容 | `content.post.created`, `content.post.liked` |
| 媒體 | `media.uploaded`, `media.deleted` |

### 發送事件

```typescript
await this.kafkaProducer.send({
  topic: 'subscription.created',
  messages: [{ key: id, value: JSON.stringify(event) }],
});
```

### 消費事件

```typescript
@EventPattern('payment.completed')
async handlePaymentCompleted(@Payload() event: PaymentCompletedEvent) {
  // 處理邏輯
}
```

### 環境變數

```env
KAFKA_BROKERS=localhost:9092
```

---

## 5. 錯誤回應格式

| 狀態碼 | 說明 |
|--------|------|
| 400 | 驗證失敗（class-validator） |
| 401 | 未認證 |
| 403 | 權限不足 |
| 404 | 資源不存在 |
| 500 | 伺服器錯誤 |

---

## 參考資源

- [NestJS Swagger](https://docs.nestjs.com/openapi/introduction)
- [Cloudinary 文件](https://cloudinary.com/documentation)
- [Kafka 官方文件](https://kafka.apache.org/documentation/)
