# 開發指南

整合 API 文件、JWT 認證、檔案上傳、Kafka 事件與分頁的開發說明。

---

## 1. API 文件（Swagger）

各微服務於 `/api/docs` 提供 Swagger UI：

| 服務 | Swagger 位址 | 埠號 |
|------|--------------|------|
| Content | http://localhost:3006/api/docs | 3006 |
| Payment | http://localhost:3007/api/docs | 3007 |
| Media | http://localhost:3008/api/docs | 3008 |
| Subscription | http://localhost:3009/api/docs | 3009 |

### 使用 Swagger 認證

1. 點擊 **Authorize**
2. 輸入 `Bearer <JWT token>`
3. 點擊 Authorize 後即可測試受保護端點

---

## 2. JWT 認證與授權

### 使用者角色

```typescript
enum UserRole {
  ADMIN = 'admin',
  CREATOR = 'creator',
  SUBSCRIBER = 'subscriber',
}
```

### 常用 Decorator

| Decorator | 說明 |
|-----------|------|
| `@Public()` | 免認證 |
| `@Roles(UserRole.CREATOR)` | 限定角色 |
| `@CurrentUser()` | 注入當前用戶 |
| `@CurrentUser('userId')` | 僅取 userId |

### Guards

| Guard | 說明 |
|-------|------|
| `JwtAuthGuard` | 預設全域 JWT 驗證 |
| `RolesGuard` | 角色驗證 |
| `OptionalJwtGuard` | 可選 JWT（未帶 token 不會拒絕） |

### 範例

```typescript
@Public()
@Get('health')
async health() { return { status: 'ok' }; }

@Get('profile')
async profile(@CurrentUser() user: CurrentUserData) {
  return { userId: user.userId, email: user.email, role: user.role };
}

@Post('posts')
@Roles(UserRole.CREATOR)
async createPost(@CurrentUser('userId') userId: string) {
  return this.postsService.create(userId, dto);
}
```

### 環境變數

```env
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d
```

---

## 3. 分頁（Pagination）

所有列表 API 支援分頁查詢，回傳統一的 `PaginatedResponse<T>` 格式。

### 查詢參數

| 參數 | 說明 | 預設 | 上限 |
|------|------|------|------|
| `page` | 頁碼（從 1 開始） | 1 | — |
| `limit` | 每頁筆數 | 20 | 100 |

### 回應格式

```typescript
interface PaginatedResponse<T> {
  data: T[];
  total: number;
  page: number;
  limit: number;
}
```

### 已支援的端點

| 服務 | 端點 | 說明 |
|------|------|------|
| Content | `GET /api/posts` | 公開貼文列表 |
| Content | `GET /api/posts/:id/comments` | 貼文留言 |
| Media | `GET /api/media` | 媒體列表 |
| Payment | `GET /api/tips` | 打賞紀錄 |
| Payment | `GET /api/transactions` | 交易紀錄 |
| Subscription | `GET /api/subscriptions` | 訂閱列表 |

---

## 4. 檔案上傳（Cloudinary）

### 環境變數

```env
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
```

### API 端點

| 端點 | 說明 |
|------|------|
| `POST /api/upload/single` | 單檔上傳 |
| `POST /api/upload/multiple` | 多檔上傳（最多 10 檔） |
| `DELETE /api/upload/:id` | 刪除媒體 |

### 範例

```typescript
// multipart/form-data
file: <binary>
userId: "user-123"
folder: "posts" (選填)
```

---

## 5. Kafka 事件整合

### 常用 Topic

| 分類 | Topic |
|------|-------|
| 用戶 | `user.created` |
| 配對 | `matching.matched` |
| 訂閱 | `subscription.created`, `subscription.cancelled` |
| 支付 | `payment.completed`, `payment.failed` |
| 內容 | `content.post.created`, `content.post.liked` |
| 媒體 | `media.uploaded`, `media.deleted` |
| 訊息 | `message.created` |
| 通知 | `notification.created` |

### 發送事件

```typescript
await this.kafkaProducer.sendEvent('subscription.created', id, event);
```

### 消費事件

```typescript
@EventPattern('payment.completed')
async handlePaymentCompleted(@Payload() event: PaymentCompletedEvent) {
  // 處理邏輯
}
```

### 環境變數

```env
KAFKA_BROKERS=localhost:9092
```

---

## 6. 錯誤回應格式

| 狀態碼 | 說明 |
|--------|------|
| 400 | 驗證失敗（class-validator） |
| 401 | 未認證 |
| 403 | 權限不足 |
| 404 | 資源不存在 |
| 409 | 衝突（重複操作，如 PPV 重複購買） |
| 500 | 伺服器錯誤 |

---

## 參考資源

- [NestJS Swagger](https://docs.nestjs.com/openapi/introduction)
- [Cloudinary 文件](https://cloudinary.com/documentation)
- [Kafka 官方文件](https://kafka.apache.org/documentation/)
