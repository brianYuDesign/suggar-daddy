# 運維與效能

整合 DevOps 監控、效能調優、讀寫分離與 Sharding 設定。

---

## 1. 本地檢查與提交

| 指令 | 說明 |
|------|------|
| `npm run ci:check` | 執行 lint + test |
| `npm run commit -- "feat: 訊息"` | 通過檢查後自動 commit |

---

## 2. 監控架構

```
Grafana :3001 ──► Prometheus :9090
                      │
    ┌─────────────────┼─────────────────┐
    ▼                 ▼                 ▼
postgres-exporter  redis-exporter  node_exporter
     :9187             :9121           :9100
```

### 啟動監控

```bash
docker compose -f infrastructure/docker/docker-compose.yml \
               -f infrastructure/docker/docker-compose.monitoring.yml \
               up -d
```

- **Prometheus**: http://localhost:9090
- **Grafana**: http://3001（預設 admin/admin）
- **cAdvisor**: http://localhost:8081

### Grafana 儀表板 ID

| 監控對象 | Dashboard ID |
|----------|--------------|
| Redis | 763 |
| PostgreSQL | 9628 或 3662 |
| Node Exporter | 1860 或 11074 |
| cAdvisor | 14282 |

---

## 3. 讀寫分離（Replication）

僅 **DB Writer 服務** 連線資料庫。啟用後寫入送往 Master、讀取送往 Replica。

### 環境變數

| 變數 | 說明 |
|------|------|
| `DB_MASTER_HOST` | Master 主機 |
| `DB_REPLICA_HOSTS` | Replica 列表（逗號分隔） |

**啟用條件：** 同時設定 `DB_MASTER_HOST` 與 `DB_REPLICA_HOSTS`。

---

## 4. 連線池

| 變數 | 說明 | 預設 |
|------|------|------|
| `DB_POOL_MAX` | 最大連線數 | 20 |
| `DB_POOL_MIN` | 最小連線數 | 5 |
| `DB_POOL_IDLE_TIMEOUT_MS` | 閒置逾時 | 30000 |
| `DB_CONNECT_TIMEOUT_MS` | 連線逾時 | 5000 |

---

## 5. Sharding（分片）

由 `@suggar-daddy/common` 的 `ShardingService` 提供：

```typescript
// 依 user_id
const shardId = this.sharding.getShardIdByUserId(userId);
// 依 conversation_id
const shardId = this.sharding.getShardIdByConversationId(conversationId);
// 依 creator_id
const shardId = this.sharding.getShardIdByCreatorId(creatorId);
```

**環境變數：** `SHARD_COUNT`（預設 16）

---

## 6. 索引建議

| 表 | 建議索引 |
|----|----------|
| users | `(email)` UNIQUE, `(last_active_at)` |
| swipes | `(swiper_id, swiped_id)` |
| matches | `(user_a_id, user_b_id)` |
| messages | `(conversation_id, created_at)` |
| subscriptions | `(subscriber_id)`, `(creator_id)` |
| posts | `(creator_id, created_at)` |

具體 SQL 見各服務 `migrations/` 與 [03-資料庫遷移.md](./03-資料庫遷移.md)。
