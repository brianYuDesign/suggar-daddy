# QA-003: Full System Integration Testing - Test Plan

**版本**: 1.0  
**日期**: 2026-02-19  
**狀態**: 執行中  
**目標**: 為灰度部署準備完整系統測試

---

## 📋 概述

### 任務目標
- ✅ 執行所有業務場景的端到端測試
- ✅ 性能測試達成目標 (<200ms API, 100+ 併發)
- ✅ 安全邊界測試全通過
- ✅ 部署前檢查清單完成
- ✅ 無 critical bugs

### 時間安排
| 階段 | 時間 | 狀態 |
|------|------|------|
| **Phase 1: 業務場景測試** | Day 1 | 準備中 |
| **Phase 2: 性能測試** | Day 1-2 | 待執行 |
| **Phase 3: 安全測試** | Day 2 | 待執行 |
| **Phase 4: 部署前檢查** | Day 3 | 待執行 |

---

## 🎯 Phase 1: 完整業務場景測試

### 場景 1: 新用戶完整旅程

#### 1.1 用戶註冊
```
測試點:
- [  ] 有效郵箱註冊
- [  ] 無效郵箱格式拒絕
- [  ] 弱密碼拒絕
- [  ] 重複郵箱拒絕
- [  ] 驗證郵件發送
- [  ] 郵件驗證鏈接有效
- [  ] 驗證後激活賬號
- [  ] 未驗證無法登入

期望結果: 註冊成功率 100%, 驗證流程完整
```

#### 1.2 首次登入
```
測試點:
- [  ] 正確憑證登入成功
- [  ] 錯誤密碼被拒絕
- [  ] 不存在用戶被拒絕
- [  ] JWT token 正確生成
- [  ] Refresh token 有效期 7 天
- [  ] Access token 有效期 15 分鐘
- [  ] Token 存儲在 secure httpOnly cookie
- [  ] 登入後可訪問受保護資源

期望結果: 登入成功率 100%, Token 機制完整
```

#### 1.3 查看內容推薦
```
測試點:
- [  ] 首頁推薦加載 <500ms
- [  ] 返回 10-20 個推薦
- [  ] 推薦包含標題、描述、縮圖
- [  ] 點擊推薦能打開內容詳情
- [  ] 無法訪問未購買的高級內容
- [  ] 缓存命中率 >80%
- [  ] 個性化推薦工作
- [  ] 黑名單內容被過濾

期望結果: 推薦系統正常, 性能達標
```

---

### 場景 2: 創作者內容發佈流程

#### 2.1 內容上傳
```
測試點:
- [  ] 非創作者上傳被拒絕
- [  ] 創作者可上傳視頻 (<2GB)
- [  ] 上傳進度正確顯示
- [  ] 支持 MP4, MKV, WebM
- [  ] 縮圖自動生成
- [  ] 元數據驗證 (標題, 描述)
- [  ] 草稿自動保存
- [  ] S3 上傳成功確認

期望結果: 上傳成功率 100%, 無損失
```

#### 2.2 內容審核
```
測試點:
- [  ] 內容創建後進入審核狀態
- [  ] 審核員可看審核隊列
- [  ] 批准流程: 審核 → 發佈
- [  ] 拒絕流程: 審核 → 反饋 → 修改
- [  ] 審核時間 <24 小時
- [  ] 審核日誌完整記錄
- [  ] 權限檢查 (只有 moderator 可審核)
- [  ] 審核決定發送通知

期望結果: 審核流程完整, 權限正確
```

#### 2.3 內容發佈
```
測試點:
- [  ] 批准後立即發佈
- [  ] CDN 緩存刷新
- [  ] 推薦系統重新訓練
- [  ] 訂閱通知發送
- [  ] 內容在首頁可見
- [  ] 統計數據初始化
- [  ] 發佈時間戳正確
- [  ] 作者資料正確連接

期望結果: 發佈流程完整, 數據一致性
```

---

### 場景 3: 訂閱支付流程

#### 3.1 查看訂閱計劃
```
測試點:
- [  ] 訂閱頁面加載 <300ms
- [  ] 顯示 3 個計劃 (月/年/終身)
- [  ] 價格與貨幣正確
- [  ] 免費試用信息清楚
- [  ] 比較表格完整
- [  ] 立即開始按鈕明顯
- [  ] 已訂閱用戶看升級選項
- [  ] 支付方式清晰

期望結果: UI/UX 清晰, 信息完整
```

#### 3.2 發起支付
```
測試點:
- [  ] 點擊「訂閱」進入支付頁面
- [  ] Stripe/PayPal 集成正常
- [  ] 測試卡號 4242 4242 4242 4242 成功
- [  ] 無效卡號被拒絕
- [  ] 金額正確計算
- [  ] 稅率應用正確
- [  ] 優惠碼工作
- [  ] 支付超時處理

期望結果: 支付集成完整, 交易安全
```

#### 3.3 支付確認和訂閱激活
```
測試點:
- [  ] 支付成功後立即確認
- [  ] Webhook 接收成功
- [  ] 訂閱狀態更新為 active
- [  ] 用戶能訪問高級內容
- [  ] 訂閱開始日期正確
- [  ] 續費日期計算正確
- [  ] 發送訂閱確認郵件
- [  ] 用戶能下載發票

期望結果: 訂閱激活, 權限生效
```

#### 3.4 觀看高級內容
```
測試點:
- [  ] 訂閱用戶能訪問所有高級內容
- [  ] 非訂閱用戶被重定向
- [  ] 播放器加載 <1s
- [  ] 音量/進度條正常
- [  ] 清晰度自適應
- [  ] 字幕正確加載
- [  ] 續播功能正常
- [  ] 離線下載工作 (如支持)

期望結果: 播放無阻塞, 用戶體驗好
```

---

### 場景 4: 取消訂閱和退款

#### 4.1 發起取消
```
測試點:
- [  ] 帳戶設置中有取消選項
- [  ] 確認對話明確
- [  ] 顯示取消後果
- [  ] 取消日期清晰
- [  ] 支持立即取消 / 期末取消
- [  ] 保存取消原因反饋
- [  ] 發送確認郵件
- [  ] 管理員能看取消記錄

期望結果: 取消流程清晰, 用戶確認
```

#### 4.2 退款處理
```
測試點:
- [  ] 支付後 30 天內可退款
- [  ] 退款金額正確
- [  ] 退款到原卡片
- [  ] Stripe 記錄完整
- [  ] 發送退款確認郵件
- [  ] 退款速度 <3 天
- [  ] 取消後無法訪問高級內容
- [  ] 統計數據更新 (churn rate)

期望結果: 退款流程完整, 數據一致
```

#### 4.3 重新訂閱
```
測試點:
- [  ] 取消用戶能重新訂閱
- [  ] 無額外費用
- [  ] 訂閱狀態立即激活
- [  ] 歷史數據保留
- [  ] 推薦系統恢復
- [  ] 發送歡迎回來郵件
- [  ] 用戶體驗無縫

期望結果: 重新訂閱順利, 無中斷
```

---

## ✅ Phase 1 驗收標準

| 項目 | 目標 | 判斷標準 |
|------|------|--------|
| 註冊流程 | 100% | 8/8 測試通過 |
| 登入流程 | 100% | 8/8 測試通過 |
| 推薦系統 | 100% | 8/8 測試通過 |
| 內容上傳 | 100% | 8/8 測試通過 |
| 內容審核 | 100% | 8/8 測試通過 |
| 內容發佈 | 100% | 8/8 測試通過 |
| 訂閱計劃 | 100% | 8/8 測試通過 |
| 支付流程 | 100% | 8/8 測試通過 |
| 訂閱激活 | 100% | 8/8 測試通過 |
| 內容播放 | 100% | 8/8 測試通過 |
| 取消訂閱 | 100% | 8/8 測試通過 |
| 退款處理 | 100% | 8/8 測試通過 |
| 重新訂閱 | 100% | 7/7 測試通過 |
| **總計** | **100%** | **103/103 通過** |

---

## 🚀 Phase 2: 性能測試

### 2.1 API 延遲基準測試

#### 目標: API 響應時間 <200ms (99th percentile)

```bash
測試場景:
1. 用戶登入 API
   - 目標: <100ms
   - 吞吐量: 100 req/s
   
2. 推薦列表 API
   - 目標: <200ms (包含 DB 查詢)
   - 吞吐量: 50 req/s
   - 缓存命中: >80%
   
3. 內容詳情 API
   - 目標: <150ms
   - 吞吐量: 100 req/s
   
4. 支付 API
   - 目標: <300ms (Stripe 調用)
   - 吞吐量: 10 req/s (高優先級)
   
5. 搜索 API
   - 目標: <500ms (包含 DB 查詢)
   - 吞吐量: 20 req/s
```

### 2.2 併發用戶測試

#### 目標: 支持 100+ 同時在線用戶

```bash
測試場景:
- 初始: 10 用戶 (1 分鐘)
- 增長: 50 用戶 (2 分鐘)
- 峰值: 100 用戶 (5 分鐘)
- 下降: 10 用戶 (1 分鐘)

成功標準:
✅ 所有用戶能完成登入
✅ <10% 請求失敗
✅ 平均響應時間 <300ms
✅ 99th 百分位 <500ms
✅ CPU 使用率 <70%
✅ 內存使用率 <80%
✅ 數據庫連接池 <20 連接
```

### 2.3 數據庫查詢優化驗證

```bash
測試焦點:
- 推薦列表查詢 (複雜 JOIN)
  ✓ 創建索引驗證
  ✓ 查詢時間 <50ms
  
- 用戶歷史查詢
  ✓ 分頁優化
  ✓ 查詢時間 <30ms
  
- 支付記錄查詢
  ✓ 範圍查詢優化
  ✓ 查詢時間 <20ms
  
- 統計查詢 (聚合)
  ✓ 使用物化視圖
  ✓ 查詢時間 <100ms
```

### 2.4 CDN/緩存效能

```bash
測試焦點:
- Redis 命中率 >85%
  ✓ 推薦列表緩存 (1 小時)
  ✓ 用戶會話緩存 (7 天)
  
- CDN 命中率 >90%
  ✓ 靜態資源 (縮圖、視頻縮)
  ✓ 地理分佈測試
  
- 緩存失效驗證
  ✓ 手動失效成功
  ✓ 自動過期工作
```

---

## 🔐 Phase 3: 安全測試

### 3.1 認證邊界測試

```bash
測試場景:
1. 無效 Token
   - [ ] 空 token 被拒絕 (401)
   - [ ] 亂碼 token 被拒絕 (401)
   - [ ] 修改 payload 被拒絕 (401)
   
2. 過期 Token
   - [ ] 15 分鐘 access token 過期
   - [ ] 自動嘗試刷新
   - [ ] refresh token 過期被拒絕 (401)
   - [ ] 強制重新登入
   
3. 黑名單 Token
   - [ ] 登出後 token 進入黑名單
   - [ ] 黑名單 token 被拒絕 (401)
   - [ ] 黑名單快速查詢 (<10ms)
   
4. Token 簽名驗證
   - [ ] 使用錯誤密鑰簽名被拒絕
   - [ ] 算法改動被拒絕
   - [ ] 發布者欄位驗證

期望結果: 認證邊界完全保護
```

### 3.2 權限檢查測試

```bash
測試場景:
1. 非創作者上傳限制
   - [ ] 普通用戶無上傳端點
   - [ ] 拒絕上傳返回 403
   - [ ] 權限檢查 <5ms
   
2. 修改他人內容限制
   - [ ] 只能修改自己的內容
   - [ ] 修改他人內容返回 403
   - [ ] 管理員可強制修改
   
3. 支付記錄訪問限制
   - [ ] 用戶只看自己的訂單
   - [ ] 查詢他人訂單返回 403
   - [ ] 管理員可看所有訂單
   
4. 管理員功能限制
   - [ ] 只有管理員可審核
   - [ ] 只有管理員可設置費用
   - [ ] 操作日誌記錄

期望結果: 權限系統完全有效
```

### 3.3 SQL 注入防護

```bash
測試場景:
1. 登入表單注入
   - [ ] " OR 1=1 -- 被防護
   - [ ] '; DROP TABLE users; -- 被防護
   - [ ] 返回無效憑證錯誤
   
2. 搜索注入
   - [ ] 搜索詞用參數化查詢
   - [ ] 特殊字符正確轉義
   - [ ] LIKE 注入被防護
   
3. API 參數注入
   - [ ] ID 參數驗證類型
   - [ ] 日期參數驗證格式
   - [ ] JSON 輸入驗證
   
4. 依賴检查
   - [ ] npm audit 無重大風險
   - [ ] 使用最新安全補丁

期望結果: 無 SQL 注入漏洞
```

### 3.4 CORS 配置

```bash
測試場景:
1. 允許的來源
   - [ ] https://example.com 允許
   - [ ] https://app.example.com 允許
   - [ ] http://localhost:3000 允許 (開發)
   
2. 不允許的來源
   - [ ] https://evil.com 被拒絕 (CORS 錯誤)
   - [ ] https://example.com.attacker.com 被拒絕
   - [ ] 無 Access-Control-Allow-Origin header
   
3. 方法和頭檢查
   - [ ] GET 允許
   - [ ] POST 允許
   - [ ] PUT 允許
   - [ ] DELETE 允許
   - [ ] Authorization header 允許
   
4. Preflight 請求
   - [ ] OPTIONS 請求響應 200
   - [ ] 正確返回允許頭

期望結果: CORS 配置安全
```

### 3.5 其他安全檢查

```bash
- [ ] HTTPS/TLS 1.2+ 強制
- [ ] Secure cookie flags 設置
- [ ] X-Frame-Options 頭設置
- [ ] X-Content-Type-Options 頭設置
- [ ] CSP header 配置
- [ ] HSTS header 設置
- [ ] 無敏感信息日誌
- [ ] 密碼策略執行 (最少 8 字符)
- [ ] 率限制配置 (10 req/min 登入)
- [ ] 隱私數據脫敏
```

---

## 📋 Phase 4: 部署前檢查

### 4.1 灰度部署檢查清單

```markdown
## 灰度部署配置

- [ ] 灰度規則配置
  - [ ] 初始流量 5% (100 用戶)
  - [ ] 監控 4 小時
  - [ ] 無關鍵錯誤 → 增加到 25%
  - [ ] 監控 8 小時
  - [ ] 無關鍵錯誤 → 100% 全量

- [ ] 回滾計劃
  - [ ] 一鍵回滾到前一版本
  - [ ] 回滾時間 <5 分鐘
  - [ ] 數據一致性檢查
  - [ ] 回滾確認流程

- [ ] 灰度告警
  - [ ] 錯誤率 >1% 告警
  - [ ] 響應時間 >500ms 告警
  - [ ] CPU 使用率 >80% 告警
  - [ ] 內存使用率 >85% 告警
  - [ ] 數據庫連接數 >30 告警
```

### 4.2 生產環境配置驗證

```markdown
## 環境配置檢查

- [ ] 數據庫
  - [ ] PostgreSQL 16+ 版本
  - [ ] 最少 10GB 空間
  - [ ] 備份配置 (每日)
  - [ ] 複製配置 (HA 模式)
  - [ ] 連接池: max_connections=100

- [ ] Redis
  - [ ] Redis 7+ 版本
  - [ ] 持久化啟用 (AOF)
  - [ ] 內存上限: 2GB
  - [ ] 過期鍵清理配置

- [ ] CDN 配置
  - [ ] 源配置正確
  - [ ] 緩存規則完整
  - [ ] TLS 證書有效 (>90 天)
  - [ ] 地域限制配置

- [ ] 郵件服務
  - [ ] SMTP 伺服器配置
  - [ ] 發件人驗證 (SPF/DKIM)
  - [ ] 模板正確
  - [ ] 退信處理

- [ ] 支付服務
  - [ ] Stripe 生產密鑰
  - [ ] Webhook 簽名驗證
  - [ ] 測試交易成功
  - [ ] 退款流程測試

- [ ] 日誌收集
  - [ ] ELK 棧連接正常
  - [ ] 日誌級別適當
  - [ ] 日誌保留期 30 天
```

### 4.3 監控告警配置

```markdown
## 監控指標

### 應用層
- [ ] 請求速率 (req/s)
- [ ] 錯誤率 (%)
- [ ] 平均響應時間 (ms)
- [ ] P95/P99 響應時間

### 基礎設施層
- [ ] CPU 使用率
- [ ] 內存使用率
- [ ] 磁盤使用率
- [ ] 網絡 I/O

### 數據庫層
- [ ] 查詢響應時間
- [ ] 連接數
- [ ] 緩存命中率
- [ ] 表大小增長

### 告警閾值
| 指標 | 閾值 | 優先級 |
|------|------|--------|
| 錯誤率 | >1% | Critical |
| 響應時間 P99 | >1000ms | High |
| CPU | >85% | High |
| 內存 | >90% | High |
| 磁盤 | >85% | Medium |
```

### 4.4 回滾計劃

```markdown
## 回滾程序

### 自動回滾條件
1. 錯誤率 >5% (連續 2 分鐘)
2. 響應時間 P99 > 2000ms (連續 2 分鐘)
3. 數據庫連接池滿
4. 關鍵服務無響應

### 手動回滾步驟
```bash
# 1. 驗證當前版本問題
./health-check.sh

# 2. 確認回滾前版本
git log --oneline | head -5

# 3. 執行回滾
docker-compose down -v
git checkout previous-version
docker-compose up -d

# 4. 驗證回滾成功
./health-check.sh
./smoke-tests.sh

# 5. 通知團隊
slack-notify "Rolled back to v1.x.x"
```

### 驗證檢查清單
- [ ] 所有服務健康檢查通過
- [ ] 煙霧測試全通過
- [ ] 用戶能登入
- [ ] 內容能訪問
- [ ] 支付功能正常
- [ ] 沒有數據丟失
```

---

## 📊 測試執行狀態

### Phase 1: 業務場景測試

| 場景 | 測試點 | 通過 | 狀態 |
|------|--------|------|------|
| 註冊 | 8 | 0 | ⏳ |
| 登入 | 8 | 0 | ⏳ |
| 推薦 | 8 | 0 | ⏳ |
| 上傳 | 8 | 0 | ⏳ |
| 審核 | 8 | 0 | ⏳ |
| 發佈 | 8 | 0 | ⏳ |
| 訂閱 | 8 | 0 | ⏳ |
| 支付 | 8 | 0 | ⏳ |
| 激活 | 8 | 0 | ⏳ |
| 播放 | 8 | 0 | ⏳ |
| 取消 | 8 | 0 | ⏳ |
| 退款 | 8 | 0 | ⏳ |
| 重新訂閱 | 7 | 0 | ⏳ |
| **總計** | **103** | **0** | **⏳** |

### Phase 2: 性能測試

| 測試 | 目標 | 結果 | 狀態 |
|------|------|------|------|
| API 延遲 | <200ms | - | ⏳ |
| 併發 | 100+ | - | ⏳ |
| DB 優化 | <50ms | - | ⏳ |
| 緩存命中 | >80% | - | ⏳ |

### Phase 3: 安全測試

| 測試 | 項目 | 通過 | 狀態 |
|------|------|------|------|
| 認證 | 4 | 0 | ⏳ |
| 權限 | 4 | 0 | ⏳ |
| SQL 注入 | 4 | 0 | ⏳ |
| CORS | 4 | 0 | ⏳ |
| 其他 | 10 | 0 | ⏳ |
| **總計** | **26** | **0** | **⏳** |

### Phase 4: 部署前檢查

| 項目 | 檢查點 | 狀態 |
|------|--------|------|
| 灰度部署 | 6 | ⏳ |
| 生產環境 | 25 | ⏳ |
| 監控告警 | 15 | ⏳ |
| 回滾計劃 | 8 | ⏳ |

---

## 📈 成功標準

### 全部通過標準

```
✅ Phase 1: 103/103 業務場景測試通過
✅ Phase 2: 所有性能目標達成
✅ Phase 3: 26/26 安全測試通過
✅ Phase 4: 54 項部署前檢查完成

❌ Critical bugs: 0
❌ Major bugs: 0 (或修復確認)
❌ 無數據丟失
❌ 無安全漏洞
```

---

## 📞 聯絡和支持

- **QA 負責人**: Agent QA Engineer
- **開發負責人**: BACK 團隊
- **運維負責人**: DevOps 團隊
- **緊急問題**: 技術團隊群組

---

**開始測試: 2026-02-19 13:04 GMT+8**  
**預計完成: 2026-02-21**  
**狀態: 執行中**

