groups:
  # API 響應時間告警
  - name: api-performance
    interval: 30s
    rules:
      # API 響應時間過長
      - alert: HighAPILatency
        expr: |
          histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1.0
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "High API Latency detected"
          description: "API response time (p95) is {{ $value }}s on {{ $labels.instance }}"

      # API 錯誤率過高
      - alert: HighAPIErrorRate
        expr: |
          rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "High API Error Rate"
          description: "Error rate is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # API 吞吐量下降
      - alert: LowAPIThroughput
        expr: |
          rate(http_requests_total[5m]) < 10
        for: 10m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "Low API Throughput"
          description: "Request rate is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

  # 數據庫性能
  - name: database-performance
    interval: 30s
    rules:
      # 數據庫連接超載
      - alert: HighDBConnections
        expr: |
          pg_stat_activity_count > 80
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "High Database Connections"
          description: "Active connections: {{ $value }} on {{ $labels.instance }}"

      # 數據庫查詢性能下降
      - alert: SlowQueries
        expr: |
          rate(pg_slow_queries[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "Slow Queries Detected"
          description: "Slow query rate: {{ $value }}/sec on {{ $labels.instance }}"

      # 數據庫緩存命中率低
      - alert: LowCacheHitRatio
        expr: |
          rate(pg_stat_blks_hit[5m]) / (rate(pg_stat_blks_hit[5m]) + rate(pg_stat_blks_read[5m])) < 0.99
        for: 10m
        labels:
          severity: warning
          service: postgres
        annotations:
          summary: "Low Database Cache Hit Ratio"
          description: "Cache hit ratio: {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # 數據庫磁盤空間不足
      - alert: LowDiskSpace
        expr: |
          (pg_database_size_bytes / 1073741824) > 80
        for: 5m
        labels:
          severity: critical
          service: postgres
        annotations:
          summary: "Low Database Disk Space"
          description: "Database size: {{ $value | humanize }}GB on {{ $labels.instance }}"

  # Redis 性能
  - name: redis-performance
    interval: 30s
    rules:
      # Redis 記憶體使用率高
      - alert: HighRedisMemory
        expr: |
          redis_memory_used_bytes / redis_memory_max_bytes > 0.85
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "High Redis Memory Usage"
          description: "Memory usage: {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # Redis 命中率低
      - alert: LowRedisHitRate
        expr: |
          rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m])) < 0.8
        for: 10m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Low Redis Hit Rate"
          description: "Hit rate: {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # Redis 連接過多
      - alert: TooManyRedisConnections
        expr: |
          redis_connected_clients > 1000
        for: 5m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Too Many Redis Connections"
          description: "Connected clients: {{ $value }} on {{ $labels.instance }}"

      # Redis 伺服器宕機
      - alert: RedisDown
        expr: |
          up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis Server Down"
          description: "Redis instance is down on {{ $labels.instance }}"

  # 應用資源
  - name: application-resources
    interval: 30s
    rules:
      # CPU 使用率高
      - alert: HighCPUUsage
        expr: |
          rate(process_cpu_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          service: application
        annotations:
          summary: "High CPU Usage"
          description: "CPU usage: {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # 記憶體使用率高
      - alert: HighMemoryUsage
        expr: |
          process_resident_memory_bytes / (1024 * 1024) > 500
        for: 5m
        labels:
          severity: warning
          service: application
        annotations:
          summary: "High Memory Usage"
          description: "Memory usage: {{ $value }}MB on {{ $labels.instance }}"

      # 應用進程崩潰
      - alert: ApplicationDown
        expr: |
          up{job=~".*-service"} == 0
        for: 1m
        labels:
          severity: critical
          service: application
        annotations:
          summary: "Application Service Down"
          description: "Service {{ $labels.job }} is down on {{ $labels.instance }}"

      # 文件描述符接近限制
      - alert: HighFileDescriptors
        expr: |
          process_open_fds / process_max_fds > 0.8
        for: 5m
        labels:
          severity: warning
          service: application
        annotations:
          summary: "High File Descriptor Usage"
          description: "FD usage: {{ $value | humanizePercentage }} on {{ $labels.instance }}"

  # 容器監控
  - name: container-monitoring
    interval: 30s
    rules:
      # 容器記憶體使用率高
      - alert: HighContainerMemory
        expr: |
          (container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.85
        for: 5m
        labels:
          severity: warning
          service: container
        annotations:
          summary: "High Container Memory"
          description: "Memory usage: {{ $value | humanizePercentage }} for {{ $labels.container_name }}"

      # 容器 CPU 使用率高
      - alert: HighContainerCPU
        expr: |
          rate(container_cpu_usage_seconds_total[5m]) > 0.75
        for: 5m
        labels:
          severity: warning
          service: container
        annotations:
          summary: "High Container CPU"
          description: "CPU usage: {{ $value | humanizePercentage }} for {{ $labels.container_name }}"

  # 系統健康
  - name: system-health
    interval: 30s
    rules:
      # 節點宕機
      - alert: NodeDown
        expr: |
          up{job="node-exporter"} == 0
        for: 1m
        labels:
          severity: critical
          service: infrastructure
        annotations:
          summary: "Node Down"
          description: "Node {{ $labels.instance }} is down"

      # 磁盤空間不足
      - alert: LowDiskSpace
        expr: |
          (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.15
        for: 5m
        labels:
          severity: critical
          service: infrastructure
        annotations:
          summary: "Low Disk Space"
          description: "Disk space on {{ $labels.device }} is {{ $value | humanizePercentage }}"

      # 系統負載過高
      - alert: HighSystemLoad
        expr: |
          node_load15 > (count(node_cpu_seconds_total{mode="idle"}) by (instance) * 2)
        for: 10m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "High System Load"
          description: "System load (15m): {{ $value }} on {{ $labels.instance }}"

  # Recording Rules (用於性能優化)
  - name: recording-rules
    interval: 30s
    rules:
      # 平均 API 響應時間
      - record: api:request_latency:p50
        expr: |
          histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))

      - record: api:request_latency:p95
        expr: |
          histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

      - record: api:request_latency:p99
        expr: |
          histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))

      # API 吞吐量
      - record: api:requests:rate1m
        expr: |
          rate(http_requests_total[1m])

      - record: api:requests:rate5m
        expr: |
          rate(http_requests_total[5m])

      # API 錯誤率
      - record: api:errors:rate
        expr: |
          rate(http_requests_total{status=~"5.."}[5m])

      # 數據庫性能
      - record: db:query_latency:p95
        expr: |
          histogram_quantile(0.95, rate(pg_query_duration_seconds_bucket[5m]))

      # Redis 命中率
      - record: redis:hit_ratio
        expr: |
          rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))

      # 容器資源使用
      - record: container:memory_usage_percent
        expr: |
          (container_memory_usage_bytes / container_spec_memory_limit_bytes) * 100

      - record: container:cpu_usage_percent
        expr: |
          rate(container_cpu_usage_seconds_total[5m]) * 100
