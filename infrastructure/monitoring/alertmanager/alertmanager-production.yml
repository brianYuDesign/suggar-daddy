# Alertmanager é…ç½®æ–‡ä»¶ - ç”Ÿç”¢ç’°å¢ƒç‰ˆæœ¬
# Suggar Daddy ç›£æ§ç³»çµ±
# Version: 1.0.0

# å…¨å±€é…ç½®
global:
  # è§£æè¶…æ™‚
  resolve_timeout: 5m
  
  # Slack å…¨å±€é…ç½®
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  
  # SMTP é…ç½®ï¼ˆEmail é€šçŸ¥ï¼‰
  smtp_from: '${ALERT_EMAIL_FROM:-alerts@suggar-daddy.com}'
  smtp_smarthost: '${SMTP_HOST:-smtp.gmail.com:587}'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

# å‘Šè­¦æ¨¡æ¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  # é»˜èªæ¥æ”¶è€…
  receiver: 'default-notifications'
  
  # åˆ†çµ„æ¨™ç±¤ï¼ˆç›¸åŒæ¨™ç±¤çš„å‘Šè­¦æœƒè¢«åˆ†çµ„ï¼‰
  group_by: ['alertname', 'service', 'severity', 'category']
  
  # åˆ†çµ„ç­‰å¾…æ™‚é–“ï¼ˆæ”¶åˆ°ç¬¬ä¸€å€‹å‘Šè­¦å¾Œç­‰å¾…æ™‚é–“ï¼Œæ”¶é›†æ›´å¤šå‘Šè­¦ä¸€èµ·ç™¼é€ï¼‰
  group_wait: 10s
  
  # åˆ†çµ„é–“éš”ï¼ˆç›¸åŒåˆ†çµ„çš„å‘Šè­¦å¤šä¹…ç™¼é€ä¸€æ¬¡ï¼‰
  group_interval: 5m
  
  # é‡è¤‡å‘Šè­¦é–“éš”ï¼ˆå·²ç™¼é€çš„å‘Šè­¦å¤šä¹…å¾Œå†æ¬¡ç™¼é€ï¼‰
  repeat_interval: 4h

  # å­è·¯ç”±ï¼ˆæ ¹æ“šä¸åŒæ¢ä»¶è·¯ç”±åˆ°ä¸åŒæ¥æ”¶è€…ï¼‰
  routes:
    # ============================================
    # P0 Critical å‘Šè­¦ - ç«‹å³é€šçŸ¥æ‰€æœ‰æ¸ é“
    # ============================================
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      group_interval: 2m
      repeat_interval: 30m
      continue: false  # ä¸å†ç¹¼çºŒåŒ¹é…å…¶ä»–è·¯ç”±
      
      # Critical å‘Šè­¦çš„å­åˆ†é¡
      routes:
        # æœå‹™å®Œå…¨ä¸å¯ç”¨
        - match:
            category: availability
          receiver: 'critical-availability'
          group_wait: 5s
          repeat_interval: 15m
        
        # æ”¯ä»˜ç³»çµ±å‘Šè­¦
        - match:
            domain: payment
          receiver: 'critical-payment'
          group_wait: 5s
          repeat_interval: 15m
        
        # è³‡æ–™åº«å•é¡Œ
        - match:
            category: database
          receiver: 'critical-database'
          group_wait: 5s
          repeat_interval: 15m

    # ============================================
    # P1 Warning å‘Šè­¦ - é€šçŸ¥é–‹ç™¼åœ˜éšŠ
    # ============================================
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      group_interval: 10m
      repeat_interval: 2h
      
      routes:
        # æ•ˆèƒ½å•é¡Œ
        - match:
            category: performance
          receiver: 'performance-team'
        
        # è³‡æºä½¿ç”¨è­¦å‘Š
        - match:
            category: resources
          receiver: 'devops-team'
        
        # Rate Limiting è§¸ç™¼
        - match:
            alertname: 'RateLimitHit'
          receiver: 'security-team'
        
        # Circuit Breaker é–‹è·¯
        - match:
            alertname: 'CircuitBreakerOpen'
          receiver: 'backend-team'

    # ============================================
    # P2 Info å‘Šè­¦ - è¨˜éŒ„ç‚ºä¸»
    # ============================================
    - match:
        severity: info
      receiver: 'info-alerts'
      group_wait: 5m
      group_interval: 30m
      repeat_interval: 12h

    # ============================================
    # æ¥­å‹™æŒ‡æ¨™å‘Šè­¦
    # ============================================
    - match:
        category: business
      receiver: 'business-team'
      group_wait: 2m
      group_interval: 15m
      repeat_interval: 1h
      
      routes:
        # å­¤å…’äº¤æ˜“å‘Šè­¦
        - match:
            alertname: 'OrphanTransactionDetected'
          receiver: 'payment-ops-team'
          group_wait: 1m
          repeat_interval: 30m

# æŠ‘åˆ¶è¦å‰‡ï¼ˆç•¶æŸäº›å‘Šè­¦è§¸ç™¼æ™‚ï¼ŒæŠ‘åˆ¶å…¶ä»–ç›¸é—œå‘Šè­¦ï¼‰
inhibit_rules:
  # æœå‹™ä¸å¯ç”¨æ™‚ï¼ŒæŠ‘åˆ¶è©²æœå‹™çš„å…¶ä»–å‘Šè­¦
  - source_match:
      severity: 'critical'
      alertname: 'ServiceDown'
    target_match:
      severity: 'warning'
    equal: ['service']
  
  # Critical å‘Šè­¦è§¸ç™¼æ™‚ï¼ŒæŠ‘åˆ¶åŒæœå‹™çš„ Warning å‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service']
  
  # è³‡æ–™åº«ä¸å¯ç”¨æ™‚ï¼ŒæŠ‘åˆ¶æ‰€æœ‰æœå‹™çš„è³‡æ–™åº«é€£ç·šå‘Šè­¦
  - source_match:
      severity: 'critical'
      component: 'database'
    target_match:
      severity: 'warning'
    equal: ['component']
  
  # API Gateway ä¸å¯ç”¨æ™‚ï¼ŒæŠ‘åˆ¶å¾Œç«¯æœå‹™çš„å‘Šè­¦
  - source_match:
      severity: 'critical'
      service: 'api-gateway'
    target_match:
      severity: 'warning'
      component: 'backend'

# ============================================
# æ¥æ”¶è€…é…ç½® - ç”Ÿç”¢ç’°å¢ƒç‰ˆæœ¬
# ============================================
receivers:
  # é»˜èªæ¥æ”¶è€… - ç™¼é€åˆ°ä¸» Slack é »é“
  - name: 'default-notifications'
    slack_configs:
      - channel: '#alerts'
        title: 'ğŸ”” ç³»çµ±å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Service:* {{ .Labels.service }}
          *Severity:* {{ .Labels.severity }}
          *Description:* {{ .Annotations.description }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

  # ============================================
  # Critical å‘Šè­¦æ¥æ”¶è€…
  # ============================================
  
  # Critical ç¸½æ¥æ”¶è€… - æ‰€æœ‰æ¸ é“
  - name: 'critical-alerts'
    slack_configs:
      - channel: '#critical-alerts'
        username: 'Alertmanager Critical'
        icon_emoji: ':rotating_light:'
        title: 'ğŸš¨ CRITICAL ALERT ğŸš¨'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Service:* {{ .Labels.service }}
          *Severity:* {{ .Labels.severity }}
          *Category:* {{ .Labels.category }}
          *Priority:* {{ .Labels.priority }}
          
          *Description:* {{ .Annotations.description }}
          *Impact:* {{ .Annotations.impact }}
          *Action:* {{ .Annotations.action }}
          
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          *Duration:* {{ .StartsAt.Sub now }}
          {{ end }}
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
    
    email_configs:
      - to: '${CRITICAL_ALERT_EMAIL:-devops@suggar-daddy.com}'
        headers:
          Subject: '[CRITICAL] {{ .GroupLabels.alertname }} - {{ .GroupLabels.service }}'
        html: |
          <h2 style="color: red;">ğŸš¨ CRITICAL ALERT</h2>
          {{ range .Alerts }}
          <h3>{{ .Labels.alertname }}</h3>
          <ul>
            <li><strong>Service:</strong> {{ .Labels.service }}</li>
            <li><strong>Severity:</strong> {{ .Labels.severity }}</li>
            <li><strong>Category:</strong> {{ .Labels.category }}</li>
            <li><strong>Priority:</strong> {{ .Labels.priority }}</li>
          </ul>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Impact:</strong> {{ .Annotations.impact }}</p>
          <p><strong>Action Required:</strong></p>
          <pre>{{ .Annotations.action }}</pre>
          <p><strong>Started At:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
          {{ end }}
        send_resolved: true
  
  # Critical - å¯ç”¨æ€§å•é¡Œ
  - name: 'critical-availability'
    slack_configs:
      - channel: '#critical-availability'
        title: 'ğŸš¨ æœå‹™ä¸å¯ç”¨'
        text: |
          {{ range .Alerts }}
          *Service Down:* {{ .Labels.service }}
          *Instance:* {{ .Labels.instance }}
          *Since:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          âš ï¸ *ç«‹å³è™•ç†ï¼ç”¨æˆ¶ç„¡æ³•è¨ªå•æœå‹™*
          {{ end }}
        send_resolved: true
        color: 'danger'
    
    email_configs:
      - to: '${ON_CALL_EMAIL:-oncall@suggar-daddy.com}'
        headers:
          Subject: '[URGENT] Service Down - {{ .GroupLabels.service }}'
        send_resolved: true
  
  # Critical - æ”¯ä»˜ç³»çµ±
  - name: 'critical-payment'
    slack_configs:
      - channel: '#payment-alerts'
        title: 'ğŸ’³ æ”¯ä»˜ç³»çµ±å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Description:* {{ .Annotations.description }}
          *Impact:* ç›´æ¥å½±éŸ¿ç‡Ÿæ”¶ï¼Œè«‹ç«‹å³è™•ç†ï¼
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true
        color: 'danger'
    
    email_configs:
      - to: '${PAYMENT_TEAM_EMAIL:-payment-team@suggar-daddy.com}'
        headers:
          Subject: '[CRITICAL] Payment System Alert - {{ .GroupLabels.alertname }}'
        send_resolved: true
  
  # Critical - è³‡æ–™åº«
  - name: 'critical-database'
    slack_configs:
      - channel: '#database-alerts'
        title: 'ğŸ—„ï¸ è³‡æ–™åº«ç·Šæ€¥å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Database:* {{ .Labels.service }}
          *Description:* {{ .Annotations.description }}
          *Action:* {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
        color: 'danger'
    
    email_configs:
      - to: '${DBA_EMAIL:-dba@suggar-daddy.com}'
        headers:
          Subject: '[CRITICAL] Database Alert - {{ .GroupLabels.alertname }}'
        send_resolved: true

  # ============================================
  # Warning å‘Šè­¦æ¥æ”¶è€…
  # ============================================
  
  - name: 'warning-alerts'
    slack_configs:
      - channel: '#warnings'
        title: 'âš ï¸ Warning Alert'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Service:* {{ .Labels.service }}
          *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
        color: 'warning'
  
  # æ•ˆèƒ½åœ˜éšŠ
  - name: 'performance-team'
    slack_configs:
      - channel: '#performance'
        title: 'âš¡ æ•ˆèƒ½å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Service:* {{ .Labels.service }}
          *Description:* {{ .Annotations.description }}
          *Current Value:* {{ .Value }}
          {{ end }}
        send_resolved: true
  
  # DevOps åœ˜éšŠ
  - name: 'devops-team'
    slack_configs:
      - channel: '#devops'
        title: 'ğŸ”§ åŸºç¤è¨­æ–½å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Resource:* {{ .Labels.container }}
          *Description:* {{ .Annotations.description }}
          *Action:* {{ .Annotations.action }}
          {{ end }}
        send_resolved: true
  
  # å®‰å…¨åœ˜éšŠï¼ˆRate Limitingï¼‰
  - name: 'security-team'
    slack_configs:
      - channel: '#security'
        title: 'ğŸ”’ å®‰å…¨å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Description:* {{ .Annotations.description }}
          *IP:* {{ .Labels.ip }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true
  
  # å¾Œç«¯åœ˜éšŠï¼ˆCircuit Breakerï¼‰
  - name: 'backend-team'
    slack_configs:
      - channel: '#backend'
        title: 'âš¡ å¾Œç«¯æœå‹™å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Service:* {{ .Labels.service }}
          *Description:* {{ .Annotations.description }}
          *Action:* {{ .Annotations.action }}
          {{ end }}
        send_resolved: true

  # ============================================
  # Info å‘Šè­¦æ¥æ”¶è€…
  # ============================================
  
  - name: 'info-alerts'
    slack_configs:
      - channel: '#info-alerts'
        title: 'â„¹ï¸ Info Alert'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Service:* {{ .Labels.service }}
          *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
        color: '#439FE0'

  # ============================================
  # æ¥­å‹™æŒ‡æ¨™æ¥æ”¶è€…
  # ============================================
  
  - name: 'business-team'
    slack_configs:
      - channel: '#business-metrics'
        title: 'ğŸ“Š æ¥­å‹™æŒ‡æ¨™å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Description:* {{ .Annotations.description }}
          *Impact:* {{ .Annotations.impact }}
          {{ end }}
        send_resolved: true
    
    email_configs:
      - to: '${BUSINESS_TEAM_EMAIL:-business@suggar-daddy.com}'
        headers:
          Subject: '[Business Alert] {{ .GroupLabels.alertname }}'
        send_resolved: true
  
  # æ”¯ä»˜é‹ç‡Ÿåœ˜éšŠï¼ˆå­¤å…’äº¤æ˜“ï¼‰
  - name: 'payment-ops-team'
    slack_configs:
      - channel: '#payment-ops'
        title: 'ğŸ” å­¤å…’äº¤æ˜“å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Description:* {{ .Annotations.description }}
          *Count:* {{ .Value }}
          *Action:* è«‹æª¢æŸ¥å­¤å…’äº¤æ˜“è™•ç†å™¨é‹è¡Œç‹€æ…‹
          {{ end }}
        send_resolved: true
        color: 'warning'
    
    email_configs:
      - to: '${PAYMENT_OPS_EMAIL:-payment-ops@suggar-daddy.com}'
        headers:
          Subject: '[Payment Ops] Orphan Transaction Detected'
        send_resolved: true

# ============================================
# æ™‚é–“éœé»˜é…ç½®ï¼ˆå¯é¸ï¼‰
# ============================================
# ä¾‹å¦‚ï¼šåœ¨ç¶­è­·çª—å£æœŸé–“éœé»˜å‘Šè­¦
# time_intervals:
#   - name: maintenance_window
#     time_intervals:
#       - weekdays: ['saturday', 'sunday']
#         times:
#           - start_time: '02:00'
#             end_time: '04:00'
