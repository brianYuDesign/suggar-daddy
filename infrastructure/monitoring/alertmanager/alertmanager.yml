# Alertmanager é…ç½®æ–‡ä»¶
# Suggar Daddy ç›£æ§ç³»çµ±
# Version: 1.0.0

# å…¨å±€é…ç½®
global:
  # è§£æè¶…æ™‚
  resolve_timeout: 5m
  
  # SMTP é…ç½®ï¼ˆEmail é€šçŸ¥ï¼‰
  smtp_smarthost: '${SMTP_HOST:-smtp.gmail.com:587}'
  smtp_from: '${SMTP_FROM:-alertmanager@suggar-daddy.com}'
  smtp_auth_username: '${SMTP_USERNAME:-}'
  smtp_auth_password: '${SMTP_PASSWORD:-}'
  smtp_require_tls: true
  
  # Slack å…¨å±€é…ç½®
  slack_api_url: '${SLACK_WEBHOOK_URL:-}'

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  # é»˜èªæ¥æ”¶è€…
  receiver: 'default'
  
  # åˆ†çµ„æ¨™ç±¤ï¼ˆç›¸åŒæ¨™ç±¤çš„å‘Šè­¦æœƒè¢«åˆ†çµ„ï¼‰
  group_by: ['alertname', 'service', 'severity']
  
  # åˆ†çµ„ç­‰å¾…æ™‚é–“ï¼ˆæ”¶åˆ°ç¬¬ä¸€å€‹å‘Šè­¦å¾Œç­‰å¾…æ™‚é–“ï¼Œæ”¶é›†æ›´å¤šå‘Šè­¦ä¸€èµ·ç™¼é€ï¼‰
  group_wait: 10s
  
  # åˆ†çµ„é–“éš”ï¼ˆç›¸åŒåˆ†çµ„çš„å‘Šè­¦å¤šä¹…ç™¼é€ä¸€æ¬¡ï¼‰
  group_interval: 5m
  
  # é‡è¤‡å‘Šè­¦é–“éš”ï¼ˆå·²ç™¼é€çš„å‘Šè­¦å¤šä¹…å¾Œå†æ¬¡ç™¼é€ï¼‰
  repeat_interval: 4h

  # å­è·¯ç”±ï¼ˆæ ¹æ“šä¸åŒæ¢ä»¶è·¯ç”±åˆ°ä¸åŒæ¥æ”¶è€…ï¼‰
  routes:
    # ============================================
    # Critical å‘Šè­¦ï¼ˆP0ï¼‰- ç«‹å³é€šçŸ¥æ‰€æœ‰æ¸ é“
    # ============================================
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      group_interval: 2m
      repeat_interval: 30m
      continue: false
      routes:
        # æ”¯ä»˜ç›¸é—œ Critical å‘Šè­¦
        - match:
            category: business
            service: payment-service
          receiver: 'payment-critical'
          group_wait: 0s
        
        # è³‡æ–™åº« Critical å‘Šè­¦
        - match:
            category: database
          receiver: 'database-critical'

    # ============================================
    # Warning å‘Šè­¦ï¼ˆP1ï¼‰- é€šçŸ¥ Slack
    # ============================================
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      group_interval: 10m
      repeat_interval: 2h

    # ============================================
    # Info å‘Šè­¦ï¼ˆP2ï¼‰- åƒ…é€šçŸ¥ Slack
    # ============================================
    - match:
        severity: info
      receiver: 'info-alerts'
      group_wait: 5m
      group_interval: 30m
      repeat_interval: 12h

    # ============================================
    # æ¥­å‹™æŒ‡æ¨™å‘Šè­¦
    # ============================================
    - match:
        category: business
      receiver: 'business-alerts'
      group_wait: 1m
      repeat_interval: 1h

    # ============================================
    # ç›£æ§ç³»çµ±è‡ªèº«å‘Šè­¦
    # ============================================
    - match:
        category: monitoring
      receiver: 'monitoring-alerts'
      group_wait: 1m

# æŠ‘åˆ¶è¦å‰‡ï¼ˆç•¶æŸäº›å‘Šè­¦è§¸ç™¼æ™‚ï¼ŒæŠ‘åˆ¶å…¶ä»–ç›¸é—œå‘Šè­¦ï¼‰
inhibit_rules:
  # æœå‹™ä¸å¯ç”¨æ™‚ï¼ŒæŠ‘åˆ¶è©²æœå‹™çš„å…¶ä»–å‘Šè­¦
  - source_match:
      severity: 'critical'
      alertname: 'ServiceDown'
    target_match:
      severity: 'warning'
    equal: ['service']

  # Critical å‘Šè­¦è§¸ç™¼æ™‚ï¼ŒæŠ‘åˆ¶åŒæœå‹™çš„ Warning å‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service']

  # è³‡æ–™åº«ä¸å¯ç”¨æ™‚ï¼ŒæŠ‘åˆ¶è³‡æ–™åº«é€£ç·šç›¸é—œå‘Šè­¦
  - source_match:
      severity: 'critical'
      category: 'database'
    target_match:
      category: 'database'
    equal: ['instance']

  # å®¹å™¨å´©æ½°å¾ªç’°æ™‚ï¼ŒæŠ‘åˆ¶æ™®é€šé‡å•Ÿå‘Šè­¦
  - source_match:
      alertname: 'ContainerCrashLooping'
    target_match:
      alertname: 'ContainerRestartingFrequently'
    equal: ['container', 'pod']

# æ¥æ”¶è€…é…ç½®
receivers:
  # ============================================
  # é»˜èªæ¥æ”¶è€…
  # ============================================
  - name: 'default'
    slack_configs:
      - channel: '#alerts-general'
        title: 'ğŸ”” å‘Šè­¦é€šçŸ¥'
        text: |
          *å‘Šè­¦åç¨±:* {{ .GroupLabels.alertname }}
          *åš´é‡ç¨‹åº¦:* {{ .GroupLabels.severity }}
          *æœå‹™:* {{ .GroupLabels.service }}
          *è©³ç´°è³‡è¨Š:*
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
          {{ end }}

  # ============================================
  # Critical å‘Šè­¦ï¼ˆP0ï¼‰- å¤šæ¸ é“é€šçŸ¥
  # ============================================
  - name: 'critical-alerts'
    # Slack é€šçŸ¥
    slack_configs:
      - channel: '#alerts-critical'
        username: 'Alertmanager'
        icon_emoji: ':rotating_light:'
        title: 'ğŸš¨ CRITICAL ALERT'
        title_link: 'http://localhost:9093'
        color: 'danger'
        text: |
          *å‘Šè­¦:* {{ .GroupLabels.alertname }}
          *æœå‹™:* {{ .GroupLabels.service }}
          *å„ªå…ˆç´š:* P0 - éœ€è¦ç«‹å³è™•ç†
          
          *è©³ç´°è³‡è¨Š:*
          {{ range .Alerts }}
          ---
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Impact:* {{ .Annotations.impact }}
          *Action:* {{ .Annotations.action }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

    # Email é€šçŸ¥
    email_configs:
      - to: '${ALERT_EMAIL_TO:-devops@suggar-daddy.com}'
        headers:
          Subject: 'ğŸš¨ [CRITICAL] {{ .GroupLabels.alertname }} - {{ .GroupLabels.service }}'
        html: |
          <h2 style="color: red;">ğŸš¨ CRITICAL ALERT</h2>
          <table style="border-collapse: collapse; width: 100%;">
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><strong>å‘Šè­¦åç¨±</strong></td>
              <td style="border: 1px solid #ddd; padding: 8px;">{{ .GroupLabels.alertname }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><strong>æœå‹™</strong></td>
              <td style="border: 1px solid #ddd; padding: 8px;">{{ .GroupLabels.service }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;"><strong>åš´é‡ç¨‹åº¦</strong></td>
              <td style="border: 1px solid #ddd; padding: 8px;">{{ .GroupLabels.severity }}</td>
            </tr>
          </table>
          
          <h3>è©³ç´°è³‡è¨Š:</h3>
          {{ range .Alerts }}
          <div style="background: #f9f9f9; padding: 10px; margin: 10px 0; border-left: 4px solid red;">
            <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
            <p><strong>Description:</strong> {{ .Annotations.description }}</p>
            <p><strong>Impact:</strong> {{ .Annotations.impact }}</p>
            <p><strong>Action:</strong></p>
            <pre>{{ .Annotations.action }}</pre>
            <p><strong>æ™‚é–“:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
          </div>
          {{ end }}
        send_resolved: true

  # ============================================
  # æ”¯ä»˜ç³»çµ± Critical å‘Šè­¦
  # ============================================
  - name: 'payment-critical'
    slack_configs:
      - channel: '#alerts-payment'
        username: 'Payment Alert'
        icon_emoji: ':credit_card:'
        title: 'ğŸ’³ æ”¯ä»˜ç³»çµ±ç·Šæ€¥å‘Šè­¦'
        color: 'danger'
        text: |
          *âš ï¸ æ”¯ä»˜ç³»çµ±å‡ºç¾ Critical å•é¡Œï¼Œéœ€è¦ç«‹å³è™•ç†ï¼*
          
          *å‘Šè­¦:* {{ .GroupLabels.alertname }}
          *æœå‹™:* {{ .GroupLabels.service }}
          
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Impact:* {{ .Annotations.impact }}
          {{ end }}
          
          @channel è«‹ç«‹å³æª¢æŸ¥æ”¯ä»˜ç³»çµ±ï¼
        send_resolved: true

    email_configs:
      - to: '${PAYMENT_ALERT_EMAIL:-payment-team@suggar-daddy.com}'
        headers:
          Subject: 'ğŸ’³ [URGENT] Payment System Alert'

  # ============================================
  # è³‡æ–™åº« Critical å‘Šè­¦
  # ============================================
  - name: 'database-critical'
    slack_configs:
      - channel: '#alerts-database'
        username: 'Database Alert'
        icon_emoji: ':database:'
        title: 'ğŸ—„ï¸ è³‡æ–™åº«ç·Šæ€¥å‘Šè­¦'
        color: 'danger'
        text: |
          *âš ï¸ è³‡æ–™åº«å‡ºç¾ Critical å•é¡Œï¼*
          
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}
          
          @channel è«‹ç«‹å³æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹ï¼
        send_resolved: true

  # ============================================
  # Warning å‘Šè­¦ï¼ˆP1ï¼‰
  # ============================================
  - name: 'warning-alerts'
    slack_configs:
      - channel: '#alerts-warning'
        username: 'Alertmanager'
        icon_emoji: ':warning:'
        title: 'âš ï¸ WARNING ALERT'
        color: 'warning'
        text: |
          *å‘Šè­¦:* {{ .GroupLabels.alertname }}
          *æœå‹™:* {{ .GroupLabels.service }}
          
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true

  # ============================================
  # Info å‘Šè­¦ï¼ˆP2ï¼‰
  # ============================================
  - name: 'info-alerts'
    slack_configs:
      - channel: '#alerts-info'
        username: 'Alertmanager'
        icon_emoji: ':information_source:'
        title: 'â„¹ï¸ INFO ALERT'
        color: 'good'
        text: |
          *å‘Šè­¦:* {{ .GroupLabels.alertname }}
          *æœå‹™:* {{ .GroupLabels.service }}
          
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          {{ end }}
        send_resolved: false

  # ============================================
  # æ¥­å‹™æŒ‡æ¨™å‘Šè­¦
  # ============================================
  - name: 'business-alerts'
    slack_configs:
      - channel: '#alerts-business'
        username: 'Business Metrics'
        icon_emoji: ':chart_with_upwards_trend:'
        title: 'ğŸ“Š æ¥­å‹™æŒ‡æ¨™å‘Šè­¦'
        color: 'warning'
        text: |
          *å‘Šè­¦:* {{ .GroupLabels.alertname }}
          
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Impact:* {{ .Annotations.impact }}
          {{ end }}
        send_resolved: true

    email_configs:
      - to: '${BUSINESS_ALERT_EMAIL:-business@suggar-daddy.com}'
        headers:
          Subject: 'ğŸ“Š [æ¥­å‹™å‘Šè­¦] {{ .GroupLabels.alertname }}'

  # ============================================
  # ç›£æ§ç³»çµ±è‡ªèº«å‘Šè­¦
  # ============================================
  - name: 'monitoring-alerts'
    slack_configs:
      - channel: '#alerts-monitoring'
        username: 'Monitoring System'
        icon_emoji: ':mag:'
        title: 'ğŸ” ç›£æ§ç³»çµ±å‘Šè­¦'
        color: 'danger'
        text: |
          *âš ï¸ ç›£æ§ç³»çµ±æœ¬èº«å‡ºç¾å•é¡Œï¼*
          
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true

# ============================================
# æ¨¡æ¿é…ç½®ï¼ˆè‡ªå®šç¾©å‘Šè­¦æ ¼å¼ï¼‰
# ============================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'
