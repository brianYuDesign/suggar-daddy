# Prometheus å‘Šè­¦è¦å‰‡
# Suggar Daddy ç›£æ§ç³»çµ±
# Version: 2.0.0 - ç”Ÿç”¢ç’°å¢ƒå®Œæ•´ç‰ˆ

groups:
  # ============================================
  # æœå‹™å¯ç”¨æ€§å‘Šè­¦ï¼ˆCritical - P0ï¼‰
  # ============================================
  - name: service_availability
    interval: 30s
    rules:
      # æœå‹™å®•æ©Ÿ - æ ¸å¿ƒå‘Šè­¦
      - alert: ServiceDown
        expr: up{job=~".*-service|api-gateway"} == 0
        for: 1m
        labels:
          severity: critical
          category: availability
          priority: P0
        annotations:
          summary: "ğŸš¨ æœå‹™ {{ $labels.service }} å®•æ©Ÿ"
          description: "æœå‹™ {{ $labels.service }} å·²åœæ­¢éŸ¿æ‡‰è¶…é 1 åˆ†é˜\nå¯¦ä¾‹: {{ $labels.instance }}\nç•¶å‰ç‹€æ…‹: DOWN"
          impact: "ç”¨æˆ¶ç„¡æ³•è¨ªå•è©²æœå‹™çš„åŠŸèƒ½ï¼Œå¯èƒ½å°è‡´æ¥­å‹™ä¸­æ–·"
          action: "1. æª¢æŸ¥å®¹å™¨ç‹€æ…‹: docker ps | grep {{ $labels.service }}\n2. æŸ¥çœ‹æœå‹™æ—¥èªŒ: docker logs {{ $labels.service }}\n3. æª¢æŸ¥è³‡æºä½¿ç”¨æƒ…æ³\n4. ç¢ºèªæ˜¯å¦éœ€è¦é‡å•Ÿæœå‹™"
          runbook_url: "https://wiki.suggar-daddy.com/runbooks/service-down"

      # æœå‹™éƒ¨åˆ†å¯¦ä¾‹ä¸å¯ç”¨
      - alert: ServicePartiallyDown
        expr: |
          (count by (job) (up{job=~".*-service|api-gateway"} == 0) 
          / count by (job) (up{job=~".*-service|api-gateway"})) > 0.3
        for: 2m
        labels:
          severity: warning
          category: availability
          priority: P1
        annotations:
          summary: "âš ï¸ æœå‹™ {{ $labels.job }} éƒ¨åˆ†å¯¦ä¾‹ä¸å¯ç”¨"
          description: "è¶…é 30% çš„æœå‹™å¯¦ä¾‹ä¸å¯ç”¨ï¼Œå¯èƒ½å½±éŸ¿æœå‹™å“è³ª"
          impact: "æœå‹™å®¹é‡ä¸‹é™ï¼Œå¯èƒ½å°è‡´éŸ¿æ‡‰è®Šæ…¢æˆ–éƒ¨åˆ†è«‹æ±‚å¤±æ•—"
          action: "1. æª¢æŸ¥ä¸å¯ç”¨å¯¦ä¾‹çš„ç‹€æ…‹\n2. ç¢ºèªæ˜¯å¦éœ€è¦æ“´å®¹\n3. æŸ¥çœ‹è² è¼‰å‡è¡¡å™¨ç‹€æ…‹"

      # æœå‹™å•Ÿå‹•æ™‚é–“éé•·
      - alert: ServiceStartupTooSlow
        expr: |
          time() - process_start_time_seconds{job=~".*-service|api-gateway"} < 300
          and up{job=~".*-service|api-gateway"} == 1
        for: 5m
        labels:
          severity: info
          category: availability
          priority: P2
        annotations:
          summary: "æœå‹™ {{ $labels.service }} å‰›å‰›å•Ÿå‹•"
          description: "æœå‹™åœ¨éå» 5 åˆ†é˜å…§å•Ÿå‹•æˆ–é‡å•Ÿ"
          impact: "å¯èƒ½æ˜¯æ­£å¸¸çš„éƒ¨ç½²æˆ–ç•°å¸¸é‡å•Ÿ"
          action: "ç¢ºèªæ˜¯å¦ç‚ºè¨ˆåŠƒä¸­çš„éƒ¨ç½²ï¼Œå¦‚æœä¸æ˜¯è«‹æª¢æŸ¥é‡å•ŸåŸå› "

  # ============================================
  # éŒ¯èª¤ç‡å‘Šè­¦ï¼ˆCritical - P0ï¼‰
  # ============================================
  - name: error_rate
    interval: 1m
    rules:
      # é«˜éŒ¯èª¤ç‡ > 1%ï¼ˆæ ¸å¿ƒéœ€æ±‚ï¼‰
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
            / 
            sum(rate(http_requests_total[5m])) by (service)
          ) > 0.01
        for: 2m
        labels:
          severity: critical
          category: errors
          priority: P0
        annotations:
          summary: "ğŸš¨ æœå‹™ {{ $labels.service }} éŒ¯èª¤ç‡éé«˜ (>1%)"
          description: "æœå‹™ {{ $labels.service }} çš„ 5xx éŒ¯èª¤ç‡è¶…é 1%\nç•¶å‰éŒ¯èª¤ç‡: {{ $value | humanizePercentage }}"
          impact: "å¤§é‡ç”¨æˆ¶è«‹æ±‚å¤±æ•—ï¼Œç”¨æˆ¶é«”é©—åš´é‡ä¸‹é™ï¼Œå¯èƒ½å°è‡´ç”¨æˆ¶æµå¤±"
          action: "1. ç«‹å³æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒ: kubectl logs -f deployment/{{ $labels.service }}\n2. æª¢æŸ¥è³‡æ–™åº«é€£ç·šç‹€æ…‹\n3. æª¢æŸ¥ä¾è³´æœå‹™æ˜¯å¦æ­£å¸¸\n4. è€ƒæ…®å›æ»¾æœ€è¿‘çš„éƒ¨ç½²"
          dashboard_url: "http://localhost:3001/d/errors/error-rate-dashboard?var-service={{ $labels.service }}"

      # éŒ¯èª¤ç‡ > 0.1%ï¼ˆæ—©æœŸé è­¦ï¼‰
      - alert: ElevatedErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
            / 
            sum(rate(http_requests_total[5m])) by (service)
          ) > 0.001
        for: 5m
        labels:
          severity: warning
          category: errors
          priority: P1
        annotations:
          summary: "âš ï¸ æœå‹™ {{ $labels.service }} éŒ¯èª¤ç‡å‡é«˜"
          description: "æœå‹™ {{ $labels.service }} çš„ 5xx éŒ¯èª¤ç‡è¶…é 0.1%\nç•¶å‰éŒ¯èª¤ç‡: {{ $value | humanizePercentage }}"
          impact: "éŒ¯èª¤ç‡ç•°å¸¸ï¼Œéœ€è¦é—œæ³¨æ˜¯å¦æŒçºŒä¸Šå‡"
          action: "1. æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒ\n2. æª¢æŸ¥æœ€è¿‘çš„éƒ¨ç½²è®Šæ›´\n3. ç›£æ§æ˜¯å¦æŒçºŒå‡é«˜"

      # éŒ¯èª¤ç‡æš´å¢ï¼ˆçŸ­æœŸå…§å¤§å¹…ä¸Šå‡ï¼‰
      - alert: ErrorRateSpike
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[1m])) by (service)
            / 
            sum(rate(http_requests_total[1m])) by (service)
          ) > 0.05
        for: 1m
        labels:
          severity: critical
          category: errors
          priority: P0
        annotations:
          summary: "ğŸš¨ æœå‹™ {{ $labels.service }} éŒ¯èª¤ç‡æš´å¢"
          description: "éŒ¯èª¤ç‡åœ¨çŸ­æ™‚é–“å…§æ€¥åŠ‡ä¸Šå‡è¶…é 5%"
          impact: "å¯èƒ½æ˜¯åš´é‡çš„ç³»çµ±å•é¡Œæˆ–æ”»æ“Š"
          action: "ç«‹å³èª¿æŸ¥ï¼Œå¯èƒ½éœ€è¦å•Ÿå‹•æ‡‰æ€¥éŸ¿æ‡‰æµç¨‹"

      # 4xx éŒ¯èª¤ç‡ç•°å¸¸
      - alert: High4xxRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"4.."}[5m])) by (service)
            / 
            sum(rate(http_requests_total[5m])) by (service)
          ) > 0.1
        for: 10m
        labels:
          severity: warning
          category: client_errors
          priority: P2
        annotations:
          summary: "âš ï¸ æœå‹™ {{ $labels.service }} å®¢æˆ¶ç«¯éŒ¯èª¤ç‡éé«˜"
          description: "4xx éŒ¯èª¤ç‡è¶…é 10%ï¼Œå¯èƒ½æ˜¯ API ä½¿ç”¨ä¸ç•¶æˆ–æ–‡æª”å•é¡Œ\nç•¶å‰éŒ¯èª¤ç‡: {{ $value | humanizePercentage }}"
          impact: "å¯èƒ½å½±éŸ¿ç”¨æˆ¶é«”é©—æˆ–è¡¨ç¤º API è®Šæ›´æœªé€šçŸ¥å®¢æˆ¶ç«¯"
          action: "1. åˆ†æ 4xx éŒ¯èª¤çš„é¡å‹åˆ†å¸ƒ\n2. æª¢æŸ¥æ˜¯å¦æœ‰ API è®Šæ›´\n3. æ›´æ–° API æ–‡æª”"

  # ============================================
  # API å»¶é²å‘Šè­¦ï¼ˆCritical - P0ï¼‰
  # ============================================
  - name: api_latency
    interval: 1m
    rules:
      # P95 å»¶é² > 1000msï¼ˆæ ¸å¿ƒéœ€æ±‚ï¼‰
      - alert: HighP95Latency
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
          ) > 1
        for: 3m
        labels:
          severity: critical
          category: performance
          priority: P0
        annotations:
          summary: "ğŸš¨ æœå‹™ {{ $labels.service }} P95 éŸ¿æ‡‰æ™‚é–“éé«˜ (>1000ms)"
          description: "P95 å»¶é²è¶…é 1000ms\nç•¶å‰ P95: {{ $value | humanizeDuration }}"
          impact: "ç”¨æˆ¶é«”é©—åš´é‡ä¸‹é™ï¼Œé é¢è¼‰å…¥ç·©æ…¢ï¼Œå¯èƒ½å°è‡´ç”¨æˆ¶æµå¤±"
          action: "1. æª¢æŸ¥è³‡æ–™åº«æŸ¥è©¢æ•ˆèƒ½\n2. æª¢æŸ¥å¤–éƒ¨ API èª¿ç”¨\n3. åˆ†ææ…¢è«‹æ±‚æ—¥èªŒ\n4. è€ƒæ…®å•Ÿç”¨å¿«å–æˆ–å¢åŠ è³‡æº"
          dashboard_url: "http://localhost:3001/d/latency/latency-dashboard?var-service={{ $labels.service }}"

      # P95 å»¶é² > 500msï¼ˆæ—©æœŸé è­¦ï¼‰
      - alert: ElevatedP95Latency
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          category: performance
          priority: P1
        annotations:
          summary: "âš ï¸ æœå‹™ {{ $labels.service }} P95 éŸ¿æ‡‰æ™‚é–“å‡é«˜ (>500ms)"
          description: "P95 å»¶é²è¶…é 500ms\nç•¶å‰ P95: {{ $value | humanizeDuration }}"
          impact: "ç”¨æˆ¶é«”é©—ä¸‹é™ï¼Œéœ€è¦é—œæ³¨æ˜¯å¦æŒçºŒæƒ¡åŒ–"
          action: "1. æª¢æŸ¥è³‡æ–™åº«æ…¢æŸ¥è©¢\n2. åˆ†æè«‹æ±‚æ¨¡å¼\n3. ç›£æ§è¶¨å‹¢"

      # P99 å»¶é² > 2s
      - alert: HighP99Latency
        expr: |
          histogram_quantile(0.99,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
          ) > 2
        for: 3m
        labels:
          severity: critical
          category: performance
          priority: P0
        annotations:
          summary: "ğŸš¨ æœå‹™ {{ $labels.service }} P99 éŸ¿æ‡‰æ™‚é–“éé«˜ (>2s)"
          description: "P99 å»¶é²è¶…é 2 ç§’\nç•¶å‰ P99: {{ $value | humanizeDuration }}"
          impact: "æœ€æ…¢çš„ 1% è«‹æ±‚éŸ¿æ‡‰æ¥µæ…¢ï¼Œåš´é‡å½±éŸ¿ç”¨æˆ¶é«”é©—"
          action: "1. æ‰¾å‡ºæœ€æ…¢çš„ç«¯é»\n2. æª¢æŸ¥æ˜¯å¦æœ‰è¶…æ™‚é…ç½®å•é¡Œ\n3. å„ªåŒ–æ…¢æŸ¥è©¢"

      # å¹³å‡å»¶é² > 200ms
      - alert: HighAverageLatency
        expr: |
          sum(rate(http_request_duration_seconds_sum[5m])) by (service)
          /
          sum(rate(http_request_duration_seconds_count[5m])) by (service)
          > 0.2
        for: 10m
        labels:
          severity: info
          category: performance
          priority: P2
        annotations:
          summary: "â„¹ï¸ æœå‹™ {{ $labels.service }} å¹³å‡å»¶é²å‡é«˜"
          description: "å¹³å‡å»¶é²è¶…é 200ms\nç•¶å‰å€¼: {{ $value | humanizeDuration }}"
          impact: "æ•´é«”æ•ˆèƒ½ä¸‹é™"
          action: "æŒçºŒç›£æ§ï¼Œè©•ä¼°æ˜¯å¦éœ€è¦å„ªåŒ–"

  # ============================================
  # è³‡æ–™åº«å‘Šè­¦ï¼ˆCritical - P0ï¼‰
  # ============================================
  - name: database
    interval: 1m
    rules:
      # è³‡æ–™åº«é€£ç·šæ± è€—ç›¡ï¼ˆæ ¸å¿ƒéœ€æ±‚ï¼‰
      - alert: DatabaseConnectionPoolExhausted
        expr: |
          (
            pg_stat_database_numbackends{datname="suggar_daddy"}
            /
            pg_settings_max_connections
          ) > 0.9
        for: 1m
        labels:
          severity: critical
          category: database
          priority: P0
        annotations:
          summary: "ğŸš¨ è³‡æ–™åº«é€£ç·šæ± å³å°‡è€—ç›¡"
          description: "PostgreSQL é€£ç·šä½¿ç”¨ç‡è¶…é 90%\nç•¶å‰ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}\nç•¶å‰é€£ç·šæ•¸: {{ $labels.pg_stat_database_numbackends }}"
          impact: "æ–°é€£ç·šå°‡è¢«æ‹’çµ•ï¼Œæœå‹™å¯èƒ½å®Œå…¨ä¸å¯ç”¨ï¼Œå°è‡´ç³»çµ±ç™±ç˜“"
          action: "1. ç«‹å³æª¢æŸ¥é•·æ™‚é–“åŸ·è¡Œçš„æŸ¥è©¢\n2. æª¢æŸ¥é€£ç·šæ± æ´©æ¼\n3. è‡¨æ™‚å¢åŠ æœ€å¤§é€£ç·šæ•¸\n4. è€ƒæ…®é‡å•Ÿé€£ç·šæ± "
          runbook_url: "https://wiki.suggar-daddy.com/runbooks/db-connection-pool"

      # PostgreSQL é€£ç·šæ•¸ > 80%
      - alert: PostgresHighConnections
        expr: |
          (
            pg_stat_database_numbackends{datname="suggar_daddy"}
            /
            pg_settings_max_connections
          ) > 0.8
        for: 5m
        labels:
          severity: warning
          category: database
          priority: P1
        annotations:
          summary: "âš ï¸ PostgreSQL é€£ç·šæ•¸éé«˜"
          description: "é€£ç·šä½¿ç”¨ç‡: {{ $value | humanizePercentage }}"
          action: "1. æª¢æŸ¥é€£ç·šæ± é…ç½®\n2. æŸ¥æ‰¾é•·æ™‚é–“åŸ·è¡Œçš„æŸ¥è©¢\n3. è€ƒæ…®å¢åŠ æœ€å¤§é€£ç·šæ•¸"

      # PostgreSQL é€£ç·šæ•¸ > 95%
      - alert: PostgresCriticalConnections
        expr: |
          (
            pg_stat_database_numbackends{datname="suggar_daddy"}
            /
            pg_settings_max_connections
          ) > 0.95
        for: 2m
        labels:
          severity: critical
          category: database
          priority: P0
        annotations:
          summary: "ğŸš¨ PostgreSQL é€£ç·šæ•¸å±éšª"
          description: "é€£ç·šæ± å³å°‡è€—ç›¡ï¼Œæ–°é€£ç·šå¯èƒ½è¢«æ‹’çµ•"
          impact: "ç³»çµ±å¯èƒ½å®Œå…¨ä¸å¯ç”¨"
          action: "ç·Šæ€¥è™•ç†ï¼Œç«‹å³å¢åŠ é€£ç·šæ•¸é™åˆ¶æˆ–é‡å•Ÿæœå‹™"

      # è³‡æ–™åº«è¤‡è£½å»¶é²éé«˜
      - alert: PostgresReplicationLag
        expr: pg_replication_lag_seconds > 60
        for: 5m
        labels:
          severity: warning
          category: database
          priority: P1
        annotations:
          summary: "âš ï¸ PostgreSQL è¤‡è£½å»¶é²éé«˜"
          description: "è¤‡è£½å»¶é²: {{ $value | humanizeDuration }}"
          impact: "è®€å–å‰¯æœ¬æ•¸æ“šå¯èƒ½éæœŸ"
          action: "1. æª¢æŸ¥è¤‡è£½ç‹€æ…‹\n2. æª¢æŸ¥ç¶²è·¯å»¶é²\n3. è€ƒæ…®å¢åŠ è¤‡è£½è³‡æº"

      # è³‡æ–™åº«äº¤æ˜“ ID å³å°‡è€—ç›¡
      - alert: PostgresXIDWraparound
        expr: |
          pg_database_datfrozenxid{datname="suggar_daddy"} > 1500000000
        for: 5m
        labels:
          severity: critical
          category: database
          priority: P0
        annotations:
          summary: "ğŸš¨ PostgreSQL XID å³å°‡è€—ç›¡"
          description: "æ•¸æ“šåº«éœ€è¦ç·Šæ€¥ vacuum"
          impact: "æ•¸æ“šåº«å°‡åœæ­¢æ¥å—å¯«å…¥"
          action: "ç«‹å³åŸ·è¡Œ vacuum freeze"

      # æ…¢æŸ¥è©¢éå¤š
      - alert: PostgresSlowQueries
        expr: |
          rate(pg_stat_statements_total{query_time="slow"}[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: database
          priority: P1
        annotations:
          summary: "âš ï¸ PostgreSQL æ…¢æŸ¥è©¢éå¤š"
          description: "æ¯ç§’è¶…é 10 å€‹æ…¢æŸ¥è©¢"
          impact: "æ•¸æ“šåº«æ•ˆèƒ½ä¸‹é™ï¼Œå½±éŸ¿æ•´é«”ç³»çµ±"
          action: "1. æª¢æŸ¥æ…¢æŸ¥è©¢æ—¥èªŒ\n2. å„ªåŒ–ç´¢å¼•\n3. å„ªåŒ–æŸ¥è©¢èªå¥"

  # ============================================
  # Redis å‘Šè­¦ï¼ˆCritical - P0ï¼‰
  # ============================================
  - name: redis
    interval: 1m
    rules:
      # Redis è¨˜æ†¶é«”ä¸è¶³ï¼ˆæ ¸å¿ƒéœ€æ±‚ï¼‰
      - alert: RedisMemoryCritical
        expr: |
          (
            redis_memory_used_bytes
            /
            redis_memory_max_bytes
          ) > 0.9
        for: 2m
        labels:
          severity: critical
          category: cache
          priority: P0
        annotations:
          summary: "ğŸš¨ Redis è¨˜æ†¶é«”åš´é‡ä¸è¶³"
          description: "Redis è¨˜æ†¶é«”ä½¿ç”¨ç‡è¶…é 90%\nç•¶å‰ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}\nå·²ä½¿ç”¨: {{ humanize1024 $labels.redis_memory_used_bytes }}B"
          impact: "å³å°‡è§¸ç™¼è¨˜æ†¶é«”æ·˜æ±°ç­–ç•¥ï¼Œå¯èƒ½å°è‡´å¿«å–å‘½ä¸­ç‡ä¸‹é™ï¼Œè³‡æ–™åº«å£“åŠ›å¢åŠ "
          action: "1. ç«‹å³æª¢æŸ¥å¿«å–ç­–ç•¥\n2. è€ƒæ…®å¢åŠ  Redis è¨˜æ†¶é«”\n3. æ¸…ç†ä¸å¿…è¦çš„å¿«å–\n4. è©•ä¼°æ˜¯å¦éœ€è¦åˆ†ç‰‡"
          runbook_url: "https://wiki.suggar-daddy.com/runbooks/redis-memory"

      # Redis è¨˜æ†¶é«”ä½¿ç”¨ç‡ > 80%
      - alert: RedisHighMemory
        expr: |
          (
            redis_memory_used_bytes
            /
            redis_memory_max_bytes
          ) > 0.8
        for: 5m
        labels:
          severity: warning
          category: cache
          priority: P1
        annotations:
          summary: "âš ï¸ Redis è¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜"
          description: "è¨˜æ†¶é«”ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}"
          action: "1. æª¢æŸ¥å¿«å–éæœŸç­–ç•¥\n2. ç›£æ§è¨˜æ†¶é«”å¢é•·è¶¨å‹¢\n3. æº–å‚™æ“´å®¹è¨ˆåŠƒ"

      # Redis é€£ç·šæ•¸ç•°å¸¸
      - alert: RedisHighConnections
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: warning
          category: cache
          priority: P2
        annotations:
          summary: "âš ï¸ Redis é€£ç·šæ•¸ç•°å¸¸"
          description: "ç•¶å‰é€£ç·šæ•¸: {{ $value }}"
          action: "1. æª¢æŸ¥é€£ç·šæ± é…ç½®\n2. æª¢æŸ¥æ˜¯å¦æœ‰é€£ç·šæ´©æ¼"

      # Redis å‘½ä¸­ç‡ä½
      - alert: RedisLowHitRate
        expr: |
          (
            rate(redis_keyspace_hits_total[5m])
            /
            (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))
          ) < 0.8
        for: 15m
        labels:
          severity: info
          category: cache
          priority: P2
        annotations:
          summary: "â„¹ï¸ Redis å¿«å–å‘½ä¸­ç‡ä½"
          description: "å‘½ä¸­ç‡: {{ $value | humanizePercentage }}"
          action: "å¯èƒ½éœ€è¦å„ªåŒ–å¿«å–ç­–ç•¥æˆ–å¢åŠ å¿«å–å®¹é‡"

      # Redis æŒä¹…åŒ–å¤±æ•—
      - alert: RedisPersistenceFailed
        expr: redis_rdb_last_save_status != 1
        for: 5m
        labels:
          severity: warning
          category: cache
          priority: P1
        annotations:
          summary: "âš ï¸ Redis æŒä¹…åŒ–å¤±æ•—"
          description: "RDB æŒä¹…åŒ–å¤±æ•—"
          impact: "æ•¸æ“šå¯èƒ½éºå¤±"
          action: "æª¢æŸ¥ç£ç¢Ÿç©ºé–“å’Œæ¬Šé™"

  # ============================================
  # Kafka å‘Šè­¦ï¼ˆCritical - P0ï¼‰
  # ============================================
  - name: kafka
    interval: 1m
    rules:
      # Kafka Consumer Lag éé«˜ï¼ˆæ ¸å¿ƒéœ€æ±‚ï¼‰
      - alert: KafkaConsumerLagHigh
        expr: |
          kafka_consumer_group_lag{group=~"suggar-daddy-.*"} > 10000
        for: 5m
        labels:
          severity: critical
          category: messaging
          priority: P0
        annotations:
          summary: "ğŸš¨ Kafka Consumer Lag éé«˜"
          description: "Consumer Group {{ $labels.group }} çš„ Topic {{ $labels.topic }} Lag è¶…é 10,000\nç•¶å‰ Lag: {{ $value }}"
          impact: "æ¶ˆæ¯è™•ç†åš´é‡å»¶é²ï¼Œå¯èƒ½å°è‡´æ•¸æ“šä¸ä¸€è‡´ï¼Œå¯¦æ™‚åŠŸèƒ½å¤±æ•ˆ"
          action: "1. æª¢æŸ¥æ¶ˆè²»è€…æ˜¯å¦æ­£å¸¸é‹è¡Œ\n2. æª¢æŸ¥æ¶ˆè²»è€…è™•ç†é€Ÿåº¦\n3. è€ƒæ…®å¢åŠ æ¶ˆè²»è€…å¯¦ä¾‹\n4. æª¢æŸ¥æ˜¯å¦æœ‰æ¶ˆè²»è€…å¡æ­»"
          dashboard_url: "http://localhost:3001/d/kafka/kafka-dashboard"

      # Kafka Consumer Lag è­¦å‘Š
      - alert: KafkaConsumerLagWarning
        expr: |
          kafka_consumer_group_lag{group=~"suggar-daddy-.*"} > 1000
        for: 10m
        labels:
          severity: warning
          category: messaging
          priority: P1
        annotations:
          summary: "âš ï¸ Kafka Consumer Lag å‡é«˜"
          description: "Consumer Group {{ $labels.group }} çš„ Lag è¶…é 1,000\nç•¶å‰ Lag: {{ $value }}"
          action: "1. ç›£æ§æ¶ˆè²»è€…è™•ç†é€Ÿåº¦\n2. æª¢æŸ¥æ˜¯å¦æœ‰è™•ç†ç“¶é ¸"

      # Kafka Broker ä¸å¯ç”¨
      - alert: KafkaBrokerDown
        expr: up{job="kafka"} == 0
        for: 1m
        labels:
          severity: critical
          category: messaging
          priority: P0
        annotations:
          summary: "ğŸš¨ Kafka Broker ä¸å¯ç”¨"
          description: "Kafka Broker åœæ­¢éŸ¿æ‡‰"
          impact: "æ¶ˆæ¯ä½‡åˆ—æœå‹™ä¸­æ–·ï¼Œç•°æ­¥è™•ç†åŠŸèƒ½å¤±æ•ˆ"
          action: "1. æª¢æŸ¥ Kafka å®¹å™¨ç‹€æ…‹\n2. æª¢æŸ¥ Zookeeper ç‹€æ…‹\n3. æª¢æŸ¥ç£ç¢Ÿç©ºé–“"

      # Kafka ç£ç¢Ÿä½¿ç”¨ç‡éé«˜
      - alert: KafkaDiskUsageHigh
        expr: |
          (
            kafka_log_size
            /
            kafka_log_capacity
          ) > 0.85
        for: 5m
        labels:
          severity: warning
          category: messaging
          priority: P1
        annotations:
          summary: "âš ï¸ Kafka ç£ç¢Ÿä½¿ç”¨ç‡éé«˜"
          description: "ç£ç¢Ÿä½¿ç”¨ç‡: {{ $value | humanizePercentage }}"
          action: "1. èª¿æ•´ retention ç­–ç•¥\n2. å¢åŠ ç£ç¢Ÿç©ºé–“\n3. æ¸…ç†èˆŠæ•¸æ“š"

      # Kafka è«‹æ±‚è™•ç†æ™‚é–“éé•·
      - alert: KafkaRequestLatencyHigh
        expr: |
          histogram_quantile(0.99,
            sum(rate(kafka_network_request_metrics_time_ms_bucket[5m])) by (le, request)
          ) > 500
        for: 5m
        labels:
          severity: warning
          category: messaging
          priority: P1
        annotations:
          summary: "âš ï¸ Kafka è«‹æ±‚å»¶é²éé«˜"
          description: "P99 è«‹æ±‚å»¶é²è¶…é 500ms"
          action: "1. æª¢æŸ¥ Kafka è² è¼‰\n2. æª¢æŸ¥ç£ç¢Ÿ I/O\n3. è€ƒæ…®å¢åŠ åˆ†å€"

  # ============================================
  # ç³»çµ±è³‡æºå‘Šè­¦
  # ============================================
  - name: system_resources
    interval: 1m
    rules:
      # CPU ä½¿ç”¨ç‡ > 80%
      - alert: HighCPUUsage
        expr: |
          (
            rate(container_cpu_usage_seconds_total{container!=""}[5m])
            /
            (container_spec_cpu_quota{container!=""} / 100000)
          ) > 0.8
        for: 5m
        labels:
          severity: warning
          category: resources
          priority: P1
        annotations:
          summary: "âš ï¸ å®¹å™¨ {{ $labels.container }} CPU ä½¿ç”¨ç‡éé«˜"
          description: "CPU ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}"
          action: "1. æª¢æŸ¥æ˜¯å¦æœ‰ CPU å¯†é›†å‹æ“ä½œ\n2. è€ƒæ…®æ“´å±•å¯¦ä¾‹\n3. å„ªåŒ–ç¨‹å¼ç¢¼æ•ˆèƒ½"

      # CPU ä½¿ç”¨ç‡ > 90%ï¼ˆCriticalï¼‰
      - alert: CriticalCPUUsage
        expr: |
          (
            rate(container_cpu_usage_seconds_total{container!=""}[5m])
            /
            (container_spec_cpu_quota{container!=""} / 100000)
          ) > 0.9
        for: 2m
        labels:
          severity: critical
          category: resources
          priority: P0
        annotations:
          summary: "ğŸš¨ å®¹å™¨ {{ $labels.container }} CPU ä½¿ç”¨ç‡å±éšª"
          description: "CPU ä½¿ç”¨ç‡è¶…é 90%ï¼Œæœå‹™å¯èƒ½å—åˆ°å½±éŸ¿"
          action: "ç«‹å³æ“´å®¹æˆ–å„ªåŒ–"

      # è¨˜æ†¶é«”ä½¿ç”¨ç‡ > 80%
      - alert: HighMemoryUsage
        expr: |
          (
            container_memory_working_set_bytes{container!=""}
            /
            container_spec_memory_limit_bytes{container!=""} 
          ) > 0.8
        for: 5m
        labels:
          severity: warning
          category: resources
          priority: P1
        annotations:
          summary: "âš ï¸ å®¹å™¨ {{ $labels.container }} è¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜"
          description: "è¨˜æ†¶é«”ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}"
          action: "1. æª¢æŸ¥è¨˜æ†¶é«”æ´©æ¼\n2. æª¢æŸ¥å¿«å–å¤§å°\n3. è€ƒæ…®å¢åŠ è¨˜æ†¶é«”é™åˆ¶"

      # è¨˜æ†¶é«”ä½¿ç”¨ç‡ > 90%ï¼ˆCriticalï¼‰
      - alert: CriticalMemoryUsage
        expr: |
          (
            container_memory_working_set_bytes{container!=""}
            /
            container_spec_memory_limit_bytes{container!=""} 
          ) > 0.9
        for: 2m
        labels:
          severity: critical
          category: resources
          priority: P0
        annotations:
          summary: "ğŸš¨ å®¹å™¨ {{ $labels.container }} è¨˜æ†¶é«”ä½¿ç”¨ç‡å±éšª"
          description: "è¨˜æ†¶é«”ä½¿ç”¨ç‡è¶…é 90%ï¼Œå¯èƒ½ç™¼ç”Ÿ OOM"
          action: "ç·Šæ€¥è™•ç†ï¼Œå¢åŠ è¨˜æ†¶é«”æˆ–é‡å•Ÿæœå‹™"

      # ç£ç¢Ÿä½¿ç”¨ç‡ > 85%
      - alert: HighDiskUsage
        expr: |
          (
            node_filesystem_size_bytes{fstype!="tmpfs"} - node_filesystem_free_bytes{fstype!="tmpfs"}
          ) / node_filesystem_size_bytes{fstype!="tmpfs"} > 0.85
        for: 10m
        labels:
          severity: warning
          category: resources
          priority: P1
        annotations:
          summary: "âš ï¸ ç£ç¢Ÿç©ºé–“ä¸è¶³"
          description: "ç£ç¢Ÿ {{ $labels.mountpoint }} ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}"
          action: "1. æ¸…ç†æ—¥èªŒ\n2. æ¸…ç†èˆŠæ•¸æ“š\n3. å¢åŠ ç£ç¢Ÿç©ºé–“"

      # ç£ç¢Ÿä½¿ç”¨ç‡ > 95%ï¼ˆCriticalï¼‰
      - alert: CriticalDiskUsage
        expr: |
          (
            node_filesystem_size_bytes{fstype!="tmpfs"} - node_filesystem_free_bytes{fstype!="tmpfs"}
          ) / node_filesystem_size_bytes{fstype!="tmpfs"} > 0.95
        for: 5m
        labels:
          severity: critical
          category: resources
          priority: P0
        annotations:
          summary: "ğŸš¨ ç£ç¢Ÿç©ºé–“åš´é‡ä¸è¶³"
          description: "ç£ç¢Ÿä½¿ç”¨ç‡: {{ $value | humanizePercentage }}"
          action: "ç·Šæ€¥æ¸…ç†ç£ç¢Ÿç©ºé–“"

  # ============================================
  # å®¹å™¨é‡å•Ÿå‘Šè­¦
  # ============================================
  - name: container_restarts
    interval: 5m
    rules:
      # å®¹å™¨é »ç¹é‡å•Ÿ
      - alert: ContainerRestartingFrequently
        expr: rate(container_restart_count[15m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: stability
          priority: P1
        annotations:
          summary: "âš ï¸ å®¹å™¨ {{ $labels.container }} é »ç¹é‡å•Ÿ"
          description: "å®¹å™¨åœ¨ 15 åˆ†é˜å…§é‡å•Ÿè¶…é 1 æ¬¡"
          action: "1. æŸ¥çœ‹å®¹å™¨æ—¥èªŒ\n2. æª¢æŸ¥å¥åº·æª¢æŸ¥é…ç½®\n3. æª¢æŸ¥è³‡æºé™åˆ¶"

      # å®¹å™¨æŒçºŒé‡å•Ÿï¼ˆCrashLoopBackOffï¼‰
      - alert: ContainerCrashLooping
        expr: rate(container_restart_count[15m]) > 0.3
        for: 5m
        labels:
          severity: critical
          category: stability
          priority: P0
        annotations:
          summary: "ğŸš¨ å®¹å™¨ {{ $labels.container }} å´©æ½°å¾ªç’°"
          description: "å®¹å™¨æŒçºŒå´©æ½°é‡å•Ÿï¼Œæœå‹™ä¸ç©©å®š"
          action: "ç«‹å³èª¿æŸ¥å´©æ½°åŸå› "

  # ============================================
  # æ¥­å‹™æŒ‡æ¨™å‘Šè­¦
  # ============================================
  - name: business_metrics
    interval: 5m
    rules:
      # æ”¯ä»˜æˆåŠŸç‡ < 95%
      - alert: LowPaymentSuccessRate
        expr: |
          (
            sum(rate(payment_transactions_total{status="success"}[10m]))
            /
            sum(rate(payment_transactions_total[10m]))
          ) < 0.95
        for: 10m
        labels:
          severity: critical
          category: business
          priority: P0
        annotations:
          summary: "ğŸš¨ æ”¯ä»˜æˆåŠŸç‡éä½"
          description: "æ”¯ä»˜æˆåŠŸç‡: {{ $value | humanizePercentage }}"
          impact: "ç”¨æˆ¶ç„¡æ³•å®Œæˆæ”¯ä»˜ï¼Œç‡Ÿæ”¶æå¤±"
          action: "1. æª¢æŸ¥ Stripe æœå‹™ç‹€æ…‹\n2. æŸ¥çœ‹æ”¯ä»˜å¤±æ•—åŸå› \n3. è¯çµ¡æ”¯ä»˜åœ˜éšŠ"

      # è¨»å†Šè½‰åŒ–ç‡ç•°å¸¸ä¸‹é™
      - alert: LowRegistrationRate
        expr: |
          (
            sum(rate(user_registrations_total[1h]))
            /
            sum(rate(user_registrations_total[1h] offset 24h))
          ) < 0.7
        for: 30m
        labels:
          severity: warning
          category: business
          priority: P2
        annotations:
          summary: "âš ï¸ è¨»å†Šè½‰åŒ–ç‡ä¸‹é™"
          description: "è¨»å†Šç‡è¼ƒæ˜¨æ—¥åŒæœŸä¸‹é™è¶…é 30%"

  # ============================================
  # ç›£æ§ç³»çµ±è‡ªèº«å‘Šè­¦
  # ============================================
  - name: monitoring_health
    interval: 1m
    rules:
      # Prometheus æŠ“å–å¤±æ•—
      - alert: PrometheusTargetDown
        expr: up{job="prometheus"} == 0
        for: 1m
        labels:
          severity: critical
          category: monitoring
          priority: P0
        annotations:
          summary: "ğŸš¨ Prometheus ç›®æ¨™ä¸å¯ç”¨"
          description: "ç›£æ§ç³»çµ±æœ¬èº«å‡ºç¾å•é¡Œ"

      # å‘Šè­¦ç®¡ç†å™¨ä¸å¯ç”¨
      - alert: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 2m
        labels:
          severity: critical
          category: monitoring
          priority: P0
        annotations:
          summary: "ğŸš¨ Alertmanager ä¸å¯ç”¨"
          description: "å‘Šè­¦é€šçŸ¥ç³»çµ±æ•…éšœï¼Œå‘Šè­¦å¯èƒ½ç„¡æ³•ç™¼é€"

      # Prometheus é…ç½®é‡è¼‰å¤±æ•—
      - alert: PrometheusConfigurationReloadFailed
        expr: prometheus_config_last_reload_successful != 1
        for: 1m
        labels:
          severity: warning
          category: monitoring
          priority: P1
        annotations:
          summary: "âš ï¸ Prometheus é…ç½®é‡è¼‰å¤±æ•—"
          description: "æœ€æ–°çš„é…ç½®è®Šæ›´æœªç”Ÿæ•ˆ"

  # ============================================
  # Circuit Breaker å‘Šè­¦
  # ============================================
  - name: circuit_breaker
    interval: 1m
    rules:
      # Circuit Breaker é–‹è·¯
      - alert: CircuitBreakerOpen
        expr: circuit_breaker_state{state="open"} == 1
        for: 2m
        labels:
          severity: critical
          category: resilience
          priority: P0
        annotations:
          summary: "ğŸš¨ Circuit Breaker {{ $labels.service }} å·²é–‹è·¯"
          description: "å°ä¸‹æ¸¸æœå‹™çš„è«‹æ±‚è¢«é˜»æ–·"
          action: "1. æª¢æŸ¥ä¸‹æ¸¸æœå‹™ç‹€æ…‹\n2. æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒ"

  # ============================================
  # Rate Limiting å‘Šè­¦
  # ============================================
  - name: rate_limiting
    interval: 1m
    rules:
      # Rate Limit è§¸ç™¼é »ç‡éé«˜
      - alert: HighRateLimitHitRate
        expr: rate(rate_limit_hits_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          category: security
          priority: P1
        annotations:
          summary: "âš ï¸ Rate Limit è§¸ç™¼é »ç‡éé«˜"
          description: "å¯èƒ½æ˜¯ DDoS æ”»æ“Šæˆ–æƒ¡æ„è¡Œç‚º"
          action: "æª¢æŸ¥è«‹æ±‚ä¾†æº IP å’Œæ¨¡å¼"

      # èªè­‰ç«¯é» Rate Limit è§¸ç™¼
      - alert: AuthRateLimitHit
        expr: rate(rate_limit_hits_total{endpoint=~".*auth.*|.*login.*"}[5m]) > 1
        for: 3m
        labels:
          severity: critical
          category: security
          priority: P0
        annotations:
          summary: "ğŸš¨ èªè­‰ç«¯é» Rate Limit è§¸ç™¼"
          description: "å¯èƒ½æ˜¯æš´åŠ›ç ´è§£æ”»æ“Š"
          action: "æª¢æŸ¥ä¾†æº IPï¼Œè€ƒæ…®å°é–"

  # ============================================
  # å¥åº·æª¢æŸ¥å‘Šè­¦
  # ============================================
  - name: health_checks
    interval: 30s
    rules:
      # æœå‹™å¥åº·æª¢æŸ¥å¤±æ•—
      - alert: ServiceHealthCheckFailed
        expr: health_check_status{status="unhealthy"} == 1
        for: 1m
        labels:
          severity: critical
          category: availability
          priority: P0
        annotations:
          summary: "ğŸš¨ æœå‹™ {{ $labels.service }} å¥åº·æª¢æŸ¥å¤±æ•—"
          description: "å¥åº·æª¢æŸ¥ç«¯é»è¿”å› unhealthy ç‹€æ…‹"
          action: "1. æª¢æŸ¥æœå‹™æ—¥èªŒ\n2. æª¢æŸ¥ä¾è³´æœå‹™"

      # è³‡æ–™åº«å¥åº·æª¢æŸ¥å¤±æ•—
      - alert: DatabaseHealthCheckFailed
        expr: health_check_status{component="database",status="unhealthy"} == 1
        for: 1m
        labels:
          severity: critical
          category: database
          priority: P0
        annotations:
          summary: "ğŸš¨ è³‡æ–™åº«å¥åº·æª¢æŸ¥å¤±æ•— - {{ $labels.service }}"
          description: "ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº«æˆ–è³‡æ–™åº«éŸ¿æ‡‰ç•°å¸¸"

      # Redis å¥åº·æª¢æŸ¥å¤±æ•—
      - alert: RedisHealthCheckFailed
        expr: health_check_status{component="redis",status="unhealthy"} == 1
        for: 1m
        labels:
          severity: critical
          category: cache
          priority: P0
        annotations:
          summary: "ğŸš¨ Redis å¥åº·æª¢æŸ¥å¤±æ•— - {{ $labels.service }}"
          description: "ç„¡æ³•é€£ç·šåˆ° Redis æˆ– Redis éŸ¿æ‡‰ç•°å¸¸"

      # Kafka å¥åº·æª¢æŸ¥å¤±æ•—
      - alert: KafkaHealthCheckFailed
        expr: health_check_status{component="kafka",status="unhealthy"} == 1
        for: 2m
        labels:
          severity: warning
          category: messaging
          priority: P1
        annotations:
          summary: "âš ï¸ Kafka å¥åº·æª¢æŸ¥å¤±æ•— - {{ $labels.service }}"
          description: "ç„¡æ³•é€£ç·šåˆ° Kafka æˆ– Kafka éŸ¿æ‡‰ç•°å¸¸"
