# Prometheus 告警規則
# Suggar Daddy 監控系統
# Version: 1.0.0

groups:
  # ============================================
  # 服務可用性告警（Critical - P0）
  # ============================================
  - name: service_availability
    interval: 30s
    rules:
      # 服務不可用超過 1 分鐘
      - alert: ServiceDown
        expr: up{job=~".*-service|api-gateway"} == 0
        for: 1m
        labels:
          severity: critical
          category: availability
          priority: P0
        annotations:
          summary: "服務 {{ $labels.service }} 不可用"
          description: "服務 {{ $labels.service }} 已經停止響應超過 1 分鐘。\n實例: {{ $labels.instance }}\n當前狀態: DOWN"
          impact: "用戶無法訪問該服務的功能"
          action: "1. 檢查容器狀態\n2. 查看服務日誌\n3. 檢查資源使用情況"

      # 服務部分實例不可用
      - alert: ServicePartiallyDown
        expr: |
          (count by (job) (up{job=~".*-service|api-gateway"} == 0) 
          / count by (job) (up{job=~".*-service|api-gateway"})) > 0.3
        for: 2m
        labels:
          severity: warning
          category: availability
          priority: P1
        annotations:
          summary: "服務 {{ $labels.job }} 部分實例不可用"
          description: "超過 30% 的服務實例不可用"

  # ============================================
  # 錯誤率告警（Critical - P0）
  # ============================================
  - name: error_rate
    interval: 1m
    rules:
      # 錯誤率 > 5%（5 分鐘）
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
            / 
            sum(rate(http_requests_total[5m])) by (service)
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          category: errors
          priority: P0
        annotations:
          summary: "服務 {{ $labels.service }} 錯誤率過高"
          description: "服務 {{ $labels.service }} 的 5xx 錯誤率超過 5%\n當前錯誤率: {{ $value | humanizePercentage }}"
          impact: "大量用戶請求失敗，用戶體驗嚴重下降"
          action: "1. 查看錯誤日誌\n2. 檢查資料庫連線\n3. 檢查依賴服務"

      # 錯誤率 > 0.5%（5 分鐘）- 上線標準
      - alert: ElevatedErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
            / 
            sum(rate(http_requests_total[5m])) by (service)
          ) > 0.005
        for: 5m
        labels:
          severity: warning
          category: errors
          priority: P1
        annotations:
          summary: "服務 {{ $labels.service }} 錯誤率升高"
          description: "服務 {{ $labels.service }} 的 5xx 錯誤率超過 0.5%\n當前錯誤率: {{ $value | humanizePercentage }}"
          impact: "錯誤率超過上線標準（0.5%），需要關注"
          action: "1. 查看錯誤日誌\n2. 檢查最近的部署變更\n3. 監控是否持續升高"

      # 4xx 錯誤率異常（可能是客戶端問題或 API 變更）
      - alert: High4xxRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"4.."}[5m])) by (service)
            / 
            sum(rate(http_requests_total[5m])) by (service)
          ) > 0.1
        for: 10m
        labels:
          severity: warning
          category: client_errors
          priority: P2
        annotations:
          summary: "服務 {{ $labels.service }} 客戶端錯誤率過高"
          description: "4xx 錯誤率超過 10%，可能是 API 使用不當或文檔問題"

  # ============================================
  # API 延遲告警（Warning - P1）
  # ============================================
  - name: api_latency
    interval: 1m
    rules:
      # P95 延遲 > 500ms
      - alert: HighP95Latency
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          category: performance
          priority: P1
        annotations:
          summary: "服務 {{ $labels.service }} P95 延遲過高"
          description: "P95 延遲超過 500ms\n當前 P95: {{ $value | humanizeDuration }}"
          impact: "用戶體驗下降，頁面載入緩慢"
          action: "1. 檢查資料庫查詢效能\n2. 檢查外部 API 調用\n3. 分析慢請求日誌"

      # P99 延遲 > 1s
      - alert: HighP99Latency
        expr: |
          histogram_quantile(0.99,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
          ) > 1
        for: 5m
        labels:
          severity: warning
          category: performance
          priority: P1
        annotations:
          summary: "服務 {{ $labels.service }} P99 延遲過高"
          description: "P99 延遲超過 1 秒\n當前 P99: {{ $value | humanizeDuration }}"

      # 平均延遲 > 200ms
      - alert: HighAverageLatency
        expr: |
          sum(rate(http_request_duration_seconds_sum[5m])) by (service)
          /
          sum(rate(http_request_duration_seconds_count[5m])) by (service)
          > 0.2
        for: 10m
        labels:
          severity: info
          category: performance
          priority: P2
        annotations:
          summary: "服務 {{ $labels.service }} 平均延遲升高"
          description: "平均延遲超過 200ms"

  # ============================================
  # 系統資源告警
  # ============================================
  - name: system_resources
    interval: 1m
    rules:
      # CPU 使用率 > 80%
      - alert: HighCPUUsage
        expr: |
          (
            rate(container_cpu_usage_seconds_total{container!=""}[5m])
            /
            (container_spec_cpu_quota{container!=""} / 100000)
          ) > 0.8
        for: 5m
        labels:
          severity: warning
          category: resources
          priority: P1
        annotations:
          summary: "容器 {{ $labels.container }} CPU 使用率過高"
          description: "CPU 使用率: {{ $value | humanizePercentage }}\nPod: {{ $labels.pod }}\nNamespace: {{ $labels.namespace }}"
          action: "1. 檢查是否有 CPU 密集型操作\n2. 考慮擴展實例\n3. 優化程式碼效能"

      # CPU 使用率 > 90%（Critical）
      - alert: CriticalCPUUsage
        expr: |
          (
            rate(container_cpu_usage_seconds_total{container!=""}[5m])
            /
            (container_spec_cpu_quota{container!=""} / 100000)
          ) > 0.9
        for: 2m
        labels:
          severity: critical
          category: resources
          priority: P0
        annotations:
          summary: "容器 {{ $labels.container }} CPU 使用率危險"
          description: "CPU 使用率超過 90%，服務可能受到影響"

      # 記憶體使用率 > 80%
      - alert: HighMemoryUsage
        expr: |
          (
            container_memory_working_set_bytes{container!=""}
            /
            container_spec_memory_limit_bytes{container!=""} 
          ) > 0.8
        for: 5m
        labels:
          severity: warning
          category: resources
          priority: P1
        annotations:
          summary: "容器 {{ $labels.container }} 記憶體使用率過高"
          description: "記憶體使用率: {{ $value | humanizePercentage }}\n當前使用: {{ humanize $labels.container_memory_working_set_bytes }}B"
          action: "1. 檢查記憶體洩漏\n2. 檢查快取大小\n3. 考慮增加記憶體限制"

      # 記憶體使用率 > 90%（Critical）
      - alert: CriticalMemoryUsage
        expr: |
          (
            container_memory_working_set_bytes{container!=""}
            /
            container_spec_memory_limit_bytes{container!=""} 
          ) > 0.9
        for: 2m
        labels:
          severity: critical
          category: resources
          priority: P0
        annotations:
          summary: "容器 {{ $labels.container }} 記憶體使用率危險"
          description: "記憶體使用率超過 90%，可能發生 OOM"

      # 磁碟使用率 > 85%
      - alert: HighDiskUsage
        expr: |
          (
            node_filesystem_size_bytes{fstype!="tmpfs"} - node_filesystem_free_bytes{fstype!="tmpfs"}
          ) / node_filesystem_size_bytes{fstype!="tmpfs"} > 0.85
        for: 10m
        labels:
          severity: warning
          category: resources
          priority: P1
        annotations:
          summary: "磁碟空間不足"
          description: "磁碟 {{ $labels.mountpoint }} 使用率: {{ $value | humanizePercentage }}"

      # 磁碟使用率 > 95%（Critical）
      - alert: CriticalDiskUsage
        expr: |
          (
            node_filesystem_size_bytes{fstype!="tmpfs"} - node_filesystem_free_bytes{fstype!="tmpfs"}
          ) / node_filesystem_size_bytes{fstype!="tmpfs"} > 0.95
        for: 5m
        labels:
          severity: critical
          category: resources
          priority: P0
        annotations:
          summary: "磁碟空間嚴重不足"
          description: "磁碟 {{ $labels.mountpoint }} 使用率: {{ $value | humanizePercentage }}\n剩餘空間: {{ humanize1024 $labels.node_filesystem_free_bytes }}B"

  # ============================================
  # 資料庫告警
  # ============================================
  - name: database
    interval: 1m
    rules:
      # PostgreSQL 連線數 > 80%
      - alert: PostgresHighConnections
        expr: |
          (
            pg_stat_database_numbackends{datname="suggar_daddy"}
            /
            pg_settings_max_connections
          ) > 0.8
        for: 5m
        labels:
          severity: warning
          category: database
          priority: P1
        annotations:
          summary: "PostgreSQL 連線數過高"
          description: "連線使用率: {{ $value | humanizePercentage }}\n當前連線數: {{ $labels.pg_stat_database_numbackends }}"
          action: "1. 檢查連線池配置\n2. 查找長時間執行的查詢\n3. 考慮增加最大連線數"

      # PostgreSQL 連線數 > 95%（Critical）
      - alert: PostgresCriticalConnections
        expr: |
          (
            pg_stat_database_numbackends{datname="suggar_daddy"}
            /
            pg_settings_max_connections
          ) > 0.95
        for: 2m
        labels:
          severity: critical
          category: database
          priority: P0
        annotations:
          summary: "PostgreSQL 連線數危險"
          description: "連線池即將耗盡，新連線可能被拒絕"

      # PostgreSQL 複製延遲過高
      - alert: PostgresReplicationLag
        expr: pg_replication_lag_seconds > 60
        for: 5m
        labels:
          severity: warning
          category: database
          priority: P1
        annotations:
          summary: "PostgreSQL 複製延遲過高"
          description: "複製延遲: {{ $value | humanizeDuration }}"

      # Redis 記憶體使用率 > 80%
      - alert: RedisHighMemory
        expr: |
          (
            redis_memory_used_bytes
            /
            redis_memory_max_bytes
          ) > 0.8
        for: 5m
        labels:
          severity: warning
          category: cache
          priority: P1
        annotations:
          summary: "Redis 記憶體使用率過高"
          description: "記憶體使用率: {{ $value | humanizePercentage }}"

      # Redis 連線數異常
      - alert: RedisHighConnections
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: warning
          category: cache
          priority: P2
        annotations:
          summary: "Redis 連線數異常"
          description: "當前連線數: {{ $value }}"

      # Redis 命中率低於 80%
      - alert: RedisLowHitRate
        expr: |
          (
            rate(redis_keyspace_hits_total[5m])
            /
            (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))
          ) < 0.8
        for: 15m
        labels:
          severity: info
          category: cache
          priority: P2
        annotations:
          summary: "Redis 快取命中率低"
          description: "命中率: {{ $value | humanizePercentage }}\n可能需要優化快取策略"

  # ============================================
  # 容器重啟告警
  # ============================================
  - name: container_restarts
    interval: 5m
    rules:
      # 容器頻繁重啟
      - alert: ContainerRestartingFrequently
        expr: rate(container_restart_count[15m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: stability
          priority: P1
        annotations:
          summary: "容器 {{ $labels.container }} 頻繁重啟"
          description: "容器在 15 分鐘內重啟超過 1 次\nPod: {{ $labels.pod }}"
          action: "1. 查看容器日誌\n2. 檢查健康檢查配置\n3. 檢查資源限制"

      # 容器持續重啟（Critical）
      - alert: ContainerCrashLooping
        expr: rate(container_restart_count[15m]) > 0.3
        for: 5m
        labels:
          severity: critical
          category: stability
          priority: P0
        annotations:
          summary: "容器 {{ $labels.container }} 崩潰循環"
          description: "容器持續崩潰重啟，服務不穩定"

  # ============================================
  # 業務指標告警
  # ============================================
  - name: business_metrics
    interval: 5m
    rules:
      # 支付成功率 < 95%
      - alert: LowPaymentSuccessRate
        expr: |
          (
            sum(rate(payment_transactions_total{status="success"}[10m]))
            /
            sum(rate(payment_transactions_total[10m]))
          ) < 0.95
        for: 10m
        labels:
          severity: critical
          category: business
          priority: P0
        annotations:
          summary: "支付成功率過低"
          description: "支付成功率: {{ $value | humanizePercentage }}\n直接影響營收"
          impact: "用戶無法完成支付，營收損失"
          action: "1. 檢查 Stripe 服務狀態\n2. 查看支付失敗原因\n3. 聯絡支付團隊"

      # 註冊轉化率異常下降
      - alert: LowRegistrationRate
        expr: |
          (
            sum(rate(user_registrations_total[1h]))
            /
            sum(rate(user_registrations_total[1h] offset 24h))
          ) < 0.7
        for: 30m
        labels:
          severity: warning
          category: business
          priority: P2
        annotations:
          summary: "註冊轉化率下降"
          description: "註冊率較昨日同期下降超過 30%"

  # ============================================
  # Prometheus 自身告警
  # ============================================
  - name: prometheus_alerts
    interval: 1m
    rules:
      # Prometheus 抓取失敗
      - alert: PrometheusTargetDown
        expr: up{job="prometheus"} == 0
        for: 1m
        labels:
          severity: critical
          category: monitoring
          priority: P0
        annotations:
          summary: "Prometheus 目標不可用"
          description: "監控系統本身出現問題"

      # 告警管理器不可用
      - alert: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 2m
        labels:
          severity: critical
          category: monitoring
          priority: P0
        annotations:
          summary: "Alertmanager 不可用"
          description: "告警通知系統故障，告警可能無法發送"

  # ============================================
  # Circuit Breaker 告警（P0 - 上線準備新增）
  # ============================================
  - name: circuit_breaker
    interval: 1m
    rules:
      # Circuit Breaker 開路
      - alert: CircuitBreakerOpen
        expr: circuit_breaker_state{state="open"} == 1
        for: 2m
        labels:
          severity: critical
          category: resilience
          priority: P0
        annotations:
          summary: "Circuit Breaker {{ $labels.service }} 已開路"
          description: "服務 {{ $labels.service }} 的 Circuit Breaker 處於開路狀態，請求被阻斷\n目標服務: {{ $labels.target_service }}"
          impact: "對下游服務的請求被阻斷，功能可能受限"
          action: "1. 檢查下游服務狀態\n2. 查看錯誤日誌\n3. 確認是否需要擴容或修復"

      # Circuit Breaker 半開路
      - alert: CircuitBreakerHalfOpen
        expr: circuit_breaker_state{state="half_open"} == 1
        for: 5m
        labels:
          severity: warning
          category: resilience
          priority: P1
        annotations:
          summary: "Circuit Breaker {{ $labels.service }} 處於半開路狀態"
          description: "服務正在嘗試恢復，但仍不穩定"
          action: "監控服務恢復情況"

      # Circuit Breaker 開路次數過多
      - alert: CircuitBreakerOpeningFrequently
        expr: rate(circuit_breaker_opened_total[10m]) > 0.1
        for: 10m
        labels:
          severity: warning
          category: resilience
          priority: P1
        annotations:
          summary: "Circuit Breaker {{ $labels.service }} 頻繁開路"
          description: "在 10 分鐘內開路超過 6 次\n當前開路頻率: {{ $value | humanize }}/s"
          impact: "服務不穩定，用戶體驗受影響"
          action: "1. 檢查下游服務穩定性\n2. 調整 Circuit Breaker 閾值\n3. 增加重試機制"

      # Circuit Breaker 拒絕請求數異常
      - alert: HighCircuitBreakerRejections
        expr: rate(circuit_breaker_rejected_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: resilience
          priority: P1
        annotations:
          summary: "Circuit Breaker {{ $labels.service }} 大量拒絕請求"
          description: "每秒拒絕超過 10 個請求\n當前拒絕率: {{ $value | humanize }}/s"
          impact: "大量請求被拒絕，用戶功能受限"
          action: "檢查 Circuit Breaker 狀態和下游服務"

  # ============================================
  # Rate Limiting 告警（P0 - 上線準備新增）
  # ============================================
  - name: rate_limiting
    interval: 1m
    rules:
      # Rate Limit 觸發頻率過高
      - alert: HighRateLimitHitRate
        expr: rate(rate_limit_hits_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          category: security
          priority: P1
        annotations:
          summary: "Rate Limit 觸發頻率過高"
          description: "每秒觸發 Rate Limit 超過 5 次\n當前觸發率: {{ $value | humanize }}/s\nEndpoint: {{ $labels.endpoint }}"
          impact: "可能遭受 DDoS 攻擊或有惡意行為"
          action: "1. 檢查請求來源 IP\n2. 分析請求模式\n3. 考慮加強防護或封鎖 IP"

      # 認證端點 Rate Limit 觸發
      - alert: AuthRateLimitHit
        expr: rate(rate_limit_hits_total{endpoint=~".*auth.*|.*login.*"}[5m]) > 1
        for: 3m
        labels:
          severity: critical
          category: security
          priority: P0
        annotations:
          summary: "認證端點 Rate Limit 觸發"
          description: "認證端點頻繁觸發限流\nEndpoint: {{ $labels.endpoint }}\nIP: {{ $labels.ip }}"
          impact: "可能是暴力破解攻擊"
          action: "1. 立即檢查來源 IP\n2. 考慮封鎖可疑 IP\n3. 啟用 CAPTCHA"

      # 支付端點 Rate Limit 觸發
      - alert: PaymentRateLimitHit
        expr: rate(rate_limit_hits_total{endpoint=~".*payment.*"}[5m]) > 0.5
        for: 5m
        labels:
          severity: critical
          category: security
          priority: P0
        annotations:
          summary: "支付端點 Rate Limit 觸發"
          description: "支付端點頻繁觸發限流\nUser: {{ $labels.user_id }}"
          impact: "可能是惡意支付請求或測試"
          action: "1. 檢查用戶行為\n2. 聯絡風控團隊\n3. 暫停可疑帳戶"

      # Rate Limit 總拒絕率過高
      - alert: HighRateLimitRejectionRate
        expr: |
          (
            sum(rate(rate_limit_hits_total[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) > 0.1
        for: 10m
        labels:
          severity: warning
          category: performance
          priority: P2
        annotations:
          summary: "Rate Limit 拒絕率過高"
          description: "超過 10% 的請求被限流拒絕\n當前拒絕率: {{ $value | humanizePercentage }}"
          impact: "大量正常用戶請求可能被誤殺"
          action: "1. 檢查 Rate Limit 配置\n2. 分析請求模式\n3. 考慮調整限流閾值"

  # ============================================
  # 孤兒交易告警（P0 - 上線準備新增）
  # ============================================
  - name: orphan_transactions
    interval: 5m
    rules:
      # 檢測到孤兒交易
      - alert: OrphanTransactionDetected
        expr: orphan_transactions_detected_total > 0
        for: 1m
        labels:
          severity: critical
          category: business
          priority: P0
          domain: payment
        annotations:
          summary: "檢測到孤兒交易"
          description: "系統檢測到 {{ $value }} 筆孤兒交易\nTransaction IDs: {{ $labels.transaction_ids }}"
          impact: "用戶已付款但系統未正確記錄，可能導致營收損失和用戶投訴"
          action: "1. 立即檢查孤兒交易處理器運行狀態\n2. 手動檢查交易記錄\n3. 聯絡支付團隊協調處理\n4. 通知客服團隊"

      # 孤兒交易處理失敗
      - alert: OrphanTransactionProcessingFailed
        expr: rate(orphan_transaction_processing_failures_total[10m]) > 0
        for: 5m
        labels:
          severity: critical
          category: business
          priority: P0
          domain: payment
        annotations:
          summary: "孤兒交易處理失敗"
          description: "孤兒交易處理器無法處理部分交易\n失敗率: {{ $value | humanize }}/s"
          impact: "孤兒交易累積，用戶體驗受影響"
          action: "1. 檢查處理器日誌\n2. 檢查 Stripe webhook 配置\n3. 手動重試失敗的交易"

      # 孤兒交易數量異常增長
      - alert: OrphanTransactionSurge
        expr: |
          rate(orphan_transactions_detected_total[10m]) > 
          rate(orphan_transactions_detected_total[10m] offset 1h) * 3
        for: 10m
        labels:
          severity: warning
          category: business
          priority: P1
          domain: payment
        annotations:
          summary: "孤兒交易數量異常增長"
          description: "孤兒交易檢測數量較一小時前增長 3 倍以上"
          impact: "可能系統出現問題，導致大量交易無法正確處理"
          action: "1. 檢查支付服務狀態\n2. 檢查資料庫連線\n3. 查看最近的部署變更"

      # 孤兒交易處理延遲過高
      - alert: OrphanTransactionProcessingDelay
        expr: orphan_transaction_processing_delay_seconds > 300
        for: 5m
        labels:
          severity: warning
          category: business
          priority: P1
          domain: payment
        annotations:
          summary: "孤兒交易處理延遲過高"
          description: "孤兒交易處理延遲超過 5 分鐘\n當前延遲: {{ $value | humanizeDuration }}"
          impact: "用戶等待時間過長，可能引起投訴"
          action: "1. 檢查處理器負載\n2. 增加處理器實例\n3. 優化處理邏輯"

  # ============================================
  # 健康檢查告警（P0 - 上線準備新增）
  # ============================================
  - name: health_checks
    interval: 30s
    rules:
      # 服務健康檢查失敗
      - alert: ServiceHealthCheckFailed
        expr: health_check_status{status="unhealthy"} == 1
        for: 1m
        labels:
          severity: critical
          category: availability
          priority: P0
        annotations:
          summary: "服務 {{ $labels.service }} 健康檢查失敗"
          description: "健康檢查端點返回 unhealthy 狀態\nEndpoint: {{ $labels.endpoint }}\nReason: {{ $labels.reason }}"
          impact: "服務可能無法正常工作，用戶請求可能失敗"
          action: "1. 檢查服務日誌\n2. 檢查依賴服務（資料庫、Redis、Kafka）\n3. 檢查資源使用情況"

      # 資料庫連線健康檢查失敗
      - alert: DatabaseHealthCheckFailed
        expr: health_check_status{component="database",status="unhealthy"} == 1
        for: 1m
        labels:
          severity: critical
          category: database
          priority: P0
        annotations:
          summary: "資料庫健康檢查失敗 - {{ $labels.service }}"
          description: "無法連線到資料庫或資料庫響應異常"
          impact: "所有需要資料庫的功能將無法使用"
          action: "1. 檢查 PostgreSQL 狀態\n2. 檢查連線池配置\n3. 檢查網路連線"

      # Redis 連線健康檢查失敗
      - alert: RedisHealthCheckFailed
        expr: health_check_status{component="redis",status="unhealthy"} == 1
        for: 1m
        labels:
          severity: critical
          category: cache
          priority: P0
        annotations:
          summary: "Redis 健康檢查失敗 - {{ $labels.service }}"
          description: "無法連線到 Redis 或 Redis 響應異常"
          impact: "快取功能失效，系統效能下降，Rate Limiting 可能失效"
          action: "1. 檢查 Redis 狀態\n2. 檢查 Redis Sentinel\n3. 檢查網路連線"

      # Kafka 連線健康檢查失敗
      - alert: KafkaHealthCheckFailed
        expr: health_check_status{component="kafka",status="unhealthy"} == 1
        for: 2m
        labels:
          severity: warning
          category: messaging
          priority: P1
        annotations:
          summary: "Kafka 健康檢查失敗 - {{ $labels.service }}"
          description: "無法連線到 Kafka 或 Kafka 響應異常"
          impact: "異步處理功能可能受影響，事件可能遺失"
          action: "1. 檢查 Kafka broker 狀態\n2. 檢查 Zookeeper 狀態\n3. 檢查網路連線"
