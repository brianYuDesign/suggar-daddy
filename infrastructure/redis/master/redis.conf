# ====================================================================
# Redis Master Configuration
# ====================================================================
# 這個配置文件用於 Redis Master 實例
# 主要負責處理寫入操作和複製到 Replica 節點

# ── 網路設定 ────────────────────────────────────────────────────────
# 綁定所有網卡，允許來自任何 IP 的連接（Docker 網路需要）
bind 0.0.0.0

# 端口
port 6379

# 保護模式關閉（因為在 Docker 內部網路中）
protected-mode no

# TCP 監聽佇列大小
tcp-backlog 511

# TCP keepalive 時間（秒）
tcp-keepalive 300

# 超時設定（0 表示不超時）
timeout 0

# ── 持久化設定 ──────────────────────────────────────────────────────
# AOF (Append Only File) 持久化 - 更安全的持久化方式
appendonly yes
appendfilename "appendonly.aof"

# AOF 同步策略
# - always: 每次寫入都同步到磁碟（最安全但最慢）
# - everysec: 每秒同步一次（推薦，平衡性能和安全性）
# - no: 由作業系統決定何時同步（最快但最不安全）
appendfsync everysec

# 重寫 AOF 時是否繼續同步
no-appendfsync-on-rewrite no

# AOF 自動重寫條件
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF 加載時容錯處理
aof-load-truncated yes

# 使用 RDB-AOF 混合持久化（Redis 4.0+）
aof-use-rdb-preamble yes

# RDB 快照設定（作為備份）
# 格式：save <seconds> <changes>
save 900 1      # 900秒內至少1個key變更
save 300 10     # 300秒內至少10個key變更
save 60 10000   # 60秒內至少10000個key變更

# RDB 文件名
dbfilename dump.rdb

# 數據目錄
dir /data

# RDB 壓縮
rdbcompression yes

# RDB 校驗和
rdbchecksum yes

# ── 記憶體管理 ──────────────────────────────────────────────────────
# 最大記憶體限制
maxmemory 512mb

# 記憶體淘汰策略
# - volatile-lru: 只對設置了過期時間的key進行LRU
# - allkeys-lru: 對所有key進行LRU（推薦）
# - volatile-lfu: 只對設置了過期時間的key進行LFU
# - allkeys-lfu: 對所有key進行LFU
# - volatile-random: 隨機刪除設置了過期時間的key
# - allkeys-random: 隨機刪除所有key
# - volatile-ttl: 刪除即將過期的key
# - noeviction: 不刪除，寫入時返回錯誤
maxmemory-policy allkeys-lru

# 記憶體樣本數量
maxmemory-samples 5

# ── 複製設定 ────────────────────────────────────────────────────────
# Replica 優先級（數字越小優先級越高，0表示永不提升為master）
replica-priority 100

# 最小 Replica 數量和延遲設定
# 如果少於 N 個 Replica 在線或延遲超過 M 秒，Master 將拒絕寫入
# min-replicas-to-write 1
# min-replicas-max-lag 10

# Replica 只讀模式
replica-read-only yes

# 複製積壓緩衝區大小
repl-backlog-size 1mb

# 複製積壓緩衝區過期時間
repl-backlog-ttl 3600

# 禁用危險命令（生產環境建議）
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""
# rename-command CONFIG ""

# ── 日誌設定 ────────────────────────────────────────────────────────
# 日誌級別：debug, verbose, notice, warning
loglevel notice

# 日誌文件（空字符串表示輸出到標準輸出）
logfile ""

# ── 客戶端設定 ──────────────────────────────────────────────────────
# 最大客戶端連接數
maxclients 10000

# ── 慢查詢日誌 ──────────────────────────────────────────────────────
# 慢查詢閾值（微秒）
slowlog-log-slower-than 10000

# 慢查詢日誌長度
slowlog-max-len 128

# ── 其他設定 ────────────────────────────────────────────────────────
# 數據庫數量
databases 16

# 是否總是顯示 logo
always-show-logo no

# 停止寫入在 BGSAVE 錯誤時
stop-writes-on-bgsave-error yes
