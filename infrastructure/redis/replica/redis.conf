# ====================================================================
# Redis Replica Configuration
# ====================================================================
# 這個配置文件用於 Redis Replica（從節點）實例
# 主要負責從 Master 複製資料並處理讀取請求

# ── 網路設定 ────────────────────────────────────────────────────────
# 綁定所有網卡，允許來自任何 IP 的連接（Docker 網路需要）
bind 0.0.0.0

# 端口
port 6379

# 保護模式關閉（因為在 Docker 內部網路中）
protected-mode no

# TCP 監聽佇列大小
tcp-backlog 511

# TCP keepalive 時間（秒）
tcp-keepalive 300

# 超時設定（0 表示不超時）
timeout 0

# ── 複製設定 ────────────────────────────────────────────────────────
# 連接到 Master（將由 Docker Compose 的 command 覆蓋）
# replicaof redis-master 6379

# Replica 只讀模式（強制執行）
replica-read-only yes

# Replica 優先級（數字越小優先級越高）
# Sentinel 會根據這個值來選擇新的 Master
# replica-1 優先級較高
replica-priority 100

# 當 Replica 與 Master 失去連接時的行為
# yes: 繼續回應客戶端請求（可能是舊資料）
# no: 拒絕所有請求（除了 INFO 和 SLAVEOF）
replica-serve-stale-data yes

# 複製時是否使用無磁碟傳輸
repl-diskless-sync no

# 複製積壓緩衝區大小
repl-backlog-size 1mb

# ── 持久化設定 ──────────────────────────────────────────────────────
# AOF 持久化
appendonly yes
appendfilename "appendonly.aof"

# AOF 同步策略
appendfsync everysec

# 重寫 AOF 時是否繼續同步
no-appendfsync-on-rewrite no

# AOF 自動重寫條件
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF 加載時容錯處理
aof-load-truncated yes

# 使用 RDB-AOF 混合持久化
aof-use-rdb-preamble yes

# RDB 快照設定
# 900秒內至少1個key變更
save 900 1
# 300秒內至少10個key變更
save 300 10
# 60秒內至少10000個key變更
save 60 10000

# RDB 文件名
dbfilename dump.rdb

# 數據目錄
dir /data

# RDB 壓縮
rdbcompression yes

# RDB 校驗和
rdbchecksum yes

# ── 記憶體管理 ──────────────────────────────────────────────────────
# 最大記憶體限制
maxmemory 512mb

# 記憶體淘汰策略
maxmemory-policy allkeys-lru

# 記憶體樣本數量
maxmemory-samples 5

# ── 日誌設定 ────────────────────────────────────────────────────────
# 日誌級別
loglevel notice

# 日誌文件
logfile ""

# ── 客戶端設定 ──────────────────────────────────────────────────────
# 最大客戶端連接數
maxclients 10000

# ── 慢查詢日誌 ──────────────────────────────────────────────────────
# 慢查詢閾值（微秒）
slowlog-log-slower-than 10000

# 慢查詢日誌長度
slowlog-max-len 128

# ── 其他設定 ────────────────────────────────────────────────────────
# 數據庫數量
databases 16

# 是否總是顯示 logo
always-show-logo no

# 停止寫入在 BGSAVE 錯誤時
stop-writes-on-bgsave-error yes
