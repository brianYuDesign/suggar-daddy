# 📋 生產部署檢查清單

## 🎯 部署前必檢項目

### 部署時間: __________ | 部署者: __________ | 批准者: __________

---

## ✅ 代碼準備 (Code Readiness)

### 源代碼檢查
- [ ] 所有更改已 code review
- [ ] 所有 PR 已合並到 main/production 分支
- [ ] CI/CD pipeline 全部通過 (綠色)
- [ ] 無未解決的 merge conflicts
- [ ] Git commit messages 清晰
- [ ] Tag 已創建: `v1.0.0-rc1` 或更高版本

### 測試覆蓋
- [ ] 單元測試通過率 > 90%
- [ ] 集成測試全部通過
- [ ] E2E 測試全部通過
- [ ] 性能測試完成 (無回退)
- [ ] 安全掃描無高危漏洞
- [ ] 代碼質量評分 >= A

---

## 🔐 安全檢查 (Security)

### 敏感信息
- [ ] 代碼中無 hardcoded secrets
- [ ] 所有 API 密鑰已輪換 (< 1 月)
- [ ] SSL/TLS 證書有效 (> 30 天)
- [ ] 數據庫密碼強度 >= 16 字符
- [ ] 加密密鑰已備份 (多個位置)

### 依賴性掃描
- [ ] npm audit 無高危漏洞
- [ ] Docker 鏡像掃描無高危漏洞
- [ ] 依賴項許可證檢查通過
- [ ] 已更新到最新的安全補丁版本

### 訪問控制
- [ ] IAM 角色已配置
- [ ] RBAC 權限已配置
- [ ] Network policies 已配置
- [ ] Firewall rules 已驗證

---

## 🗄️ 數據庫準備 (Database)

### 備份策略
- [ ] 完整備份已執行 (< 24 小時)
- [ ] 備份驗證已完成
- [ ] S3 備份已確認
- [ ] 恢復計劃已測試

### 遷移和 Schema
- [ ] 所有數據庫遷移已測試
- [ ] 遷移回滾腳本已準備
- [ ] 沒有不兼容的 schema 改動
- [ ] 索引優化已完成
- [ ] 連接池設置已驗證

### 數據驗證
- [ ] 關鍵表行數符合預期
- [ ] 數據完整性檢查通過
- [ ] 無孤立記錄
- [ ] 無重複主鍵

---

## 🚀 基礎設施檢查 (Infrastructure)

### 環境配置
- [ ] 所有環境變量已設置
- [ ] Secrets 已從 AWS Secrets Manager 加載
- [ ] 數據庫連接字符串已驗證
- [ ] Redis 連接已驗證
- [ ] S3 bucket 訪問已驗證

### 網絡和域名
- [ ] DNS 記錄已驗證
- [ ] SSL 證書已驗證
- [ ] CDN 配置已驗證
- [ ] Load balancer 已配置
- [ ] 防火牆規則已配置

### 計算資源
- [ ] 服務器/Pod 資源充足
- [ ] 磁盤空間充足 (> 20%)
- [ ] 內存充足 (> 30% 可用)
- [ ] CPU 未超載 (< 80%)
- [ ] Auto-scaling 規則已配置

---

## 📊 監控和日誌 (Monitoring & Logging)

### 監控系統
- [ ] Prometheus 已配置
- [ ] Grafana dashboard 已配置
- [ ] 告警規則已配置
- [ ] 告警通知已驗證 (Slack/PagerDuty)
- [ ] 健康檢查端點已驗證

### 日誌系統
- [ ] ELK stack 已配置
- [ ] 日誌採集已啟用
- [ ] 日誌保留策略已配置
- [ ] 日誌搜索已驗證

### 追蹤和分析
- [ ] 分佈式追蹤已配置 (Jaeger)
- [ ] APM 系統已連接 (Datadog/New Relic)
- [ ] 錯誤追蹤已配置 (Sentry)
- [ ] 使用分析已配置

---

## 🔄 部署流程 (Deployment Process)

### 部署策略
- [ ] 灰度部署 (5% → 25% → 50% → 100%) 已驗證
- [ ] 自動回滾條件已配置
- [ ] 灰度部署腳本已測試
- [ ] 回滾程序已演練

### 負載均衡
- [ ] 無會話親和性依賴 (無 sticky sessions)
- [ ] 無靜態狀態存儲
- [ ] 所有連接可中斷
- [ ] 連接超時已設置

### 故障轉移
- [ ] Multi-AZ 已配置
- [ ] 主從複製已驗證
- [ ] 自動故障轉移已驗證
- [ ] 故障轉移時間 < 1 分鐘

---

## 📱 應用功能 (Application)

### 核心功能
- [ ] 推薦系統功能正常
- [ ] 內容流媒體功能正常
- [ ] 支付系統功能正常
- [ ] 認證系統功能正常
- [ ] 用戶管理功能正常

### API 端點
- [ ] 所有主要 API 端點可訪問
- [ ] 返回正確的 HTTP 狀態碼
- [ ] 響應時間 < 2 秒
- [ ] 無錯誤堆棧跟蹤洩露
- [ ] Rate limiting 工作正常

### 緩存
- [ ] Redis 緩存工作正常
- [ ] 緩存命中率 > 80%
- [ ] 緩存過期策略正常
- [ ] 無緩存穿透問題

---

## 🎵 媒體和 CDN (Media & CDN)

### S3 配置
- [ ] S3 bucket 已創建
- [ ] 上傳/下載權限已驗證
- [ ] 版本控制已啟用
- [ ] 生命週期策略已配置
- [ ] 加密已啟用

### CloudFront CDN
- [ ] CloudFront 分佈式已創建
- [ ] 源配置已驗證
- [ ] 快取行為已配置
- [ ] 自定義域名已配置
- [ ] SSL 證書已配置

### 轉碼和優化
- [ ] 轉碼輸出質量已驗證
- [ ] 轉碼性能可接受
- [ ] 圖像優化已配置
- [ ] 視頻邊界優化已啟用

---

## ⚖️ 法規和合規 (Compliance)

### 數據保護
- [ ] GDPR 合規已驗證
- [ ] 數據加密已驗證
- [ ] 用戶隱私政策已更新
- [ ] Cookie 同意已配置

### 審計和日誌
- [ ] 審計日誌已啟用
- [ ] 敏感操作已記錄
- [ ] 日誌無法被篡改
- [ ] 日誌保留期已配置

### 備份和恢復
- [ ] 備份計劃已文檔化
- [ ] RTO/RPO 已明確
- [ ] 恢復演習已完成
- [ ] 恢復文檔已更新

---

## 📞 溝通和支持 (Communication)

### 團隊準備
- [ ] 所有團隊成員已通知
- [ ] 變更日誌已發布
- [ ] 支持文檔已準備
- [ ] 故障排查指南已準備

### 客戶通知
- [ ] 維護窗口已公告
- [ ] 預期停機時間已通知
- [ ] 回滾計劃已溝通
- [ ] 聯絡信息已提供

### 監控和警報
- [ ] 監控告警已啟用
- [ ] On-call 工程師已準備
- [ ] 升級流程已明確
- [ ] 應急聯絡已更新

---

## 🎬 部署執行 (Deployment Execution)

### 部署前
- [ ] 所有檢查清單項目已完成
- [ ] 批准已獲得
- [ ] 部署窗口已確認
- [ ] 回滾計劃已確認

### 部署中
- [ ] 灰度部署 5% 已完成 ✅
- [ ] 5% 階段監控已通過 ✅
- [ ] 灰度部署 25% 已完成 ✅
- [ ] 25% 階段監控已通過 ✅
- [ ] 灰度部署 50% 已完成 ✅
- [ ] 50% 階段監控已通過 ✅
- [ ] 灰度部署 100% 已完成 ✅
- [ ] 最終健康檢查已通過 ✅

### 部署後
- [ ] 所有指標正常
- [ ] 用戶報告無故障
- [ ] 錯誤率 < 0.1%
- [ ] 性能無回退
- [ ] 部署報告已生成

---

## 🚨 回滾條件 (Rollback Triggers)

### 自動回滾觸發條件

| 指標 | 閾值 | 行動 |
|------|------|------|
| 錯誤率 | > 5% (3 分鐘) | 自動回滾 |
| P99 延遲 | > 5000ms (5 分鐘) | 自動回滾 |
| Pod 就緒率 | < 50% (2 分鐘) | 自動回滾 |
| 內存使用 | > 90% (5 分鐘) | 手動確認後回滾 |
| CPU 使用 | > 95% (5 分鐘) | 手動確認後回滾 |

### 手動回滾

```bash
# 立即回滾
kubectl rollout undo deployment/recommendation-service -n production

# 回滾到特定版本
kubectl rollout undo deployment/recommendation-service -n production --to-revision=5

# 驗證回滾
kubectl rollout status deployment/recommendation-service -n production
```

---

## 📋 部署簽署

| 角色 | 名字 | 簽名 | 日期 | 時間 |
|------|------|------|------|------|
| 部署工程師 | __________ | __________ | __________ | __________ |
| 技術負責人 | __________ | __________ | __________ | __________ |
| 運維負責人 | __________ | __________ | __________ | __________ |

---

## 📝 部署備註

```
開始時間: __________
完成時間: __________
總耗時: __________
遇到的問題: _____________________________________
解決方案: _____________________________________
特殊事項: _____________________________________
下次部署建議: _____________________________________
```

---

## 📊 部署統計

- **部署版本**: v1.0.0
- **涉及服務**: [ ] Recommendation [ ] Content [ ] Auth [ ] Payment
- **代碼改動**: _____ 個文件，_____ 行代碼
- **遷移數量**: _____ 個數據庫遷移
- **預期停機時間**: 0 分鐘 (灰度部署)
- **實際停機時間**: _____ 分鐘
- **回滾次數**: _____

---

**重要**: 此檢查清單應該在每次生產部署前完整填寫。所有項目必須標記為已完成或有書面豁免。

**文件版本**: v1.0  
**最後更新**: 2026-02-19  
**維護者**: DevOps Team
