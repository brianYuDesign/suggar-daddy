openapi: 3.0.0
info:
  title: Payment & Subscription Service API
  description: Stripe-integrated payment and subscription management service
  version: 1.0.0
  contact:
    name: Backend Team
    email: backend@sugar-daddy.io

servers:
  - url: http://localhost:3002
    description: Development server
  - url: https://api.sugar-daddy.io
    description: Production server

tags:
  - name: Payments
    description: One-time payment operations
  - name: Subscriptions
    description: Subscription management
  - name: Invoices
    description: Invoice generation and management
  - name: Webhooks
    description: Stripe webhook endpoints

paths:
  /api/v1/payments/intent:
    post:
      tags:
        - Payments
      summary: Create Payment Intent
      description: Initialize a new payment for one-time purchase or subscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentDto'
      responses:
        '201':
          description: Payment intent created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentIntentResponse'
        '400':
          description: Invalid request

  /api/v1/payments/confirm:
    post:
      tags:
        - Payments
      summary: Confirm Payment
      description: Confirm payment with Stripe token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                paymentId:
                  type: string
                  format: uuid
                stripeToken:
                  type: string
      responses:
        '200':
          description: Payment confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResponse'

  /api/v1/payments/{paymentId}:
    get:
      tags:
        - Payments
      summary: Get Payment Details
      parameters:
        - name: paymentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Payment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
        '404':
          description: Payment not found

  /api/v1/payments/user/{userId}:
    get:
      tags:
        - Payments
      summary: Get User Payment History
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: User payments
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentHistoryResponse'

  /api/v1/payments/refund:
    post:
      tags:
        - Payments
      summary: Refund Payment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefundPaymentDto'
      responses:
        '200':
          description: Refund processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  paymentId:
                    type: string
                  refundId:
                    type: string
                  status:
                    type: string
                  amount:
                    type: number

  /api/v1/payments/{paymentId}/retry:
    post:
      tags:
        - Payments
      summary: Retry Failed Payment
      parameters:
        - name: paymentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Payment retry initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentRetryResponse'

  /api/v1/subscriptions:
    post:
      tags:
        - Subscriptions
      summary: Create Subscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSubscriptionDto'
      responses:
        '201':
          description: Subscription created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionResponse'
    get:
      tags:
        - Subscriptions
      summary: List All Subscriptions
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Subscriptions list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionListResponse'

  /api/v1/subscriptions/{subscriptionId}:
    get:
      tags:
        - Subscriptions
      summary: Get Subscription Details
      parameters:
        - name: subscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Subscription details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'
    patch:
      tags:
        - Subscriptions
      summary: Update Subscription (Upgrade/Downgrade)
      parameters:
        - name: subscriptionId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSubscriptionDto'
      responses:
        '200':
          description: Subscription updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'

  /api/v1/subscriptions/{subscriptionId}/cancel:
    post:
      tags:
        - Subscriptions
      summary: Cancel Subscription
      parameters:
        - name: subscriptionId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Subscription cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionCancelResponse'

  /api/v1/subscriptions/{subscriptionId}/pause:
    post:
      tags:
        - Subscriptions
      summary: Pause Subscription
      parameters:
        - name: subscriptionId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Subscription paused
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'

  /api/v1/subscriptions/{subscriptionId}/resume:
    post:
      tags:
        - Subscriptions
      summary: Resume Subscription
      parameters:
        - name: subscriptionId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Subscription resumed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'

  /api/v1/subscriptions/user/{userId}:
    get:
      tags:
        - Subscriptions
      summary: Get User's Subscription
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: User subscription
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subscription'

  /api/v1/invoices:
    post:
      tags:
        - Invoices
      summary: Create Invoice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInvoiceDto'
      responses:
        '201':
          description: Invoice created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceResponse'

  /api/v1/invoices/{invoiceId}:
    get:
      tags:
        - Invoices
      summary: Get Invoice Details
      parameters:
        - name: invoiceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Invoice details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'

  /api/v1/invoices/{invoiceId}/send:
    post:
      tags:
        - Invoices
      summary: Send Invoice
      parameters:
        - name: invoiceId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Invoice sent

  /api/v1/invoices/{invoiceId}/mark-paid:
    patch:
      tags:
        - Invoices
      summary: Mark Invoice as Paid
      parameters:
        - name: invoiceId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Invoice marked as paid

  /api/v1/invoices/{invoiceId}/cancel:
    patch:
      tags:
        - Invoices
      summary: Cancel Invoice
      parameters:
        - name: invoiceId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Invoice cancelled

  /api/v1/invoices/user/{userId}:
    get:
      tags:
        - Invoices
      summary: Get User's Invoices
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: User invoices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceListResponse'

  /api/v1/webhooks/stripe:
    post:
      tags:
        - Webhooks
      summary: Stripe Webhook Endpoint
      description: Receive and process Stripe events
      parameters:
        - name: stripe-signature
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean

components:
  schemas:
    CreatePaymentDto:
      type: object
      required:
        - userId
        - amount
        - currency
      properties:
        userId:
          type: string
          format: uuid
        amount:
          type: number
          format: decimal
        currency:
          type: string
          example: USD
        contentId:
          type: string
          description: For one-time purchases
        description:
          type: string
        paymentMethod:
          type: string
          enum: [credit_card, debit_card, bank_transfer, digital_wallet]
        metadata:
          type: object

    PaymentResponse:
      type: object
      properties:
        paymentId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        amount:
          type: number
        currency:
          type: string
        status:
          type: string
          enum: [pending, processing, succeeded, failed, refunded, cancelled]
        stripePaymentId:
          type: string
        createdAt:
          type: string
          format: date-time
        processedAt:
          type: string
          format: date-time

    Payment:
      allOf:
        - $ref: '#/components/schemas/PaymentResponse'

    PaymentIntentResponse:
      type: object
      properties:
        paymentId:
          type: string
          format: uuid
        clientSecret:
          type: string
        amount:
          type: number
        currency:
          type: string

    PaymentHistoryResponse:
      type: object
      properties:
        payments:
          type: array
          items:
            $ref: '#/components/schemas/Payment'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    PaymentRetryResponse:
      type: object
      properties:
        paymentId:
          type: string
        retryCount:
          type: integer
        status:
          type: string

    RefundPaymentDto:
      type: object
      required:
        - paymentId
      properties:
        paymentId:
          type: string
        reason:
          type: string

    CreateSubscriptionDto:
      type: object
      required:
        - userId
        - planId
        - billingCycle
        - stripePaymentMethodId
      properties:
        userId:
          type: string
          format: uuid
        planId:
          type: string
          enum: [premium, plus, basic]
        billingCycle:
          type: string
          enum: [monthly, yearly, quarterly]
        stripePaymentMethodId:
          type: string
        metadata:
          type: object

    SubscriptionResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        planId:
          type: string
        status:
          type: string
          enum: [active, paused, cancelled, pending, expired]
        billingCycle:
          type: string
        amount:
          type: number
        currency:
          type: string
        nextBillingDate:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time

    Subscription:
      allOf:
        - $ref: '#/components/schemas/SubscriptionResponse'

    SubscriptionListResponse:
      type: object
      properties:
        subscriptions:
          type: array
          items:
            $ref: '#/components/schemas/Subscription'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    SubscriptionCancelResponse:
      type: object
      properties:
        id:
          type: string
        status:
          type: string
        cancelledAt:
          type: string
          format: date-time

    UpdateSubscriptionDto:
      type: object
      properties:
        billingCycle:
          type: string
          enum: [monthly, yearly, quarterly]
        planId:
          type: string
          enum: [premium, plus, basic]

    CreateInvoiceDto:
      type: object
      required:
        - userId
        - items
      properties:
        userId:
          type: string
          format: uuid
        subscriptionId:
          type: string
          format: uuid
        description:
          type: string
        items:
          type: array
          items:
            type: object
            properties:
              description:
                type: string
              quantity:
                type: integer
              unitPrice:
                type: number
        dueDate:
          type: string
          format: date-time
        metadata:
          type: object

    InvoiceResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        invoiceNumber:
          type: string
        status:
          type: string
          enum: [draft, issued, paid, overdue, cancelled]
        total:
          type: number
        currency:
          type: string
        dueDate:
          type: string
          format: date-time
        s3Url:
          type: string
        createdAt:
          type: string
          format: date-time

    Invoice:
      allOf:
        - $ref: '#/components/schemas/InvoiceResponse'

    InvoiceListResponse:
      type: object
      properties:
        invoices:
          type: array
          items:
            $ref: '#/components/schemas/Invoice'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer
